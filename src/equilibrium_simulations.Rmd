---
title: "simulation scenarios"
author: "Leonardo Feitosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(patchwork)
library(microbenchmark)
library(beepr)

basedir <- "G:/Meu Drive/PhD Project - Fisheries bycatch/Bycatch project/Chapter 1 - Simulation model/analyses/"
outdir <- file.path(basedir, "model_outs") # calls present data from raster files

```

```{r model function}

run_model <- function(r_s, k_s, q_s, p_s, r_w, k_w, q_w, p_w, c){
  # Weak stock equilibrium points when prices are constants
  N_w_multi <- (k_w * (c * q_w * r_s + k_s * p_s * q_s * (- q_w * r_s + q_s * r_w))) / 
    (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w)
  
  # Effort equilibrium point when prices are constants
  E_multi <- ((- c + k_s * p_s * q_s + k_w * p_w * q_w) * r_s * r_w)  /
   (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
 
  # Strong stock equilibrium points when prices are constants 
  N_s_multi <- (k_s * (c * q_s * r_w + k_w * p_w * q_w * (q_w * r_s - q_s * r_w))) /
     (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
  
  # Single species equilibrium for the weak stock 
  N_w_single <- c / (p_w * q_w)
  
  # Single species equilibrium for the strong stock  
  N_s_single <- c / (p_s * q_s)

  # Single species effort equilibrium for the strong stock  
  E_s_single <- (r_s / q_s * (1 - c / (p_s * q_s * k_s)))
  
  
  
  if(N_w_multi >= 0){
    
    N_w = N_w_multi
  
  } else { 
  
    N_w = 0
  }
  
  if(N_w_multi >= 0){
    
    N_s = N_s_multi
  
  } else {
    
    N_s = N_s_single
  }
  
  if(N_s_multi >= 0){
    
    N_s = N_s_multi
  
  } else {
  
    N_s = 0
  }
  
  if(N_w_multi >= 0){
    
    E = E_multi
  
  } else {
  
    E = E_s_single
  }
  
  # Build output
  output <- data.frame(E = E, N_s = N_s, N_w = N_w)
  
  # Return
  return(output)
 
 
}



```

```{r}
run_model_test <- function(r_s, k_s, q_s1, q_s2, p_s, r_w, k_w, q_w1, q_w2, p_w, c){
  # Weak stock equilibrium points when prices are constants
  N_w_multi <- (c * (- q_s1 + q_s2)) / (p_w * (q_s2 * q_w1 - q_s1 * q_w2))
  
  # Strong stock equilibrium points when prices are constants 
  N_s_multi <- ((c * q_w1) - (c * q_w2)) / (p_s * q_s2 * q_w1 - p_s * q_s1 * q_w2)
  
  # First effort equilibrium point when prices are constants
  E_multi_1 <- (c * k_w * p_w * (q_w1 - q_w2) * q_w2 * r_s + c * k_s * p_s * (q_s1 - q_s2) * q_s2 * r_w + k_s * k_w * p_s * p_w * (q_s2 * q_w1 - q_s1 * q_w2) * (-q_w2 * r_s + q_s2 * r_w)) / (k_s * k_w * p_s * p_w * (q_s2 * q_w1 - q_s1 * q_w2)^2)
    
  # Second effort equilibrium point when prices are constants
  E_multi_2 <- ((c * k_w * p_w * q_w1 * (-q_w1 + q_w2) * r_s + c * k_s * p_s * q_s1 * (-q_s1 + q_s2) * r_w + k_s * k_w * p_s * p_w * (q_s2 * q_w1 - q_s1 * q_w2) * (q_w1 * r_s - q_s1 * r_w))) / (k_s * k_w * p_s * p_w * (q_s2 * q_w1 - q_s1 * q_w2)^2)
      
  # Single species equilibrium for the weak stock 
  N_w_single <- c / (p_w * q_w1)
  
  # Single species equilibrium for the strong stock  
  N_s_single <- c / (p_s * q_s1)

  # Single species effort equilibrium for the first strong stock catchability 
  E_s_single <- (r_s / q_s1 * (1 - c / (p_s * q_s1 * k_s)))
  
  # Single species effort equilibrium for the first strong stock catchability 
  E_w_single <- (r_w / q_w1 * (1 - c / (p_w * q_w1 * k_w)))

  
  
   if(N_w_multi >= 0){
     
     N_w = N_w_multi
   
   } else { 
   
     N_w = 0
   }
   
   if(N_w_multi >= 0){
     
     N_s = N_s_multi
   
   } else {
     
     N_s = N_s_single
   }
   
   if(N_s_multi >= 0){
     
     N_s = N_s_multi
   
   } else {
   
     N_s = 0
   }
   
   if(N_w_multi >= 0){
     
     E1 = E_multi_1
   
   } else {
   
     E1 = E_s_single
   }
   
   
   if(N_w_multi >= 0){
     
     E2 = E_multi_2
   
   } else {
   
     E2 = E_s_single
   }
  
    if(N_s_multi >= 0){
      
      E1 = E_multi_1
    } else {
    
      E1 = E_w_single
    }
  
  
    if(N_s_multi >= 0){
      
      E2 = E_multi_2
    } else {
    
      E2 = E_w_single
  }
     
  #Build output
  output <- data.frame(E1 = E1, E2 = E2, N_s = N_s, N_w = N_w)
  
  # Return
  return(output)
 
 
}

```


```{r scenario range for 1st plot for the paper}
################### USED THIS CODE TO BUILD THE PARAMETER SET OF FIGURE 1A ################################################

# In this code chunk, I'll generate the dataset to simulate a scenario where the weak stock has zero value and the strong and weak stocks growth rates vary in different ratios.

# Building df of price range scenarios
scenarios_df <- expand.grid(p_s = seq(1, 10, 0.1),
                            p_w = c(0, 1),
                            r_s = 1,
                            r_w = seq(0.01, 0.99, 0.01),
                            q_s1 = 0.02,
                            q_s2 = 0.01,
                            q_w1 = 0.01,
                            q_w2 = 0.02,
                            k_s = 4,
                            k_w = 2,
                            c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) 

# vectorized version
output_1 <- scenarios_df %>%
  rowwise() %>% 
  mutate(output = list(run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                                 q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, 
                                 c = c))) %>% 
  unnest(output) %>% 
  select(-c(r_s:r_w, k_s:k_w, q_s:q_w, p_s:p_w, c)) %>% 
  as.data.frame()


output_join_test  <- output_1 %>% 
 left_join(scenarios_df, by = "scenario_id") %>% 
 relocate(scenario_id, .before = E) 

write_csv(output_join_test, file = file.path(outdir, "output_s_ranges_w_one.csv"), col_names = T)
```

```{r}
output_join_test %>% 
  ggplot() +
  geom_histogram(aes(x = N_w, fill = factor(p_w)))
```


```{r}
################### USED THIS CODE TO BUILD THE PARAMETER SET OF FIGURE 1B ################################################

# In this code chunk, I'll generate the dataset to simulate a scenario where the weak stock value ranges and the strong stock value is small and doubled. .

scenarios_df2 <- expand.grid(p_s = seq(1, 2, 1),
                             p_w = seq(1, 10, 0.1),
                             r_s = 1,
                             r_w = seq(0.01, 0.99, 0.01),
                             q_s = 0.02,
                             q_w = 0.02,
                             k_s = 4, 
                             k_w = 2,
                             c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) %>% 
  filter(r_s > r_w)

output_2 <- scenarios_df2 %>% 
  rowwise() %>% 
  mutate(output = list(run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                      q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, 
                      c = c))) %>% 
  unnest(output) %>% 
  select(-c(r_s:r_w, k_s:k_w, q_s:q_w, p_s:p_w, c)) %>% 
  as.data.frame()

output_join_test2 <- output_2 %>% 
   left_join(scenarios_df2, by = "scenario_id") %>% 
   relocate(scenario_id, .before = E)
 
write_csv(output_join_test2, file = file.path(outdir, "output_w_ranges_s_one.csv"), col_names = T)
```

```{r}
output_join_test %>% 
  ggplot() +
  geom_histogram(aes(x = vuln_ratio_s))
```


```{r output wrangling}
################### USED THIS CODE TO BUILD THE PARAMETER SET OF FIGURE 3A ################################################

# In this code chunk, I'll generate the dataset to simulate a scenario where a fishery subsidy decreases costs in several levels.

scenarios_df_subs1 <- expand.grid(p_s = seq(1, 10, 0.1),
                                  p_w = c(0, 1),
                                  r_s = 1,
                                  r_w = seq(0.01, 0.99, 0.01),
                                  q_s = 0.02,
                                  q_w = 0.02,
                                  k_s = 4,
                                  k_w = 2,
                                  c = 0.0375) %>% 
  mutate(scenario_id = 1:nrow(.)) 

output_sub_1 <- scenarios_df_subs1 %>% 
  rowwise() %>% 
  mutate(output = list(run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                                 q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, 
                                 c = c))) %>% 
  unnest(output) %>% 
  select(-c(r_s:r_w, k_s:k_w, q_s:q_w, p_s:p_w, c)) %>% 
  as.data.frame()


output_sub1_final <- output_sub_1 %>% 
 left_join(scenarios_df_subs1, by = "scenario_id") %>% 
 relocate(scenario_id, .before = E)

write_csv(output_sub1_final, file = file.path(outdir, "output_sub1.csv"), col_names = T)
```


```{r}
################### USED THIS CODE TO BUILD THE PARAMETER SET OF FIGURE 3B ################################################

# In this code chunk, I'll generate the dataset to simulate a scenario where a fishery subsidy increases the catchability of the strong stock in several levels.

scenarios_df_subs2 <- expand.grid(p_w = seq(1, 10, 0.1),
                                  p_s = c(1, 2),
                                  r_s = 1,
                                  r_w = seq(0.01, 0.99, 0.01),
                                  q_s = 0.02,
                                  q_w = 0.02,
                                  k_s = 4,
                                  k_w = 2,
                                  c = 0.0375) %>% 
  mutate(scenario_id = 1:nrow(.)) 

output_sub_2 <- scenarios_df_subs2 %>% 
  rowwise() %>% 
  mutate(output = list(run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                                 q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, 
                                 c = c))) %>% 
  unnest(output) %>% 
  select(-c(r_s:r_w, k_s:k_w, q_s:q_w, p_s:p_w, c)) %>% 
  as.data.frame()

output_sub2_final <- output_sub_2 %>% 
   left_join(scenarios_df_subs2, by = "scenario_id") %>% 
   relocate(scenario_id, .before = E)
 

write_csv(output_sub2_final, file = file.path(outdir, "output_sub2.csv"), col_names = T)
```

```{r}
output_price_range %>%
  pivot_wider(names_from = "stock_prices",
              values_from = "prices") %>% 
  filter(variables %in% c("N_w", "N_s")) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables,
            scales = "free_y") +
  scale_fill_gradientn(name = "Stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(breaks = seq(0, 10, 1)) +
  labs(x = "Weak stock price range",
       y = "Strong stock price range",
       title = "Simulation of price ranges on variable size") +
  theme_bw() 
```



```{r}
# Building df of price range scenarios
scenarios_test_df <- expand.grid(p_s = seq(1, 10, 0.1),
                            p_w = c(0, 1),
                            r_s = 1,
                            r_w = seq(0.01, 0.99, 0.01),
                            q_s1 = 0.02,
                            q_w1 = 0.01,
                            q_s2 = 0.01,
                            q_w2 = 0.02,
                            k_s = 4,
                            k_w = 2,
                            c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) 

# vectorized version
output_1 <- scenarios_test_df %>%
  rowwise() %>% 
  mutate(output = list(run_model_test(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                                      q_s1 = q_s1, q_w1 = q_w1, q_s2 = q_s2, q_w2 = q_w2, 
                                      p_s = p_s, p_w = p_w, c = c))) %>% 
  unnest(output) %>% 
  select(-c(r_s:r_w, k_s:k_w, q_s1:q_w1, q_s2:q_w2, p_s:p_w, c)) %>% 
  as.data.frame()


output_join_test  <- output_1 %>% 
 left_join(scenarios_df, by = "scenario_id") 
 relocate(scenario_id, .before = E) 

```

