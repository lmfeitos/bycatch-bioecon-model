---
title: "simulation scenarios"
author: "Leonardo Feitosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(patchwork)
library(beepr)

basedir <- "G:/Meu Drive/PhD Project - Fisheries bycatch/Bycatch project/Chapter 1/analyses/"
outdir <- file.path(basedir, "model_outs") # calls present data from raster files

```

```{r model function}

run_model <- function(r_s, k_s, q_s, p_s, r_w, k_w, q_w, p_w, c){
  # Weak stock equilibrium points when prices are constants
  N_w_multi <- (k_w * (c * q_w * r_s + k_s * p_s * q_s * (- q_w * r_s + q_s * r_w))) / 
    (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w)
  
  # Effort equilibrium point when prices are constants
  E_multi <- ((- c + k_s * p_s * q_s + k_w * p_w * q_w) * r_s * r_w)  /
   (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
 
  # Strong stock equilibrium points when prices are constants 
  N_s_multi <- (k_s * (c * q_s * r_w + k_w * p_w * q_w * (q_w * r_s - q_s * r_w))) /
     (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
  
  # Single species equilibrium for the weak stock 
  N_w_single <- c / (p_w * q_w)
  
  # Single species equilibrium for the strong stock  
  N_s_single <- c / (p_s * q_s)

  # Single species effort equilibrium for the strong stock  
  E_s_single <- (r_s / q_s * (1 - c / (p_s * q_s * k_s)))
  
  
  
  if(N_w_multi >= 0){
    
    N_w = N_w_multi
  
  } else { 
  
    N_w = 0
  }
  
  if(N_w_multi >= 0){
    
    N_s = N_s_multi
  
  } else {
    
    N_s = N_s_single
  }
  
  if(N_s_multi >= 0){
    
    N_s = N_s_multi
  
  } else {
  
    N_s = 0
  }
  
  if(N_w_multi >= 0){
    
    E = E_multi
  
  } else {
  
    E = E_s_single
  }
  
  # Build output
  output <- data.frame(E = E, N_s = N_s, N_w = N_w)
  
  # Return
  return(output)
 
 
}


run_model_pw_fcn <- function(r_s, k_s, q_s, p_s, r_w, k_w, q_w, p_w, c, f_w, beta_w, A_w){
  
  # Weak stock equilibrium points when prices are constants
  N_w_multi <- (k_w * (c * q_w * r_s + k_s * p_s * q_s * (- q_w * r_s + q_s * r_w))) / 
    (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w)
  
  # Effort equilibrium point when prices are constants
  E_multi <- ((- c + k_s * p_s * q_s + k_w * p_w * q_w) * r_s * r_w)  /
   (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
 
  # Strong stock equilibrium points when prices are constants 
  N_s_multi <- (k_s * (c * q_s * r_w + k_w * p_w * q_w * (q_w * r_s - q_s * r_w))) /
     (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
  
  # Single species equilibrium for the weak stock 
  #N_w_single <- c / p_w * q_w
  
  # Single species equilibrium for the strong stock  
  N_s_single <- c / (p_s * q_s)

  # Single species effort equilibrium for the strong stock  
  E_single <- (r_s / q_s * (1 - c / (p_s * q_s * k_s)))
  
  if(N_w_multi >= 0){
    
    N_w = N_w_multi
  } else { 
    N_w = 0
  }
  
  if(N_w_multi >= 0){
    N_s = N_s_multi
  } else {
    N_s = N_s_single
  }
  
  if(N_s_multi >= 0){
    N_s = N_s_multi
  } else {
    N_s = 0
  }
  
  if(N_w_multi >= 0){
    E = E_multi
  } else {
    E = E_single
  }
  
  # Weak stock catch function
  Q_w <- q_w * N_w^beta_w * E
  
    # Weak stock price function
  P_w <- (A_w * Q_w)^-f_w
  
  # Weak stock equilibrium point when weak stock price is a function of catch
  N_w_multi2 <- (k_w * (c * q_w * r_s + k_s * p_s * q_s * (- q_w * r_s + q_s * r_w))) / 
    (k_w * P_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w)
  
  # Effort equilibrium point when weak stock price is a function of catch
  E_multi2 <- ((- c + k_s * p_s * q_s + k_w * P_w * q_w) * r_s * r_w)  /
   (k_w * P_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
 
  # Strong stock equilibrium point when weak stock price is a function of catch
  N_s_multi2 <- (k_s * (c * q_s * r_w + k_w * P_w * q_w * (q_w * r_s - q_s * r_w))) /
     (k_w * P_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
  

  if(N_w_multi2 >= 0){
    
    N_w2 = N_w_multi2
  } else { 
    N_w2 = 0
  }
  
  if(N_w_multi2 >= 0){
    N_s2 = N_s_multi2
  } else {
    N_s2 = N_s_single
  }
  if(isTRUE(N_s_multi2 >= 0) == TRUE){
    N_s2 = N_s_multi2
  } else {
    N_s2 = 0
  }
  if(N_w_multi2 >= 0){
    E2 = E_multi2
  } else {
    E2 = E_single
  }
  
  

  output <- data.frame(N_s = N_s, N_w = N_w, E = E, N_w2 = N_w2, N_s2 = N_s2, E2 = E2)

 
  
  # Return
  return(output)
 
}



run_model_msy <- function(r_s, k_s, q_s, p_s, r_w, k_w, q_w, p_w, c){
  # Weak stock equilibrium points when prices are constants
  N_w_multi <- (k_w * (c * q_w * r_s + k_s * p_s * q_s * (- q_w * r_s + q_s * r_w))) / 
    (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w)
  
  # Effort equilibrium point when prices are constants
  E_multi <- ((- c + k_s * p_s * q_s + k_w * p_w * q_w) * r_s * r_w)  /
   (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
 
  # Strong stock equilibrium points when prices are constants 
  N_s_multi <- (k_s * (c * q_s * r_w + k_w * p_w * q_w * (q_w * r_s - q_s * r_w))) /
     (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
  
  # Single species equilibrium for the strong stock  
  N_s_single <- c / (p_s * q_s)

  # Single species effort equilibrium for the strong stock  
  E_s_single <- (r_s / q_s * (1 - c / (p_s * q_s * k_s)))
  
  
  
  if(N_w_multi >= 0){
    
    N_w = N_w_multi
  
  } else { 
  
    N_w = 0
  }
  
  if(N_w_multi >= 0){
    
    N_s = N_s_multi
  
  } else {
    
    N_s = N_s_single
  }
  
  if(N_w_multi >= 0){
    
    E = E_multi
  
  } else {
  
    E = E_s_single
  }
  
  if(E_s_multi < r_s/(2*q_s)){
    
    E = E_s_multi
  
  } else {
    
    E = r_s/ (2 * q_s)
 }
  
  # Build output
  output <- data.frame(E = E, N_s = N_s, N_w = N_w)
  
  # Return
  return(output)
 
}

# Scenario where the fishery has cost reducing a subsidy
run_model_sub <- function(r_s, k_s, q_s, p_s, r_w, k_w, q_w, p_w, c){
  # Weak stock equilibrium points when prices are constants
  N_w_multi <- (k_w * (c * q_w * r_s + k_s * p_s * q_s * (- q_w * r_s + q_s * r_w))) / 
    (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w)
  
  # Effort equilibrium point when prices are constants
  E_multi <- ((- c + k_s * p_s * q_s + k_w * p_w * q_w) * r_s * r_w)  /
   (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
 
  # Strong stock equilibrium points when prices are constants 
  N_s_multi <- (k_s * (c * q_s * r_w + k_w * p_w * q_w * (q_w * r_s - q_s * r_w))) /
     (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
  
  # Single species equilibrium for the strong stock  
  N_s_single <- c / (p_s * q_s)

  # Single species effort equilibrium for the strong stock  
  E_s_single <- (r_s / q_s * (1 - c / (p_s * q_s * k_s)))
  
  
  
  if(N_w_multi >= 0){
    
    N_w = N_w_multi
  
  } else { 
  
    N_w = 0
  }
  
  if(N_w_multi >= 0){
    
    N_s = N_s_multi
  
  } else {
    
    N_s = N_s_single
  }
  
  if(N_s_multi >= 0){
    
    N_s = N_s_multi
  
  } else {
  
    N_s = 0
  }
  
  if(N_w_multi >= 0){
    
    E = E_multi
  
  } else {
  
    E = E_s_single
  }
  
  if(E_multi <= 0){
    E = 0
  }
  
  if(E_s_single <= 0){ 
    E = 0
  }
  # Build output
  output <- data.frame(E = E, N_s = N_s, N_w = N_w)
  
  # Return
  return(output)
 
 
}

# Include a tax to the fishery if an individual of the weak stock is caught (WORK ON THIS)
run_model_msy_tax <- function(r_s, k_s, q_s, p_s, r_w, k_w, q_w, p_w, c){
  # Weak stock equilibrium points when prices are constants
  N_w_multi <- (k_w * (c * q_w * r_s + k_s * p_s * q_s * (- q_w * r_s + q_s * r_w))) / 
    (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w)
  
  # Effort equilibrium point when prices are constants
  E_multi <- ((- c + k_s * p_s * q_s + k_w * p_w * q_w) * r_s * r_w)  /
   (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
 
  # Strong stock equilibrium points when prices are constants 
  N_s_multi <- (k_s * (c * q_s * r_w + k_w * p_w * q_w * (q_w * r_s - q_s * r_w))) /
     (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
  
  # Single species equilibrium for the strong stock  
  N_s_single <- c / (p_s * q_s)

  # Single species effort equilibrium for the strong stock  
  E_s_single <- (r_s / q_s * (1 - c / (p_s * q_s * k_s)))
  
  
  
  if(N_w_multi >= 0){
    
    N_w = N_w_multi
  
  } else { 
  
    N_w = 0
  }
  
  if(N_w_multi >= 0){
    
    N_s = N_s_multi
  
  } else {
    
    N_s = N_s_single
  }
  
  if(N_s_multi >= 0){
    
    N_s = N_s_multi
  
  } else {
  
    N_s = 0
  }
  
  if(N_w_multi >= 0){
    
    E = E_multi
  
  } else {
  
    E = E_s_single
  }
  
  if(N_s_multi >= k_s/2){
    E = E_multi
  } else {
    E = 0
  }
  
  # Build output
  output <- data.frame(E = E, N_s = N_s, N_w = N_w)
  
  # Return
  return(output)
 
}
```


```{r scenario range for 1st plot for the paper}
################### USED THIS CODE TO BUILD THE PARAMETER SET OF FIGURE 1A ################################################

# In this code chunk, I'll generate the dataset to simulate a scenario where the weak stock has zero value and the strong and weak stocks growth rates vary in different ratios.

# Building df of price range scenarios
scenarios_df <- expand.grid(p_s = seq(1, 10, 0.5),
                            p_w = c(0, 1),
                            r_s = seq(0.1, 1, 0.01),
                            r_w = seq(0.1, 0.9, 0.01),
                            q_s = 0.02,
                            q_w = 0.02,
                            k_s = 4,
                            k_w = 2,
                            c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) %>% 
  filter(r_s > r_w)

# test scenario
r_s <- scenarios_df$r_s[1]
k_s <- scenarios_df$k_s[1]
q_s <- scenarios_df$q_s[1]
p_s <- scenarios_df$p_s[1]
r_w <- scenarios_df$r_w[1]
k_w <- scenarios_df$k_w[1]
q_w <- scenarios_df$q_w[1]
p_w <- scenarios_df$p_w[1]
c <- scenarios_df$c[1]


i = 1

# test with purrr
# scenarios_df_out <- scenarios_df %>% 
#  pmap_dfr(~ run_model(scenarios_df$r_s, scenarios_df$r_w,
#                   scenarios_df$k_s, scenarios_df$k_w,
#                   scenarios_df$q_s, scenarios_df$q_w,
#                   scenarios_df$p_s, scenarios_df$p_w,
#                   scenarios_df$c)) 

for(i in 1:nrow(scenarios_df)){
 
  # Extract params
  r_s <- scenarios_df$r_s[i]
  r_w <- scenarios_df$r_w[i]
  k_s <- scenarios_df$k_s[i]
  k_w <- scenarios_df$k_w[i]
  q_s <- scenarios_df$q_s[i]
  q_w <- scenarios_df$q_w[i]
  p_s <- scenarios_df$p_s[i]
  p_w <- scenarios_df$p_w[i]
  c <- scenarios_df$c[i]
  sc_id <- scenarios_df$scenario_id[i]
 
  # Run model
  output <- run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                      q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, 
                      c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_1 <- output
  }
  else{
    output_1 <- rbind(output_1, output)
  }

}

output_join_test  <- output_1 %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(scenarios_df, by = "scenario_id") %>% 
  relocate(scenario_id, .before = E) 

# output_p_tidy <- output_join_test %>% 
#   mutate(price_ratio = p_s / p_w) %>% 
#   pivot_longer(cols = E:N_w,
#                names_to = "eq_p_const",
#                values_to = "eq_p_const_val") %>% 
#   pivot_longer(cols = ends_with("_1"),
#                names_to = "eq_pw_fcn_c",
#                values_to = "eq_pw_fcn_c_val") %>% 
#   pivot_longer(cols = ends_with("_2"),
#                names_to = "eq_ps_fcn_c",
#                values_to = "eq_ps_fcn_c_val") %>% 
#   pivot_longer(cols = ends_with("_3"),
#                names_to = "eq_pw_ps_fcn_c",
#                values_to = "eq_pw_ps_fcn_c_val") %>% 
#   distinct_all()
  
# output_price_range <- output_p_tidy %>% 
#   select(scenario_id, variables, values, stock_prices, prices, price_ratio) %>% 
#   distinct(variables, values, stock_prices, prices, price_ratio, .keep_all = TRUE)

write_csv(output_join_test, file = file.path(outdir, "output_s_ranges_w_one.csv"), col_names = T)

beep()
```

```{r}
output_join_test %>% 
  ggplot() +
  geom_histogram(aes(x = N_w, fill = factor(p_w)))
```


```{r}
################### USED THIS CODE TO BUILD THE PARAMETER SET OF FIGURE 1B ################################################

# In this code chunk, I'll generate the dataset to simulate a scenario where the weak stock value ranges and the strong stock value is small and doubled. .

scenarios_df2 <- expand.grid(p_s = seq(1, 2, 1),
                             p_w = seq(1, 10, 0.5),
                             r_s = seq(0.1, 1, 0.01),
                             r_w = seq(0.1, 0.9, 0.01),
                             q_s = 0.02,
                             q_w = 0.02,
                             k_s = 4, 
                             k_w = 2,
                             c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) %>% 
  filter(r_s > r_w)

# test scenario
r_s <- scenarios_df2$r_s[1]
k_s <- scenarios_df2$k_s[1]
q_s <- scenarios_df2$q_s[1]
p_s <- scenarios_df2$p_s[1]
r_w <- scenarios_df2$r_w[1]
k_w <- scenarios_df2$k_w[1]
q_w <- scenarios_df2$q_w[1]
p_w <- scenarios_df2$p_w[1]
c <- scenarios_df2$c[1]


i = 1

# test with purrr
# scenarios_df_out <- scenarios_df %>% 
#  pmap_dfr(~ run_model(scenarios_df$r_s, scenarios_df$r_w,
#                   scenarios_df$k_s, scenarios_df$k_w,
#                   scenarios_df$q_s, scenarios_df$q_w,
#                   scenarios_df$p_s, scenarios_df$p_w,
#                   scenarios_df$c)) 

for(i in 1:nrow(scenarios_df2)){
 
  # Extract params
  r_s <- scenarios_df2$r_s[i]
  r_w <- scenarios_df2$r_w[i]
  k_s <- scenarios_df2$k_s[i]
  k_w <- scenarios_df2$k_w[i]
  q_s <- scenarios_df2$q_s[i]
  q_w <- scenarios_df2$q_w[i]
  p_s <- scenarios_df2$p_s[i]
  p_w <- scenarios_df2$p_w[i]
  c <- scenarios_df2$c[i]
  sc_id <- scenarios_df2$scenario_id[i]
 
  # Run model
  output2 <- run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                      q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, 
                      c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_2 <- output2
  }
  else{
    output_2 <- rbind(output_2, output2)
  }

}

output_join_test2 <- output_2 %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(scenarios_df2, by = "scenario_id") %>% 
  relocate(scenario_id, .before = E)

write_csv(output_join_test2, file = file.path(outdir, "output_w_ranges_s_one.csv"), col_names = T)

beep()
```

```{r}
output_join_test %>% 
  ggplot() +
  geom_histogram(aes(x = vuln_ratio_s))
```

```{r test weak stock biomass with strong stock management for MSY}
################### USED THIS CODE TO BUILD THE PARAMETER SET OF FIGURE 2A ################################################

# In this code chunk, I'll generate the dataset to simulate a scenario where the strong stock value ranges and the weak stock value (1) doesn't exist and (2) is very small under MSY management for the strong stock.

# Building df of price range scenarios
scenarios_df_msy1 <- expand.grid(p_s = seq(1, 10, 0.5),
                                 p_w = c(0, 1),
                                 r_s = seq(0.1, 1, 0.01),
                                 r_w = seq(0.1, 0.9, 0.01),
                                 q_s = 0.02,
                                 q_w = 0.02,
                                 k_s = 4,
                                 k_w = 2,
                                 c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) %>% 
  filter(r_s > r_w)

# test scenario
r_s <- scenarios_df_msy1$r_s[1]
k_s <- scenarios_df_msy1$k_s[1]
q_s <- scenarios_df_msy1$q_s[1]
p_s <- scenarios_df_msy1$p_s[1]
r_w <- scenarios_df_msy1$r_w[1]
k_w <- scenarios_df_msy1$k_w[1]
q_w <- scenarios_df_msy1$q_w[1]
p_w <- scenarios_df_msy1$p_w[1]
f_w <- scenarios_df_msy1$f_w[1]
c <- scenarios_df_msy1$c[1]

i = 1

# test with purrr
#scenarios_df %>% 
#  pmap(~ run_model_msy(scenarios_df$r_s, scenarios_df$r_w,
#                       scenarios_df$k_s, scenarios_df$k_w,
#                       scenarios_df$q_s, scenarios_df$q_w,
#                       scenarios_df$p_s, scenarios_df$p_w,
#                       scenarios_df$c)) %>% 
#    mutate(sc_id = sc_id)

for(i in 1:nrow(scenarios_df_msy1)){
 
  # Extract params
  r_s <- scenarios_df_msy1$r_s[i]
  k_s <- scenarios_df_msy1$k_s[i]
  q_s <- scenarios_df_msy1$q_s[i]
  p_s <- scenarios_df_msy1$p_s[i]
  r_w <- scenarios_df_msy1$r_w[i]
  k_w <- scenarios_df_msy1$k_w[i]
  q_w <- scenarios_df_msy1$q_w[i]
  p_w <- scenarios_df_msy1$p_w[i]
  f_w <- scenarios_df_msy1$f_w[i]
  c <- scenarios_df_msy1$c[i]
  sc_id <- scenarios_df_msy1$scenario_id[i]
 
  # Run model
  output_s_msy <- run_model_msy(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                                q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_s <- output_s_msy
  }
  else{
    output_s <- rbind(output_s, output_s_msy)
  }

}

output_join_test_msy1 <- output_s %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(scenarios_df_msy1, by = "scenario_id") %>% 
  relocate(scenario_id, .before = E) %>% 
  mutate(vuln_ratio_w = (q_w/r_w) / (q_s/r_s)) %>% 
  mutate(vuln_ratio_s = (q_s/r_s) / (q_w/r_w))

write_csv(output_join_test_msy1, file = file.path(outdir, "output_msy1.csv"), col_names = T)
```

```{r test weak stock biomass with strong stock management for MSY}
################### USED THIS CODE TO BUILD THE PARAMETER SET OF FIGURE 2B ################################################

# In this code chunk, I'll generate the dataset to simulate a scenario where the weak stock value ranges and the strong stock value is small and doubled under MSY management for the strong stock.

# Building df of price range scenarios
scenarios_df_msy2 <- expand.grid(p_s = seq(1, 2, 1),
                                 p_w = seq(1, 10, 0.5),
                                 r_s = seq(0.1, 1, 0.01),
                                 r_w = seq(0.1, 0.9, 0.01),
                                 q_s = 0.02,
                                 q_w = 0.02,
                                 k_s = 4, 
                                 k_w = 2,
                                 c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) %>% 
  filter(r_s > r_w)

# test scenario
r_s <- scenarios_df_msy2$r_s[1]
k_s <- scenarios_df_msy2$k_s[1]
q_s <- scenarios_df_msy2$q_s[1]
p_s <- scenarios_df_msy2$p_s[1]
r_w <- scenarios_df_msy2$r_w[1]
k_w <- scenarios_df_msy2$k_w[1]
q_w <- scenarios_df_msy2$q_w[1]
p_w <- scenarios_df_msy2$p_w[1]
f_w <- scenarios_df_msy2$f_w[1]
c <- scenarios_df_msy2$c[1]

i = 1

# test with purrr
#scenarios_df %>% 
#  pmap(~ run_model_msy(scenarios_df$r_s, scenarios_df$r_w,
#                       scenarios_df$k_s, scenarios_df$k_w,
#                       scenarios_df$q_s, scenarios_df$q_w,
#                       scenarios_df$p_s, scenarios_df$p_w,
#                       scenarios_df$c)) %>% 
#    mutate(sc_id = sc_id)

for(i in 1:nrow(scenarios_df_msy2)){
 
  # Extract params
  r_s <- scenarios_df_msy2$r_s[i]
  k_s <- scenarios_df_msy2$k_s[i]
  q_s <- scenarios_df_msy2$q_s[i]
  p_s <- scenarios_df_msy2$p_s[i]
  r_w <- scenarios_df_msy2$r_w[i]
  k_w <- scenarios_df_msy2$k_w[i]
  q_w <- scenarios_df_msy2$q_w[i]
  p_w <- scenarios_df_msy2$p_w[i]
  f_w <- scenarios_df_msy2$f_w[i]
  c <- scenarios_df_msy2$c[i]
  sc_id <- scenarios_df_msy2$scenario_id[i]
 
  # Run model
  output_w_msy <- run_model_msy(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                                q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w,
                                c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_w <- output_w_msy
  }
  else{
    output_w <- rbind(output_w, output_w_msy)
  }

}

output_join_msy_w <- output_w %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(scenarios_df_msy2, by = "scenario_id") %>% 
  relocate(scenario_id, .before = E) %>% 
  mutate(vuln_ratio_w = (q_w/r_w) / (q_s/r_s)) %>% 
  mutate(vuln_ratio_s = (q_s/r_s) / (q_w/r_w))

#write_csv(output_join_msy_w, file = file.path(outdir, "output_msy2.csv"), col_names = T)
```

```{r}
output_join_test_w %>% 
  pivot_longer(cols = N_w2:E2,
               names_to = "variables_2",
               values_to = "values_2") %>% 
  ggplot() +
  geom_histogram(aes(x = values_2)) +
  facet_wrap(~ variables_2,
             scales = "free_x")
```


```{r output wrangling}
################### USED THIS CODE TO BUILD THE PARAMETER SET OF FIGURE 3A ################################################

# In this code chunk, I'll generate the dataset to simulate a scenario where a fishery subsidy decreases costs in several levels.

scenarios_df_subs1 <- expand.grid(p_s = seq(1, 10, 0.5),
                                  p_w = c(0, 1),
                                  r_s = seq(0.1, 1, 0.01),
                                  r_w = seq(0.1, 0.9, 0.01),
                                  q_s = 0.02,
                                  q_w = 0.02,
                                  k_s = 4,
                                  k_w = 2,
                                  c = seq(0.005, 0.05, 0.01)) %>% 
  mutate(scenario_id = 1:nrow(.)) %>% 
  filter(r_s > r_w)

# test scenario
r_s <- scenarios_df_subs1$r_s[1]
k_s <- scenarios_df_subs1$k_s[1]
q_s <- scenarios_df_subs1$q_s[1]
p_s <- scenarios_df_subs1$p_s[1]
r_w <- scenarios_df_subs1$r_w[1]
k_w <- scenarios_df_subs1$k_w[1]
q_w <- scenarios_df_subs1$q_w[1]
p_w <- scenarios_df_subs1$p_w[1]
c <- scenarios_df_subs1$c[1]

i = 1

# test with purrr
#scenarios_df %>% 
#  pmap(~ run_model(scenarios_df$r_s, scenarios_df$r_w,
#                   scenarios_df$k_s, scenarios_df$k_w,
#                   scenarios_df$q_s, scenarios_df$q_w,
#                   scenarios_df$p_s, scenarios_df$p_w,
#                   scenarios_df$c)) %>% 
#    mutate(sc_id = sc_id)

for(i in 1:nrow(scenarios_df_subs1)){
 
  # Extract params
  r_s <- scenarios_df_subs1$r_s[i]
  r_w <- scenarios_df_subs1$r_w[i]
  k_s <- scenarios_df_subs1$k_s[i]
  k_w <- scenarios_df_subs1$k_w[i]
  q_s <- scenarios_df_subs1$q_s[i]
  q_w <- scenarios_df_subs1$q_w[i]
  p_s <- scenarios_df_subs1$p_s[i]
  p_w <- scenarios_df_subs1$p_w[i]
  c <- scenarios_df_subs1$c[i]
  sc_id <- scenarios_df_subs1$scenario_id[i]
 
  # Run model
  output_subs1 <- run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                            q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_sub1 <- output_subs1
  }
  else{
    output_sub1 <- rbind(output_sub1, output_subs1)
  }

}

output_join <- output_sub1 %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(scenarios_df_subs1, by = "scenario_id") %>% 
  relocate(scenario_id, .before = E)

write_csv(output_join, file = file.path(outdir, "output_sub1.csv"), col_names = T)

```


```{r}
################### USED THIS CODE TO BUILD THE PARAMETER SET OF FIGURE 3B ################################################

# In this code chunk, I'll generate the dataset to simulate a scenario where a fishery subsidy increases the catchability of the strong stock in several levels.

scenarios_df_subs2 <- expand.grid(p_s = seq(1, 2, 1),
                                  p_w = seq(1, 10, 0.5),
                                  r_s = seq(0.1, 1, 0.01),
                                  r_w = seq(0.1, 0.9, 0.01),
                                  q_s = 0.02,
                                  q_w = 0.02,
                                  k_s = 4, 
                                  k_w = 2,
                                  c = seq(0.005, 0.05, 0.01)) %>% 
  mutate(scenario_id = 1:nrow(.)) %>% 
  filter(r_s > r_w) 

# test scenario
r_s <- scenarios_df_subs2$r_s[1]
k_s <- scenarios_df_subs2$k_s[1]
q_s <- scenarios_df_subs2$q_s[1]
p_s <- scenarios_df_subs2$p_s[1]
r_w <- scenarios_df_subs2$r_w[1]
k_w <- scenarios_df_subs2$k_w[1]
q_w <- scenarios_df_subs2$q_w[1]
p_w <- scenarios_df_subs2$p_w[1]
c <- scenarios_df_subs2$c[1]

i = 1

# test with purrr
#scenarios_df %>% 
#  pmap(~ run_model(scenarios_df$r_s, scenarios_df$r_w,
#                   scenarios_df$k_s, scenarios_df$k_w,
#                   scenarios_df$q_s, scenarios_df$q_w,
#                   scenarios_df$p_s, scenarios_df$p_w,
#                   scenarios_df$c)) %>% 
#    mutate(sc_id = sc_id)

for(i in 1:nrow(scenarios_df_subs2)){
 
  # Extract params
  r_s <- scenarios_df_subs2$r_s[i]
  r_w <- scenarios_df_subs2$r_w[i]
  k_s <- scenarios_df_subs2$k_s[i]
  k_w <- scenarios_df_subs2$k_w[i]
  q_s <- scenarios_df_subs2$q_s[i]
  q_w <- scenarios_df_subs2$q_w[i]
  p_s <- scenarios_df_subs2$p_s[i]
  p_w <- scenarios_df_subs2$p_w[i]
  c <- scenarios_df_subs2$c[i]
  sc_id <- scenarios_df_subs2$scenario_id[i]
 
  # Run model
  output_subs2 <- run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                      q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_sub2 <- output_subs2
  }
  else{
    output_sub2 <- rbind(output_sub2, output_subs2)
  }

}

output_join <- output_sub2 %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(scenarios_df_subs2, by = "scenario_id") %>% 
  relocate(scenario_id, .before = E)

write_csv(output_join, file = file.path(outdir, "output_sub2.csv"), col_names = T)
```

```{r}
output_price_range %>%
  pivot_wider(names_from = "stock_prices",
              values_from = "prices") %>% 
  filter(variables %in% c("N_w", "N_s")) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables,
            scales = "free_y") +
  scale_fill_gradientn(name = "Stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(breaks = seq(0, 10, 1)) +
  labs(x = "Weak stock price range",
       y = "Strong stock price range",
       title = "Simulation of price ranges on variable size") +
  theme_bw() 
```


```{r}
# Building df of scenarios
q_scenarios_df <- expand.grid(p_s = 1,
                            p_w = 1,
                            r_s = seq(0.1, 1, 0.01),
                            r_w = seq(0.1, 0.99, 0.01),
                            q_s = seq(0.01, 0.1, 0.01),
                            q_w = seq(0.01, 0.1, 0.01),
                            k_s = 4,
                            k_w = 2,
                            c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) 

# test scenario
r_s <- q_scenarios_df$r_s[1]
k_s <- q_scenarios_df$k_s[1]
q_s <- q_scenarios_df$q_s[1]
p_s <- q_scenarios_df$p_s[1]
r_w <- q_scenarios_df$r_w[1]
k_w <- q_scenarios_df$k_w[1]
q_w <- q_scenarios_df$q_w[1]
p_w <- q_scenarios_df$p_w[1]
c <- q_scenarios_df$c[1]



i = 1

# p_scenarios_df_out <- p_scenarios_df %>% 
#   pmap(~ run_model(p_scenarios_df$r_s, p_scenarios_df$r_w,
#                    p_scenarios_df$k_s, p_scenarios_df$k_w,
#                    p_scenarios_df$q_s, p_scenarios_df$q_w,
#                    p_scenarios_df$p_s, p_scenarios_df$p_w,
#                    p_scenarios_df$c)) %>% 
#   unlist() %>% 
#   as.data.frame()

for(i in 1:nrow(q_scenarios_df)){
 
  # Extract params
  r_s <- q_scenarios_df$r_s[i]
  r_w <- q_scenarios_df$r_w[i]
  k_s <- q_scenarios_df$k_s[i]
  k_w <- q_scenarios_df$k_w[i]
  q_s <- q_scenarios_df$q_s[i]
  q_w <- q_scenarios_df$q_w[i]
  p_s <- q_scenarios_df$p_s[i]
  p_w <- q_scenarios_df$p_w[i]
  c <- q_scenarios_df$c[i]
  sc_id <- q_scenarios_df$scenario_id[i]
 
  # Run model
  output <- run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                      q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_q <- output
  }
  else{
    output_q <- rbind(output_q, output)
  }

}

output_join_q <- output_q %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(q_scenarios_df, by = "scenario_id") %>% 
  relocate(scenario_id, .before = E)

output_q_tidy <- output_join_q %>% 
  mutate(q_ratio = q_s / q_w) %>% 
  pivot_longer(cols = E:N_w,
               names_to = "variables",
               values_to = "values") %>% 
  pivot_longer(cols = c(q_s, q_w),
               names_to = "stock_q",
               values_to = "q") 

output_q <- output_q_tidy %>% 
  select(scenario_id, variables, values, stock_q, q, q_ratio) %>% 
  distinct(variables, values, stock_q, q, q_ratio, .keep_all = TRUE)

#write_csv(output_q_tidy, file = file.path(outdir, "output_q_ranges.csv"), col_names = T)
```

```{r}
output_q %>% 
  pivot_wider(names_from = "stock_q",
              values_from = "q") %>% 
  filter(variables %in% c("N_w", "N_s") & values < 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = values)) +
  scale_x_continuous(breaks = seq(0.1, 1, 0.2)) +
  scale_y_continuous(breaks = seq(0.1, 1, 0.2)) +
  facet_wrap(~ variables) +
  scale_fill_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  facet_wrap(~ variables,
             scales = "free_y") +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Simulation of catchability ranges on stock size") +
  theme_bw() 
```

```{r}
# Building df of scenarios
r_scenarios_df <- expand.grid(p_s = seq(0.3, 6, 1),
                              p_w = seq(0.3, 8, 1),
                              r_s = seq(0.1, 1, 0.01),
                              r_w = seq(0.1, 0.99, 0.01),
                              q_s = 0.05,
                              q_w = 0.05,
                              k_s = 4,
                              k_w = 2,
                              c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) 

# test scenario
r_s <- r_scenarios_df$r_s[1]
k_s <- r_scenarios_df$k_s[1]
q_s <- r_scenarios_df$q_s[1]
p_s <- r_scenarios_df$p_s[1]
r_w <- r_scenarios_df$r_w[1]
k_w <- r_scenarios_df$k_w[1]
q_w <- r_scenarios_df$q_w[1]
p_w <- r_scenarios_df$p_w[1]
c <- r_scenarios_df$c[1]



i = 1

# p_scenarios_df_out <- p_scenarios_df %>% 
#   pmap(~ run_model(p_scenarios_df$r_s, p_scenarios_df$r_w,
#                    p_scenarios_df$k_s, p_scenarios_df$k_w,
#                    p_scenarios_df$q_s, p_scenarios_df$q_w,
#                    p_scenarios_df$p_s, p_scenarios_df$p_w,
#                    p_scenarios_df$c)) %>% 
#   unlist() %>% 
#   as.data.frame()

for(i in 1:100){
 
  # Extract params
  r_s <- r_scenarios_df$r_s[i]
  r_w <- r_scenarios_df$r_w[i]
  k_s <- r_scenarios_df$k_s[i]
  k_w <- r_scenarios_df$k_w[i]
  q_s <- r_scenarios_df$q_s[i]
  q_w <- r_scenarios_df$q_w[i]
  p_s <- r_scenarios_df$p_s[i]
  p_w <- r_scenarios_df$p_w[i]
  c <- r_scenarios_df$c[i]
  sc_id <- r_scenarios_df$scenario_id[i]
 
  # Run model
  output_2 <- run_model_2(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                      q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_r_2 <- output_2
  }
  else{
    output_r_2 <- rbind(output_r_2, output_2)
  }

}

output_join_r_2 <- output_r_2 %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(r_scenarios_df, by = "scenario_id") %>% 
  relocate(scenario_id, .before = Es)

# output_r_tidy <- output_join_r %>% 
#   mutate(r_ratio = r_s / r_w) %>% 
#   pivot_longer(cols = E:N_w,
#                names_to = "variables", 
#                values_to = "values") %>% 
#   pivot_longer(cols = c(r_s, r_w),
#                names_to = "stock_growth_r",
#                values_to = "r") %>% 
#   mutate(p_sw_ratio = round(p_s / p_w, 2)) %>% 
#   mutate(p_ws_ratio = round(p_w / p_s, 2))

# output_growth <- output_r_tidy %>% 
#   select(scenario_id, variables, values, stock_growth_r, r, r_ratio, p_w, p_s, p_sw_ratio, p_ws_ratio, k_w, k_s) %>% 
#   distinct_all()

write_csv(output_join_r_2, file = file.path(outdir, "output_r_ranges_2.csv"), col_names = T)
```

```{r, echo = FALSE}
out_r_p_ws <- 
  output_growth %>% 
  pivot_wider(names_from = "stock_growth_r",
              values_from = "r") %>% 
  filter(variables == "N_w" & r_s >= r_w & values > 0) %>% 
  ggplot() +  
  geom_raster(aes(x = r_w, y = r_s, fill = values/k_w)) +
  scale_x_continuous(breaks = seq(0, 1, 0.4),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 1.1, 0.2),
                     expand = c(0,0)) +
  facet_wrap(~ as.factor(p_ws_ratio),
             nrow = 3,
             ncol = 11) +
  scale_fill_gradientn(name = "B/K",
                       colors = RColorBrewer::brewer.pal(9, "YlOrBr"),
                       breaks = seq(0.01, 0.125, 0.1)) +
  labs(x = "rw",
       y = "rs",
       subtitle = "pw:ps ratios") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10),
        strip.background = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(2, "mm"),
        legend.position = "none")
```

```{r, echo = FALSE, fig.width=8, fig.height=8}
out_r_p_sw <- 
  output_growth %>% 
  pivot_wider(names_from = "stock_growth_r",
              values_from = "r") %>% 
  filter(variables == "N_w" & r_s >= r_w & values > 0) %>% 
  ggplot() +  
  geom_raster(aes(x = r_w, y = r_s, fill = values/k_w)) +
  scale_x_continuous(breaks = seq(0, 1, 0.4),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 1.1, 0.2),
                     expand = c(0,0)) +
  facet_wrap(~ as.factor(p_sw_ratio),
             nrow = 3,
             ncol = 11) +
  scale_fill_gradientn(name = "B/K",
                       colors = RColorBrewer::brewer.pal(9, "YlOrBr"),
                       breaks = seq(0.01, 0.125, 0.1)) +
  labs(x = "rw",
       y = "",
       subtitle = "ps:pw ratios") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10),
        strip.background = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(2, "mm"),
        legend.position = "bottom")
```

```{r, echo = FALSE, fig.width=13, fig.height=8}
out_r_p_ws + out_r_p_sw +
  plot_annotation(tag_levels = "A") +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

```{r}
p_w_labs <- c("pw = 0", "pw = 1", "pw = 2", "pw = 3", "pw = 4", "pw = 5")
names(p_w_labs) <- c(0, 1 , 2, 3, 4, 5)

p_s_labs <- c("ps = 1", "ps = 2", "ps = 3", "ps = 4", "ps = 5", "ps = 6")
names(p_s_labs) <- c(1 , 2, 3, 4, 5, 6)


output_growth %>% 
  pivot_wider(names_from = "stock_growth_r",
              values_from = "r") %>% 
  filter(variables == "N_w" & r_s >= r_w & values > 0) %>% 
  ggplot() +  
  geom_raster(aes(x = r_w, y = r_s, fill = values/k_w)) +
  scale_x_continuous(breaks = seq(0, 1, 0.3),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 1.1, 0.4),
                     expand = c(0,0)) +
  facet_grid(p_s ~ p_w,
             labeller = labeller(p_s = p_s_labs,
                                 p_w = p_w_labs)) +
  scale_fill_gradientn(name = "B/K",
                       colors = RColorBrewer::brewer.pal(9, "YlOrBr")) +
  labs(x = "rw",
       y = "rs",
       subtitle = "") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10),
        strip.background = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.spacing = unit(2, "mm"),
        legend.position = "right")
```


```{r}
output_full <- output_price_range %>% 
  left_join(output_growth, by = c("scenario_id", "variables")) %>% 
  left_join(output_q, by = c("scenario_id", "variables")) %>% 
  rename(values_price = values.x,
         values_growth = values.y,
         values_q = values) %>% 
  # mutate(stock_q_2 = sto ck_q,
  #        stock_r = stock_growth_r,
  #        q2 = q,
  #        r2 = r) %>% 
  pivot_wider(names_from = "stock_q",
              values_from = "q") %>% 
  pivot_wider(names_from = "stock_growth_r",
              values_from = "r") %>% 
  mutate(prod_ratio = (q_s / r_s) / (q_w / r_w)) 

#write_csv(output_full, file = file.path(outdir, "output_full.csv"), col_names = T)
```




```{r}

# In this code chunk, I'll generate the dataset to simulate a scenario in which we don't care about the strong stock and just plot the luxury price effect.

weak_stock_eq_fcn <- function(c, p_w, q_w, r_w, f) {
  
  # N_w with price as a constant
  N_w <- c / p_w * q_w
  
  # Weak stock effort
  E_w <- 1 / (q_w / r_w)
  
  # Weak stock catch
  C_w <- q_w * N_w * E_w
  
  p_w_star <- C_w
  
  N_w_star <- c / (p_w_star) * q_w
  
  # Build output
  output <- data.frame(N_w = N_w, E_w = E_w, C_w = C_w, p_w_star = p_w_star, N_w_star = N_w_star)
 
  # Return
  return(output)
 
}

weak_scenarios_df <- expand.grid(p_w = seq(0, 10, 0.1),
                                 q_w = 0.1,
                                 r_w = 0.88,
                                 f = 1,
                                 c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) 

# test scenario
q_w <- weak_scenarios_df$q_w[1]
p_w <- weak_scenarios_df$p_w[1]
r_w <- weak_scenarios_df$r_w[1]
f <- weak_scenarios_df$f[1]
c <- weak_scenarios_df$c[1]


i = 1

for(i in 1:nrow(weak_scenarios_df)){
 
  # Extract params
  q_w <- weak_scenarios_df$q_w[i]
  p_w <- weak_scenarios_df$p_w[i]
  r_w <- weak_scenarios_df$r_w[i]
  f <- weak_scenarios_df$f[i]
  c <- weak_scenarios_df$c[i]
  sc_id <- weak_scenarios_df$scenario_id[i]
 
  # Run model
  output_w <- weak_stock_eq_fcn(q_w = q_w, p_w = p_w, c = c, r_w = r_w, f = f) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_weak <- output_w
  }
  else{
    output_weak <- rbind(output_weak, output_w)
  }

}

output_weak_test  <- output_weak %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(weak_scenarios_df, by = "scenario_id") %>% 
  mutate(b_v_k = N_w / 2)


# output_price_range <- output_p_tidy %>% 
#   select(scenario_id, variables, values, stock_prices, prices, price_ratio) %>% 
#   distinct(variables, values, stock_prices, prices, price_ratio, .keep_all = TRUE)

#write_csv(output_weak_test, file = file.path(outdir, "output_weak_test.csv"), col_names = T)
```


## Setting up the time series simulation

$$
\begin{align}
\frac{d N_s}{dt} &= N_st  (r_s  (\frac{1 - N_St}{K_s}) - q_s e_t) \\
\newline
\frac{d N_w}{dt} &= N_wt  (r_w  (\frac{1 - N_wt}{K_w}) - q_w e_t) \\
\newline
\frac{d E}{dt} &= \alpha  E (p_s  q_s  N_st + p_w q_w N_wt - c)
\end{align}
$$

where $q_s$ and $q_w$ are the catchability of the strong and the weak stock, respectively; $r_s$ and $r_w$ are the intrinsic growth rates of the strong and weak stocks, respectively; $p_s$ and $p_w$ are the prices of the strong and weak stocks, respectively; $k_s$ and $k_w$ are the carrying capacities of the strong and weak stocks, respectively; $c$ is the fishing cost, and $\alpha$ is a constant controling for the speed at which effort changes following price changes.

```{r, echo = FALSE}
# set up the parameter space
q_s1 <- 0.1
q_w1 <- 0.15
k_s1 <- 1
k_w1 <- 1
r_s1 <- 1
r_w1 <- 1
p_s1 <- 1
p_w1 <- 1
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu <- NaN*tset; N_w_simu[1] <- N_w

N_s_simu <- NaN*tset; N_s_simu[1] <- N_s

E_simu <- NaN*tset; E_simu[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w <- N_w_simu[i-1]
  N_s <- N_s_simu[i-1]
  E <- E_simu[i-1]
  
  # Calculate change in variable size at each time step
  dN_s <- (N_s * (r_s * (1 - N_s/k_s) - q_s * E)) * dt
  dN_w <- (N_w * (r_w * (1 - N_w/k_w) - q_w * E)) * dt
  dE <- (alpha * E * (p_s * q_s * N_s + p_w * q_w * N_w - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu[i] <- N_w + dN_w
  N_s_simu[i] <- N_s + dN_s
  E_simu[i] <- E + dE
  
}
  

```


```{r, echo = FALSE}
plot(x = tset, y = N_s_simu,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 8),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu,
      type = "l", col = "orange")
lines(x = tset, y = E_simu,
      type = "l", col = "green")
title(title = "First simulation",
      sub = "Params: q_s = 0.1, q_w = 0.15, r_s = 1, r_w = 1, k_s = 1, k_w = 1, p_s = 1, p_w = 1")
legend(x = 80, y = 5,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

```{r, echo = FALSE}
# set up the parameter space
q_s2 <- 0.1
q_w2 <- 0.1
k_s2 <- 2
k_w2 <- 1
r_s2 <- 0.5
r_w2 <- 0.25
p_s2 <- 1
p_w2 <- 5
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu2 <- NaN*tset; N_w_simu2[1] <- N_w

N_s_simu2 <- NaN*tset; N_s_simu2[1] <- N_s

E_simu2 <- NaN*tset; E_simu2[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w2 <- N_w_simu2[i-1]
  N_s2 <- N_s_simu2[i-1]
  E2 <- E_simu2[i-1]
  
  # Calculate change in variable size at each time step
  dN_s2 <- (N_s2 * (r_s2 * (1 - N_s2/k_s2) - q_s2 * E2)) * dt
  dN_w2 <- (N_w2 * (r_w2 * (1 - N_w2/k_w2) - q_w2 * E2)) * dt
  dE2 <- (alpha * E2 * (p_s2 * q_s2 * N_s2 + p_w2 * q_w2 * N_w2 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu2[i] <- N_w2 + dN_w2
  N_s_simu2[i] <- N_s2 + dN_s2
  E_simu2[i] <- E2 + dE2
  
}
  

```


```{r, echo = FALSE}
plot(x = tset, y = N_s_simu2,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 8),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu2,
      type = "l", col = "orange")
lines(x = tset, y = E_simu2,
      type = "l", col = "green")
title(main = "Second simulation",
      sub = "Params: q_s = 0.1, q_w = 0.1, r_s = 0.5, r_w = 0.25, k_s = 2, k_w = 1, p_s = 1, p_w = 5")
legend(x = 80, y = 7.7,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

```{r, echo = FALSE}
# set up the parameter space
q_s3 <- 0.1
q_w3 <- 0.1
k_s3 <- 3
k_w3 <- 1
r_s3 <- 1
r_w3 <- 0.2
p_s3 <- 1
p_w3 <- 10
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu3 <- NaN*tset; N_w_simu3[1] <- N_w

N_s_simu3 <- NaN*tset; N_s_simu3[1] <- N_s

E_simu3 <- NaN*tset; E_simu3[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w3 <- N_w_simu3[i-1]
  N_s3 <- N_s_simu3[i-1]
  E3 <- E_simu3[i-1]
  
  # Calculate change in variable size at each time step
  dN_s3 <- (N_s3 * (r_s3 * (1 - N_s3/k_s3) - q_s3 * E3)) * dt
  dN_w3 <- (N_w3 * (r_w3 * (1 - N_w3/k_w3) - q_w3 * E3)) * dt
  dE3 <- (alpha * E3 * (p_s3 * q_s3 * N_s3 + p_w3 * q_w3 * N_w3 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu3[i] <- N_w3 + dN_w3
  N_s_simu3[i] <- N_s3 + dN_s3
  E_simu3[i] <- E3 + dE3
  
}
  

```


```{r, echo = FALSE}
plot(x = tset, y = N_s_simu3,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 15),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu3,
      type = "l", col = "orange")
lines(x = tset, y = E_simu3,
      type = "l", col = "green")
title(main = "Third simulation",
      sub = "Params: q_s = 0.1, q_w = 0.1, r_s = 1, r_w = 0.2, k_s = 3, k_w = 1, p_s = 1, p_w = 10")
legend(x = 80, y = 14,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

```{r, echo = FALSE}
# set up the parameter space
q_s4 <- 0.1
q_w4 <- 0.1
k_s4 <- 3
k_w4 <- 1
r_s4 <- 1
r_w4 <- 0.2
p_s4 <- 0.1
p_w4 <- 10
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu4 <- NaN*tset; N_w_simu4[1] <- N_w

N_s_simu4 <- NaN*tset; N_s_simu4[1] <- N_s

E_simu4 <- NaN*tset; E_simu4[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w4 <- N_w_simu4[i-1]
  N_s4 <- N_s_simu4[i-1]
  E4 <- E_simu4[i-1]
  
  # Calculate change in variable size at each time step
  dN_s4 <- (N_s4 * (r_s4 * (1 - N_s4/k_s4) - q_s4 * E4)) * dt
  dN_w4 <- (N_w4 * (r_w4 * (1 - N_w4/k_w4) - q_w4 * E4)) * dt
  dE4 <- (alpha * E4 * (p_s4 * q_s4 * N_s4 + p_w4 * q_w4 * N_w4 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu4[i] <- N_w4 + dN_w4
  N_s_simu4[i] <- N_s4 + dN_s4
  E_simu4[i] <- E4 + dE4
  
}
  

```


```{r, echo = FALSE}
plot(x = tset, y = N_s_simu4,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 12),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu4,
      type = "l", col = "orange")
lines(x = tset, y = E_simu4,
      type = "l", col = "green")
title(main = "Fourth simulation",
      sub = "Params: q_s = 0.1, q_w = 0.1, r_s = 1, r_w = 0.2, k_s = 3, k_w = 1, p_s = 0.1, p_w = 10")
legend(x = 80, y = 10,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

















