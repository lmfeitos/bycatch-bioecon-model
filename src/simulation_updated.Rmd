---
title: "simulation scenarios"
author: "Leonardo Feitosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(patchwork)

basedir <- "G:/Meu Drive/PhD Project - Fisheries bycatch/Bycatch project/Chapter 1/analyses/"
outdir <- file.path(basedir, "model_outs") # calls present data from raster files

```

```{r model function}
run_model <- function(r_s, k_s, q_s, p_s, r_w, k_w, q_w, p_w, c){
 
  N_w <- (k_w * (c * q_w * r_s + k_s * p_s * q_s * (- q_w * r_s + q_s * r_w))) / 
    (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w)
  
  E <- ((- c + k_s * p_s * q_s + k_w * p_w * q_w) * r_s * r_w)  /
   (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
  
  N_s <- (k_s * (c * q_s * r_w + k_w * p_w * q_w * (q_w * r_s - q_s * r_w))) /
     (k_w * p_w * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w)
  
  # Weak stock catch
  #C_w <- q_w * N_w * E
  
  # Price as a function of catch
  #p_w_star <- C_w
  
  # Derive weak stock biomass
 
  #N_w_star <- (k_w * (c * q_w * r_s + k_s * p_s * q_s * (- q_w * r_s + q_s * r_w))) / 
  #  (k_w * p_w_star * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w)
  
  # Derive effort
  #E_star <- ((- c + k_s * p_s * q_s + k_w * p_w_star * q_w) * r_s * r_w)  /
  # (k_w * p_w_star * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w) 
  
 # Derive strong stock biomass
 
  #N_s_star <- (k_s * (c * q_s * r_w + k_w * p_w_star * q_w * (q_w * r_s - q_s * r_w))) /
  #   (k_w * p_w_star * q_w^2 * r_s + k_s * p_s * q_s^2 * r_w)
  
  
  # Build output
  output <- data.frame(E = E, N_s = N_s, N_w = N_w)
 
  #p_w_star = p_w_star, C_w = C_w, N_w_star = N_w_star, E_star = E_star, N_s_star = N_s_star
  # Return
  return(output)
 
 
}

```


```{r scenario simulations}
# Building df of scenarios
scenarios_df <- expand.grid(r_s = seq(0.1, 1, 0.1),
                            r_w = seq(0.1, 1, 0.1),
                            k_s = seq(1, 5, .5),
                            k_w = seq(1, 5, .5),
                            q_s = seq(0.1, 1, 0.1),
                            q_w = seq(0.1, 1, 0.1),
                            p_s = seq(0, 10, 1),
                            p_w = seq(0, 10, 1),
                            c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) 

# test scenario
r_s <- scenarios_df$r_s[1]
k_s <- scenarios_df$k_s[1]
q_s <- scenarios_df$q_s[1]
p_s <- scenarios_df$p_s[1]
r_w <- scenarios_df$r_w[1]
k_w <- scenarios_df$k_w[1]
q_w <- scenarios_df$q_w[1]
p_w <- scenarios_df$p_w[1]
c <- scenarios_df$c[1]

i = 1

# test with purrr
#scenarios_df %>% 
#  pmap(~ run_model(scenarios_df$r_s, scenarios_df$r_w,
#                   scenarios_df$k_s, scenarios_df$k_w,
#                   scenarios_df$q_s, scenarios_df$q_w,
#                   scenarios_df$p_s, scenarios_df$p_w,
#                   scenarios_df$c)) %>% 
#    mutate(sc_id = sc_id)

for(i in 1:nrow(scenarios_df)){
 
  # Extract params
  r_s <- scenarios_df$r_s[i]
  r_w <- scenarios_df$r_w[i]
  k_s <- scenarios_df$k_s[i]
  k_w <- scenarios_df$k_w[i]
  q_s <- scenarios_df$q_s[i]
  q_w <- scenarios_df$q_w[i]
  p_s <- scenarios_df$p_s[i]
  p_w <- scenarios_df$p_w[i]
  c <- scenarios_df$c[i]
  sc_id <- scenarios_df$scenario_id[i]
 
  # Run model
  output <- run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                      q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_1 <- output
  }
  else{
    output_1 <- rbind(output_1, output)
  }

}
```

```{r output wrangling}
output_join <- output_1 %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(scenarios_df, by = "scenario_id") %>% 
  relocate(scenario_id, .before = e)

output_tidy <- output_join %>% 
  mutate(price_ratio = p_s / p_w) %>% 
  mutate(prod_ratio = q_s / r_s / q_w / r_w) %>% 
  mutate(k_ratio = k_s / k_w) %>% 
  mutate(q_ratio = q_s / q_w) %>% 
  pivot_longer(cols = e:N_w,
               names_to = "variables",
               values_to = "values") %>% 
  pivot_longer(cols = c(p_s, p_w),
               names_to = "stock_prices",
               values_to = "prices") %>% 
  pivot_longer(cols = c(r_s, r_w),
               names_to = "stock_growth_r",
               values_to = "r") %>% 
  pivot_longer(cols = c(q_s, q_w),
               names_to = "stock_q",
               values_to = "q") %>% 
  pivot_longer(cols = c(k_w, k_s),
               names_to = "stock_k",
               values_to = "k") 

output_price <- output_tidy %>% 
  select(scenario_id, variables, values, stock_prices, prices, price_ratio) %>% 
  distinct_all()

output_growth <- output_tidy %>% 
  select(scenario_id, variables, values, stock_growth_r, r, prod_ratio) %>% 
  distinct_all()

output_k <- output_tidy %>% 
  select(scenario_id, variables, values, stock_k, k, k_ratio) %>% 
  distinct_all()

output_q <- output_tidy %>% 
  select(scenario_id, variables, values, stock_q, q, q_ratio) %>% 
  distinct_all()

#write_csv(output_price, file = file.path(outdir, "price_ranges.csv"), col_names = T)
#write_csv(output_growth, file = file.path(outdir, "growth_ranges.csv"), col_names = T)
#write_csv(output_k, file = file.path(outdir, "k_ranges.csv"), col_names = T)
#write_csv(output_q, file = file.path(outdir, "q_ranges.csv"), col_names = T)

```


```{r}
# Building df of price range scenarios
p_scenarios_df <- expand.grid(p_s = seq(0.1, 10, 0.2),
                            p_w = seq(0.1, 10, 0.2),
                            r_s = 1,
                            r_w = 1,
                            q_s = 0.1,
                            q_w = 0.1,
                            k_s = 1,
                            k_w = 1,
                            c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) 

# test scenario
r_s <- p_scenarios_df$r_s[1]
k_s <- p_scenarios_df$k_s[1]
q_s <- p_scenarios_df$q_s[1]
p_s <- p_scenarios_df$p_s[1]
r_w <- p_scenarios_df$r_w[1]
k_w <- p_scenarios_df$k_w[1]
q_w <- p_scenarios_df$q_w[1]
p_w <- p_scenarios_df$p_w[1]
c <- p_scenarios_df$c[1]


i = 1

# test with purrr
# p_scenarios_df_out <- p_scenarios_df %>% 
#   pmap(~ run_model(p_scenarios_df$r_s, p_scenarios_df$r_w,
#                    p_scenarios_df$k_s, p_scenarios_df$k_w,
#                    p_scenarios_df$q_s, p_scenarios_df$q_w,
#                    p_scenarios_df$p_s, p_scenarios_df$p_w,
#                    p_scenarios_df$c)) %>% 
#   unlist() %>% 
#   as.data.frame()

for(i in 1:nrow(p_scenarios_df)){
 
  # Extract params
  r_s <- p_scenarios_df$r_s[i]
  r_w <- p_scenarios_df$r_w[i]
  k_s <- p_scenarios_df$k_s[i]
  k_w <- p_scenarios_df$k_w[i]
  q_s <- p_scenarios_df$q_s[i]
  q_w <- p_scenarios_df$q_w[i]
  p_s <- p_scenarios_df$p_s[i]
  p_w <- p_scenarios_df$p_w[i]
  c <- p_scenarios_df$c[i]
  sc_id <- p_scenarios_df$scenario_id[i]
 
  # Run model
  output <- run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                      q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_1 <- output
  }
  else{
    output_1 <- rbind(output_1, output)
  }

}

output_join <- output_1 %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(p_scenarios_df, by = "scenario_id") %>% 
  relocate(scenario_id, .before = e)

output_p_tidy <- output_join %>% 
  mutate(price_ratio = p_s / p_w) %>% 
  pivot_longer(cols = e:N_w,
               names_to = "variables",
               values_to = "values") %>% 
  pivot_longer(cols = c(p_s, p_w),
               names_to = "stock_prices",
               values_to = "prices") 
  
output_price_range <- output_p_tidy %>% 
  select(scenario_id, variables, values, stock_prices, prices, price_ratio) %>% 
  distinct(variables, values, stock_prices, prices, price_ratio, .keep_all = TRUE)

#write_csv(output_price_range, file = file.path(outdir, "output_price_ranges.csv"), col_names = T)
```

```{r}
output_price_range %>%
  pivot_wider(names_from = "stock_prices",
              values_from = "prices") %>% 
  filter(variables %in% c("N_w", "N_s")) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables,
            scales = "free_y") +
  scale_fill_gradientn(name = "Stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(breaks = seq(0, 10, 1)) +
  labs(x = "Weak stock price range",
       y = "Strong stock price range",
       title = "Simulation of price ranges on variable size") +
  theme_bw() 
```


```{r}
# Building df of scenarios
q_scenarios_df <- expand.grid(p_s = 1,
                            p_w = 1,
                            r_s = 1,
                            r_w = 1,
                            q_s = seq(0.1, 1, 0.01),
                            q_w = seq(0.1, 1, 0.01),
                            k_s = 1,
                            k_w = 1,
                            c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) 

# test scenario
r_s <- q_scenarios_df$r_s[1]
k_s <- q_scenarios_df$k_s[1]
q_s <- q_scenarios_df$q_s[1]
p_s <- q_scenarios_df$p_s[1]
r_w <- q_scenarios_df$r_w[1]
k_w <- q_scenarios_df$k_w[1]
q_w <- q_scenarios_df$q_w[1]
p_w <- q_scenarios_df$p_w[1]
c <- q_scenarios_df$c[1]



i = 1

# p_scenarios_df_out <- p_scenarios_df %>% 
#   pmap(~ run_model(p_scenarios_df$r_s, p_scenarios_df$r_w,
#                    p_scenarios_df$k_s, p_scenarios_df$k_w,
#                    p_scenarios_df$q_s, p_scenarios_df$q_w,
#                    p_scenarios_df$p_s, p_scenarios_df$p_w,
#                    p_scenarios_df$c)) %>% 
#   unlist() %>% 
#   as.data.frame()

for(i in 1:nrow(q_scenarios_df)){
 
  # Extract params
  r_s <- q_scenarios_df$r_s[i]
  r_w <- q_scenarios_df$r_w[i]
  k_s <- q_scenarios_df$k_s[i]
  k_w <- q_scenarios_df$k_w[i]
  q_s <- q_scenarios_df$q_s[i]
  q_w <- q_scenarios_df$q_w[i]
  p_s <- q_scenarios_df$p_s[i]
  p_w <- q_scenarios_df$p_w[i]
  c <- q_scenarios_df$c[i]
  sc_id <- q_scenarios_df$scenario_id[i]
 
  # Run model
  output <- run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                      q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_q <- output
  }
  else{
    output_q <- rbind(output_q, output)
  }

}

output_join_q <- output_q %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(q_scenarios_df, by = "scenario_id") %>% 
  relocate(scenario_id, .before = e)

output_q_tidy <- output_join_q %>% 
  mutate(q_ratio = q_s / q_w) %>% 
  pivot_longer(cols = e:N_w,
               names_to = "variables",
               values_to = "values") %>% 
  pivot_longer(cols = c(q_s, q_w),
               names_to = "stock_q",
               values_to = "q") 

output_q <- output_q_tidy %>% 
  select(scenario_id, variables, values, stock_q, q, q_ratio) %>% 
  distinct(variables, values, stock_q, q, q_ratio, .keep_all = TRUE)

#write_csv(output_q, file = file.path(outdir, "output_q_ranges.csv"), col_names = T)
```

```{r}
output_q %>% 
  pivot_wider(names_from = "stock_q",
              values_from = "q") %>% 
  filter(variables %in% c("N_w", "N_s") & values < 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = values)) +
  scale_x_continuous(breaks = seq(0.1, 1, 0.2)) +
  scale_y_continuous(breaks = seq(0.1, 1, 0.2)) +
  facet_wrap(~ variables) +
  scale_fill_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  facet_wrap(~ variables,
             scales = "free_y") +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Simulation of catchability ranges on stock size") +
  theme_bw() 
```

```{r}
# Building df of scenarios
r_scenarios_df <- expand.grid(p_s = seq(1, 6, 1),
                              p_w = seq(0, 5, 1),
                              r_s = seq(0.1, 1, 0.01),
                              r_w = seq(0.1, 0.99, 0.01),
                              q_s = 0.1,
                              q_w = 0.1,
                              k_s = 4,
                              k_w = 2,
                              c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) 

# test scenario
r_s <- r_scenarios_df$r_s[1]
k_s <- r_scenarios_df$k_s[1]
q_s <- r_scenarios_df$q_s[1]
p_s <- r_scenarios_df$p_s[1]
r_w <- r_scenarios_df$r_w[1]
k_w <- r_scenarios_df$k_w[1]
q_w <- r_scenarios_df$q_w[1]
p_w <- r_scenarios_df$p_w[1]
c <- r_scenarios_df$c[1]



i = 1

# p_scenarios_df_out <- p_scenarios_df %>% 
#   pmap(~ run_model(p_scenarios_df$r_s, p_scenarios_df$r_w,
#                    p_scenarios_df$k_s, p_scenarios_df$k_w,
#                    p_scenarios_df$q_s, p_scenarios_df$q_w,
#                    p_scenarios_df$p_s, p_scenarios_df$p_w,
#                    p_scenarios_df$c)) %>% 
#   unlist() %>% 
#   as.data.frame()

for(i in 1:nrow(r_scenarios_df)){
 
  # Extract params
  r_s <- r_scenarios_df$r_s[i]
  r_w <- r_scenarios_df$r_w[i]
  k_s <- r_scenarios_df$k_s[i]
  k_w <- r_scenarios_df$k_w[i]
  q_s <- r_scenarios_df$q_s[i]
  q_w <- r_scenarios_df$q_w[i]
  p_s <- r_scenarios_df$p_s[i]
  p_w <- r_scenarios_df$p_w[i]
  c <- r_scenarios_df$c[i]
  sc_id <- r_scenarios_df$scenario_id[i]
 
  # Run model
  output <- run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                      q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_r <- output
  }
  else{
    output_r <- rbind(output_r, output)
  }

}

output_join_r <- output_r %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(r_scenarios_df, by = "scenario_id") %>% 
  relocate(scenario_id, .before = E)

output_r_tidy <- output_join_r %>% 
  mutate(r_ratio = r_s / r_w) %>% 
  pivot_longer(cols = E:N_w,
               names_to = "variables",
               values_to = "values") %>% 
  pivot_longer(cols = c(r_s, r_w),
               names_to = "stock_growth_r",
               values_to = "r") %>% 
  mutate(p_sw_ratio = round(p_s / p_w, 2)) %>% 
  mutate(p_ws_ratio = round(p_w / p_s, 2))

output_growth <- output_r_tidy %>% 
  select(scenario_id, variables, values, stock_growth_r, r, r_ratio, p_w, p_s, p_sw_ratio, p_ws_ratio, k_w, k_s) %>% 
  distinct_all()

#write_csv(output_growth, file = file.path(outdir, "output_r_ranges.csv"), col_names = T)
```

```{r, echo = FALSE}
out_r_p_ws <- 
  output_growth %>% 
  pivot_wider(names_from = "stock_growth_r",
              values_from = "r") %>% 
  filter(variables == "N_w" & r_s >= r_w & values > 0) %>% 
  ggplot() +  
  geom_raster(aes(x = r_w, y = r_s, fill = values/k_w)) +
  scale_x_continuous(breaks = seq(0, 1, 0.4),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 1.1, 0.2),
                     expand = c(0,0)) +
  facet_wrap(~ as.factor(p_ws_ratio),
             nrow = 3,
             ncol = 11) +
  scale_fill_gradientn(name = "B/K",
                       colors = RColorBrewer::brewer.pal(9, "YlOrBr"),
                       breaks = seq(0.01, 0.125, 0.1)) +
  labs(x = "rw",
       y = "rs",
       subtitle = "pw:ps ratios") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10),
        strip.background = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(2, "mm"),
        legend.position = "none")
```

```{r, echo = FALSE, fig.width=8, fig.height=8}
out_r_p_sw <- 
  output_growth %>% 
  pivot_wider(names_from = "stock_growth_r",
              values_from = "r") %>% 
  filter(variables == "N_w" & r_s >= r_w & values > 0) %>% 
  ggplot() +  
  geom_raster(aes(x = r_w, y = r_s, fill = values/k_w)) +
  scale_x_continuous(breaks = seq(0, 1, 0.4),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 1.1, 0.2),
                     expand = c(0,0)) +
  facet_wrap(~ as.factor(p_sw_ratio),
             nrow = 3,
             ncol = 11) +
  scale_fill_gradientn(name = "B/K",
                       colors = RColorBrewer::brewer.pal(9, "YlOrBr"),
                       breaks = seq(0.01, 0.125, 0.1)) +
  labs(x = "rw",
       y = "",
       subtitle = "ps:pw ratios") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10),
        strip.background = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(2, "mm"),
        legend.position = "bottom")
```

```{r, echo = FALSE, fig.width=13, fig.height=8}
out_r_p_ws + out_r_p_sw +
  plot_annotation(tag_levels = "A") +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

```{r}
p_w_labs <- c("pw = 0", "pw = 1", "pw = 2", "pw = 3", "pw = 4", "pw = 5")
names(p_w_labs) <- c(0, 1 , 2, 3, 4, 5)

p_s_labs <- c("ps = 1", "ps = 2", "ps = 3", "ps = 4", "ps = 5", "ps = 6")
names(p_s_labs) <- c(1 , 2, 3, 4, 5, 6)


output_growth %>% 
  pivot_wider(names_from = "stock_growth_r",
              values_from = "r") %>% 
  filter(variables == "N_w" & r_s >= r_w & values > 0) %>% 
  ggplot() +  
  geom_raster(aes(x = r_w, y = r_s, fill = values/k_w)) +
  scale_x_continuous(breaks = seq(0, 1, 0.3),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 1.1, 0.4),
                     expand = c(0,0)) +
  facet_grid(p_s ~ p_w,
             labeller = labeller(p_s = p_s_labs,
                                 p_w = p_w_labs)) +
  scale_fill_gradientn(name = "B/K",
                       colors = RColorBrewer::brewer.pal(9, "YlOrBr")) +
  labs(x = "rw",
       y = "rs",
       subtitle = "") +
  theme_bw() +
  theme(axis.title = element_text(color = "black", size = 12),
        axis.text = element_text(color = "black", size = 10),
        strip.background = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.spacing = unit(2, "mm"),
        legend.position = "right")
```


```{r}
output_full <- output_price_range %>% 
  left_join(output_growth, by = c("scenario_id", "variables")) %>% 
  left_join(output_q, by = c("scenario_id", "variables")) %>% 
  rename(values_price = values.x,
         values_growth = values.y,
         values_q = values) %>% 
  # mutate(stock_q_2 = sto ck_q,
  #        stock_r = stock_growth_r,
  #        q2 = q,
  #        r2 = r) %>% 
  pivot_wider(names_from = "stock_q",
              values_from = "q") %>% 
  pivot_wider(names_from = "stock_growth_r",
              values_from = "r") %>% 
  mutate(prod_ratio = (q_s / r_s) / (q_w / r_w)) 

#write_csv(output_full, file = file.path(outdir, "output_full.csv"), col_names = T)
```


```{r scenario range for 1st plot for the paper}
################### USED THIS CODE TO BUILD THE PARAMETER SET OF FIGURE 2 ################################################

# In this code chunk, I'll generate the dataset to simulate a scenario where the weak stock has zero value and the strong and weak stocks growth rates vary in different ratios.

# Building df of price range scenarios
scenarios_df <- expand.grid(p_s = seq(1, 15, 3),
                            p_w = seq(0.1, 10, 0.1),
                            r_s = 1,
                            r_w = seq(0.5, 0.999, 0.01),
                            q_s = 0.1,
                            q_w = 0.1,
                            k_s = 4,
                            k_w = 2,
                            c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) 

# test scenario
r_s <- scenarios_df$r_s[1]
k_s <- scenarios_df$k_s[1]
q_s <- scenarios_df$q_s[1]
p_s <- scenarios_df$p_s[1]
r_w <- scenarios_df$r_w[1]
k_w <- scenarios_df$k_w[1]
q_w <- scenarios_df$q_w[1]
p_w <- scenarios_df$p_w[1]
c <- scenarios_df$c[1]


i = 1

# test with purrr
# scenarios_df_out <- scenarios_df %>% 
#  pmap_dfr(~ run_model(scenarios_df$r_s, scenarios_df$r_w,
#                   scenarios_df$k_s, scenarios_df$k_w,
#                   scenarios_df$q_s, scenarios_df$q_w,
#                   scenarios_df$p_s, scenarios_df$p_w,
#                   scenarios_df$c)) 

for(i in 1:nrow(scenarios_df)){
 
  # Extract params
  r_s <- scenarios_df$r_s[i]
  r_w <- scenarios_df$r_w[i]
  k_s <- scenarios_df$k_s[i]
  k_w <- scenarios_df$k_w[i]
  q_s <- scenarios_df$q_s[i]
  q_w <- scenarios_df$q_w[i]
  p_s <- scenarios_df$p_s[i]
  p_w <- scenarios_df$p_w[i]
  c <- scenarios_df$c[i]
  sc_id <- scenarios_df$scenario_id[i]
 
  # Run model
  output <- run_model(r_s = r_s, r_w = r_w, k_s = k_s, k_w = k_w,
                      q_s = q_s, q_w = q_w, p_s = p_s, p_w = p_w, 
                      c = c) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_1 <- output
  }
  else{
    output_1 <- rbind(output_1, output)
  }

}

output_join_test  <- output_1 %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(scenarios_df, by = "scenario_id") %>% 
  relocate(scenario_id, .before = E)

output_p_tidy <- output_join_test %>% 
  mutate(price_ratio = p_s / p_w) %>% 
  pivot_longer(cols = E:N_w,
               names_to = "variables",
               values_to = "values") 
  
# output_price_range <- output_p_tidy %>% 
#   select(scenario_id, variables, values, stock_prices, prices, price_ratio) %>% 
#   distinct(variables, values, stock_prices, prices, price_ratio, .keep_all = TRUE)

#write_csv(output_p_tidy, file = file.path(outdir, "output_w_ranges_s_ranges.csv"), col_names = T)
```

```{r}

# In this code chunk, I'll generate the dataset to simulate a scenario in which we don't care about the strong stock and just plot the luxury price effect.

weak_stock_eq_fcn <- function(c, p_w, q_w, r_w, f) {
  
  # N_w with price as a constant
  N_w <- c / p_w * q_w
  
  # Weak stock effort
  E_w <- 1 / (q_w / r_w)
  
  # Weak stock catch
  C_w <- q_w * N_w * E_w
  
  p_w_star <- C_w
  
  N_w_star <- c / (p_w_star) * q_w
  
  # Build output
  output <- data.frame(N_w = N_w, E_w = E_w, C_w = C_w, p_w_star = p_w_star, N_w_star = N_w_star)
 
  # Return
  return(output)
 
}

weak_scenarios_df <- expand.grid(p_w = seq(0, 10, 0.1),
                                 q_w = 0.1,
                                 r_w = 0.88,
                                 f = 1,
                                 c = 0.05) %>% 
  mutate(scenario_id = 1:nrow(.)) 

# test scenario
q_w <- weak_scenarios_df$q_w[1]
p_w <- weak_scenarios_df$p_w[1]
r_w <- weak_scenarios_df$r_w[1]
f <- weak_scenarios_df$f[1]
c <- weak_scenarios_df$c[1]


i = 1

for(i in 1:nrow(weak_scenarios_df)){
 
  # Extract params
  q_w <- weak_scenarios_df$q_w[i]
  p_w <- weak_scenarios_df$p_w[i]
  r_w <- weak_scenarios_df$r_w[i]
  f <- weak_scenarios_df$f[i]
  c <- weak_scenarios_df$c[i]
  sc_id <- weak_scenarios_df$scenario_id[i]
 
  # Run model
  output_w <- weak_stock_eq_fcn(q_w = q_w, p_w = p_w, c = c, r_w = r_w, f = f) %>% 
    mutate(sc_id = sc_id)
  
  if(i == 1){
    output_weak <- output_w
  }
  else{
    output_weak <- rbind(output_weak, output_w)
  }

}

output_weak_test  <- output_weak %>% 
  rename(scenario_id = sc_id) %>% 
  left_join(weak_scenarios_df, by = "scenario_id") %>% 
  mutate(b_v_k = N_w / 2)


# output_price_range <- output_p_tidy %>% 
#   select(scenario_id, variables, values, stock_prices, prices, price_ratio) %>% 
#   distinct(variables, values, stock_prices, prices, price_ratio, .keep_all = TRUE)

#write_csv(output_weak_test, file = file.path(outdir, "output_weak_test.csv"), col_names = T)
```


## Setting up the time series simulation

$$
\begin{align}
\frac{d N_s}{dt} &= N_st  (r_s  (\frac{1 - N_St}{K_s}) - q_s e_t) \\
\newline
\frac{d N_w}{dt} &= N_wt  (r_w  (\frac{1 - N_wt}{K_w}) - q_w e_t) \\
\newline
\frac{d E}{dt} &= \alpha  E (p_s  q_s  N_st + p_w q_w N_wt - c)
\end{align}
$$

where $q_s$ and $q_w$ are the catchability of the strong and the weak stock, respectively; $r_s$ and $r_w$ are the intrinsic growth rates of the strong and weak stocks, respectively; $p_s$ and $p_w$ are the prices of the strong and weak stocks, respectively; $k_s$ and $k_w$ are the carrying capacities of the strong and weak stocks, respectively; $c$ is the fishing cost, and $\alpha$ is a constant controling for the speed at which effort changes following price changes.

```{r, echo = FALSE}
# set up the parameter space
q_s1 <- 0.1
q_w1 <- 0.15
k_s1 <- 1
k_w1 <- 1
r_s1 <- 1
r_w1 <- 1
p_s1 <- 1
p_w1 <- 1
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu <- NaN*tset; N_w_simu[1] <- N_w

N_s_simu <- NaN*tset; N_s_simu[1] <- N_s

E_simu <- NaN*tset; E_simu[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w <- N_w_simu[i-1]
  N_s <- N_s_simu[i-1]
  E <- E_simu[i-1]
  
  # Calculate change in variable size at each time step
  dN_s <- (N_s * (r_s * (1 - N_s/k_s) - q_s * E)) * dt
  dN_w <- (N_w * (r_w * (1 - N_w/k_w) - q_w * E)) * dt
  dE <- (alpha * E * (p_s * q_s * N_s + p_w * q_w * N_w - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu[i] <- N_w + dN_w
  N_s_simu[i] <- N_s + dN_s
  E_simu[i] <- E + dE
  
}
  

```


```{r, echo = FALSE}
plot(x = tset, y = N_s_simu,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 8),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu,
      type = "l", col = "orange")
lines(x = tset, y = E_simu,
      type = "l", col = "green")
title(title = "First simulation",
      sub = "Params: q_s = 0.1, q_w = 0.15, r_s = 1, r_w = 1, k_s = 1, k_w = 1, p_s = 1, p_w = 1")
legend(x = 80, y = 5,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

```{r, echo = FALSE}
# set up the parameter space
q_s2 <- 0.1
q_w2 <- 0.1
k_s2 <- 2
k_w2 <- 1
r_s2 <- 0.5
r_w2 <- 0.25
p_s2 <- 1
p_w2 <- 5
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu2 <- NaN*tset; N_w_simu2[1] <- N_w

N_s_simu2 <- NaN*tset; N_s_simu2[1] <- N_s

E_simu2 <- NaN*tset; E_simu2[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w2 <- N_w_simu2[i-1]
  N_s2 <- N_s_simu2[i-1]
  E2 <- E_simu2[i-1]
  
  # Calculate change in variable size at each time step
  dN_s2 <- (N_s2 * (r_s2 * (1 - N_s2/k_s2) - q_s2 * E2)) * dt
  dN_w2 <- (N_w2 * (r_w2 * (1 - N_w2/k_w2) - q_w2 * E2)) * dt
  dE2 <- (alpha * E2 * (p_s2 * q_s2 * N_s2 + p_w2 * q_w2 * N_w2 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu2[i] <- N_w2 + dN_w2
  N_s_simu2[i] <- N_s2 + dN_s2
  E_simu2[i] <- E2 + dE2
  
}
  

```


```{r, echo = FALSE}
plot(x = tset, y = N_s_simu2,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 8),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu2,
      type = "l", col = "orange")
lines(x = tset, y = E_simu2,
      type = "l", col = "green")
title(main = "Second simulation",
      sub = "Params: q_s = 0.1, q_w = 0.1, r_s = 0.5, r_w = 0.25, k_s = 2, k_w = 1, p_s = 1, p_w = 5")
legend(x = 80, y = 7.7,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

```{r, echo = FALSE}
# set up the parameter space
q_s3 <- 0.1
q_w3 <- 0.1
k_s3 <- 3
k_w3 <- 1
r_s3 <- 1
r_w3 <- 0.2
p_s3 <- 1
p_w3 <- 10
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu3 <- NaN*tset; N_w_simu3[1] <- N_w

N_s_simu3 <- NaN*tset; N_s_simu3[1] <- N_s

E_simu3 <- NaN*tset; E_simu3[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w3 <- N_w_simu3[i-1]
  N_s3 <- N_s_simu3[i-1]
  E3 <- E_simu3[i-1]
  
  # Calculate change in variable size at each time step
  dN_s3 <- (N_s3 * (r_s3 * (1 - N_s3/k_s3) - q_s3 * E3)) * dt
  dN_w3 <- (N_w3 * (r_w3 * (1 - N_w3/k_w3) - q_w3 * E3)) * dt
  dE3 <- (alpha * E3 * (p_s3 * q_s3 * N_s3 + p_w3 * q_w3 * N_w3 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu3[i] <- N_w3 + dN_w3
  N_s_simu3[i] <- N_s3 + dN_s3
  E_simu3[i] <- E3 + dE3
  
}
  

```


```{r, echo = FALSE}
plot(x = tset, y = N_s_simu3,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 15),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu3,
      type = "l", col = "orange")
lines(x = tset, y = E_simu3,
      type = "l", col = "green")
title(main = "Third simulation",
      sub = "Params: q_s = 0.1, q_w = 0.1, r_s = 1, r_w = 0.2, k_s = 3, k_w = 1, p_s = 1, p_w = 10")
legend(x = 80, y = 14,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

```{r, echo = FALSE}
# set up the parameter space
q_s4 <- 0.1
q_w4 <- 0.1
k_s4 <- 3
k_w4 <- 1
r_s4 <- 1
r_w4 <- 0.2
p_s4 <- 0.1
p_w4 <- 10
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu4 <- NaN*tset; N_w_simu4[1] <- N_w

N_s_simu4 <- NaN*tset; N_s_simu4[1] <- N_s

E_simu4 <- NaN*tset; E_simu4[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w4 <- N_w_simu4[i-1]
  N_s4 <- N_s_simu4[i-1]
  E4 <- E_simu4[i-1]
  
  # Calculate change in variable size at each time step
  dN_s4 <- (N_s4 * (r_s4 * (1 - N_s4/k_s4) - q_s4 * E4)) * dt
  dN_w4 <- (N_w4 * (r_w4 * (1 - N_w4/k_w4) - q_w4 * E4)) * dt
  dE4 <- (alpha * E4 * (p_s4 * q_s4 * N_s4 + p_w4 * q_w4 * N_w4 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu4[i] <- N_w4 + dN_w4
  N_s_simu4[i] <- N_s4 + dN_s4
  E_simu4[i] <- E4 + dE4
  
}
  

```


```{r, echo = FALSE}
plot(x = tset, y = N_s_simu4,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 12),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu4,
      type = "l", col = "orange")
lines(x = tset, y = E_simu4,
      type = "l", col = "green")
title(main = "Fourth simulation",
      sub = "Params: q_s = 0.1, q_w = 0.1, r_s = 1, r_w = 0.2, k_s = 3, k_w = 1, p_s = 0.1, p_w = 10")
legend(x = 80, y = 10,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

















