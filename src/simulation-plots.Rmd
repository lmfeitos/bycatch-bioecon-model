---
title: "simulation-plots"
author: "Leonardo Feitosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
library(tidyverse)
library(here)
library(patchwork)
library(gt)
library(paletteer)
library(gridExtra)
library(janitor)
library(plotly)
library(ggthemes)
library(ggnewscale)
library(RColorBrewer)
# file path
basedir <- "G:/Meu Drive/PhD Project - Fisheries bycatch/Bycatch project/Chapter 1 - Simulation model/analyses/"
outdir <- file.path(basedir, "model_outs") # calls present data from raster files
```

```{r, include = FALSE}
# Results from the parameter per parameter simulations

output_s_ranges_w_one <- read_csv(file.path(outdir, "output_s_ranges_w_one.csv"))

output_w_ranges_s_one <- read_csv(file.path(outdir, "output_w_ranges_s_one.csv"))

output_subs1 <- read_csv(file.path(outdir, "output_sub1.csv"))

output_subs2 <- read_csv(file.path(outdir, "output_sub2.csv"))
```

```{r, echo = FALSE}
# read in the output from the test with prices varying as a function of catch

## pw as a function of catch
# output_fcn_test_pw <- read_csv(file.path(outdir, "output_w_fcn.csv"))
# 
# ## ps as a function of catch
# output_fcn_test_ps <- read_csv(file.path(outdir, "output_s_fcn.csv"))
```


```{r data wrangling, echo = FALSE}
# wrangling dataset with outputs from the test with weak stock price as a function of catch
# output_fcn_test_pw_proc <- output_fcn_test_pw %>% 
#   mutate(b_v_k_s = N_s / k_s,
#          b_v_k_w = N_w / k_w,
#          b_v_k_s2 = N_s2 / k_s,
#          b_v_k_w2 = N_w2 / k_w) %>% 
#   mutate(vuln_ratio_w = (q_w/r_w) / (q_s/r_s)) %>% 
#   mutate(vuln_ratio_s = (q_s/r_s) / (q_w/r_w)) %>% 
#   mutate(vuln_ratio_w = round(vuln_ratio_w, 5),
#          vuln_ratio_s = round(vuln_ratio_s, 5)) %>% 
#   mutate(st_stock_rev = (p_s * q_s * k_s) / c) %>% 
#   mutate(w_stock_rev = (p_w * q_w * k_w) / c)

# wrangling dataset with outputs from the test with strong stock price as a function of catch
s_w_range_proc <- output_s_ranges_w_one %>% 
  mutate(b_v_k_s = N_s / k_s,
         b_v_k_w = N_w / k_w) %>% 
  mutate(vuln_ratio_w = (q_w/r_w) / (q_s/r_s)) %>% 
  mutate(vuln_ratio_w = round(vuln_ratio_w, 5)) %>% 
  mutate(st_stock_rev = (p_s * q_s * k_s) / c) %>% 
  mutate(w_stock_rev = (p_w * q_w * k_w) / c) %>% 
  mutate(c = as.factor(c))

checK <- s_w_range_proc %>% 
  filter(p_w < 1) %>% 
  count(vuln_ratio_w, st_stock_rev)


# wrangling dataset with outputs from the test with strong stock price as a function of catch
w_s_range_proc <- output_w_ranges_s_one %>% 
  mutate(b_v_k_s = N_s / k_s,
         b_v_k_w = N_w / k_w) %>% 
  mutate(vuln_ratio_w = (q_w/r_w) / (q_s/r_s)) %>% 
  mutate(vuln_ratio_w = round(vuln_ratio_w, 5)) %>% 
  mutate(st_stock_rev = (p_s * q_s * k_s) / c) %>% 
  mutate(w_stock_rev = (p_w * q_w * k_w) / c) %>% 
  mutate(c = as.factor(c)) 



# wrangling dataset with outputs from the test with prices constant (strong stock price varying) and cost varying (subsidies)
output_subs1_proc <- output_subs1 %>%  
   mutate(b_v_k_s = N_s / k_s,
         b_v_k_w = N_w / k_w) %>%  
  mutate(vuln_ratio_w = (q_w/r_w) / (q_s/r_s)) %>% 
  mutate(vuln_ratio_w = round(vuln_ratio_w, 5)) %>% 
  mutate(st_stock_rev = (p_s * q_s * k_s) / c) %>% 
  mutate(w_stock_rev = (p_w * q_w * k_w) / c) %>% 
  mutate(c = as.factor(c))

# wrangling dataset with outputs from the test with prices constant (strong stock price varying) and cost varying (subsidies)
output_subs2_proc <- output_subs2 %>%  
   mutate(b_v_k_s = N_s / k_s,
         b_v_k_w = N_w / k_w) %>%  
  mutate(vuln_ratio_w = (q_w/r_w) / (q_s/r_s)) %>% 
  mutate(vuln_ratio_w = round(vuln_ratio_w, 5)) %>% 
  mutate(st_stock_rev = (p_s * q_s * k_s) / c) %>% 
  mutate(w_stock_rev = (p_w * q_w * k_w) / c) %>% 
  mutate(c = as.factor(c))
```


# Results from the parameter per parameter simulation


## Model equations:

- Strong stock size ($N_s$)

$$
\frac{dN_s}{N_wdt} = r_s (1 - \frac{N_s}{K_s}) - q_s E
$$

- Weak stock size ($N_w$):

$$
\frac{dN_w}{N_wdt} = r_w (1 - \frac{N_w}{K_w}) - q_w E
$$

- Effort ($E$):

$$
\frac{dE}{Edt} = (p_s q_s N_s + p_w q_w N_w) - C
$$

## Equilibrium points for the three variables:

- Strong stock ($N_s$):

$$
N_s = \frac{K_s * (c * q_s * r_w + K_w * p_w * q_w * (q_w * r_s - q_s * r_w))} {(K_w * p_w * q_w^2 * r_s + K_s * p_s * q_s^2 * r_w)}
$$

- Weak stock ($N_w$):

$$
N_w = \frac{K_w * (c * q_w * r_s + K_s * p_s * q_s * (- q_w * r_s + q_s * r_w))} {(K_w * p_w * q_w^2 * r_s + K_s * p_s * q_s^2 * r_w)}
$$

- Effort ($E$):

$$
E = \frac{(-c + K_s * p_s * q_s + K_w * p_w * q_w) * r_s * r_w} {K_w * p_w * q_w^2 r_s + K_s * p_s * q_s^2 * r_w}
$$

### List of parameters:
- K = carrying capacity
- r = per capita growth rate
- q = catchability of stocks
- c = cost of fishing
- p = price

### Parameter space for both species:

- Catchability (q) varies from 0.1 to 0.5 at intervals of 0.2 for both species.
- Growth rate (r) varies from 0.35 to 1.05 at intervals of 0.35 for the strong stock and from 0.1 to 0.3 at intervals of 0.1 for the weak stock.
- Carrying capacity (k) varies from 3 to 5 at intervals of 1 for the strong stock and from 1 to 3 at intervals of 1 for the weak stock.
- Price ranges (p) from 0.1 to 10 at intervals of 0.5 for both species.





### First test plot with weak stock having zero price

```{r}
s_w_range_proc_test <-
  s_w_range_proc %>% 
           filter(p_w < 1 & st_stock_rev <= 8 & vuln_ratio_w <= 4) %>% 
  distinct_all() %>% 
  mutate(price_title = case_when(
    p_w < 1 ~ "Weak stock price = 0"))

s_w_range_proc_test_min <-
  s_w_range_proc %>%
  filter(p_w < 1 & st_stock_rev <= 8 & vuln_ratio_w <= 4 & b_v_k_w > 0) %>%  
  distinct_all() %>%
  group_by(st_stock_rev, vuln_ratio_w) %>% 
  summarise(min = min(b_v_k_w)) %>% 
  distinct_at(vars(st_stock_rev, vuln_ratio_w, min)) %>% 
  ungroup() %>% 
  group_by(st_stock_rev) %>% 
  mutate(min_2 = min(min)) %>% 
  distinct_at(vars(st_stock_rev, vuln_ratio_w, min))

s_w_range_proc_test_min2 <-
  s_w_range_proc %>%
  filter(p_w == 1 & st_stock_rev <= 8 & vuln_ratio_w <= 4 & b_v_k_w > 0 & b_v_k_w < 0.001) %>% 
  distinct_all() %>%
  group_by(st_stock_rev, vuln_ratio_w) %>% 
  summarise(min = min(b_v_k_w)) %>%  
  distinct_at(vars(st_stock_rev, vuln_ratio_w, min))
  
```

- Color scale for the fill
Green for B/K > 0.5
Yellow for B/K < 0.375 and > 0.5
Red for B/K < 0.375
```{r}
thresholds <- c(0.5, 0.375, 0.051)
library(geomtextpath)
#s_w_range_proc_plot <-
  ggplot() +
  geom_tile(data = s_w_range_proc_test %>% 
              filter(b_v_k_w >= 0.5),
            aes(x = vuln_ratio_w, y = st_stock_rev, fill = b_v_k_w, width = .1)) +
  scale_fill_brewer(palette = "Greens")
  # scale_fill_paletteer_c("grDevices::Blues 3",
  #                         breaks = seq(0, 0.6, 0.2),
  #                         direction = -1,
  #                         limits = col_limit) +
  scale_x_continuous(breaks = seq(1, 3, 0.5),
                     limits = c(1, 3),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(1, 6, 1),
                     limits = c(1.5, 6),
                     expand = c(0,0)) +
  labs(x = "",
       y = "Strong stock economic potential",
       fill = "Weak stock biomass\n(B/K)") +
#  coord_equal() +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        strip.text = element_text(color = "black", size = 11),
        panel.spacing = unit(3, "mm")) +
  geom_contour(data = subset(s_w_range_proc_test, b_v_k_w > 0),
               aes(x = vuln_ratio_w, y = st_stock_rev, z = b_v_k_w),
               breaks = thresholds[thresholds > 0],
               color = "red",
               linetype = "dashed",
               linewidth = 1)

  
# Plot with added contours
ggplot() +
  geom_tile(data = s_w_range_proc_test,
            aes(x = vuln_ratio_w, y = st_stock_rev, fill = b_v_k_w, width = .1)) +
  facet_wrap(~ factor(price_title)) +
  scale_fill_viridis_c(option = "D",
                       begin = 0.63,
                       end = 0,
                       breaks = c(0.6, 0.5, 0.375, 0.2, 0),
                       labels = c("Above MSY", "At MSY", "Overfished", "Depleted", "Extinct"),
                       limits = col_limit,
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.375)) +
  scale_x_continuous(breaks = seq(1, 3, 0.5),
                     limits = c(1, 3),
                     expand = c(0, 0)) +
  scale_y_continuous(breaks = seq(1, 8, 1),
                     expand = c(0, 0)) +
  labs(x = "",
       y = "Strong stock economic potential",
       fill = "Weak stock biomass\n(B/K)") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        strip.text = element_text(color = "black", size = 11),
        panel.spacing = unit(3, "mm")) +
  # Add contours
  geom_contour(data = s_w_range_proc_test %>% 
                 filter(b_v_k_w > 0) %>% 
                 mutate(label = case_when(
                   b_v_k_w >= 0.5 ~ "MSY",
                   b_v_k_w < 0.5 & b_v_k_w >= 0.375 ~ "Overfished",
                   b_v_k_w < 0.051 ~ "Extinct"
                 )),
               aes(x = vuln_ratio_w, y = st_stock_rev, z = b_v_k_w),
               colour = c("white"), 
               breaks = thresholds[thresholds > 0],
               linetype = "dashed",
               alpha = 0.5,
               linewidth = .8) +
  geom_labelcontour(bins = 3, size = 2, straight = FALSE)
```


```{r, echo = FALSE}
col_limit <- c(0, 0.63)

s_w_range_proc_plot <-
  ggplot() +
  geom_tile(data = s_w_range_proc_test,
            aes(x = vuln_ratio_w, y = st_stock_rev, fill = b_v_k_w, width = .04)) +
  geom_smooth(data = s_w_range_proc_test_min,
             aes(x = vuln_ratio_w, y = st_stock_rev, color = min),
             color = "black",
             se = FALSE,
             linetype = "dashed",
             linewidth = .5) +
  # geom_point(data = s_w_range_proc_test_min %>% 
  #              filter(vuln_ratio_w == 2.08696 & st_stock_rev == 1.92),
  #              aes(x = vuln_ratio_w, y = st_stock_rev, fill = min),
  #            size = 4,
  #            shape = 20,
  #            color = "black") +
  facet_wrap(~ factor(price_title)) +
  scale_fill_paletteer_c("grDevices::Blues 3",
                         breaks = seq(0, 0.6, 0.1),
                         direction = -1,
                         limits = col_limit) +
   scale_x_continuous(breaks = seq(1, 4, 0.5),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(1, 8, 1),
                     expand = c(0,0)) +
  labs(x = "",
       y = "Strong stock economic potential",
       fill = "Weak stock biomass\n(B/K)") +
#  coord_equal() +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        strip.text = element_text(color = "black", size = 11),
        panel.spacing = unit(3, "mm"))

s_w_range_proc_plot2 <-
  ggplot() +
  geom_tile(data = s_w_range_proc %>% 
           filter(p_w == 1 & st_stock_rev <= 8 & vuln_ratio_w <= 4) %>% 
           distinct_all() %>% 
             mutate(price_title = case_when(
               p_w == 1 ~ "Weak stock price = 1"
             )),
           aes(x = vuln_ratio_w, y = st_stock_rev, fill = b_v_k_w, width = .04)) +
  geom_smooth(data = s_w_range_proc_test_min2,
              aes(x = vuln_ratio_w, y = st_stock_rev, color = min),
              color = "black",
              se = FALSE,
              linetype = "dashed",
              linewidth = .5) +
  facet_wrap(~ price_title) +
  scale_fill_paletteer_c("grDevices::Blues 3",
                         breaks = seq(0, 0.6, 0.1),
                         direction = -1,
                         limits = col_limit) +
  scale_x_continuous(breaks = seq(1, 4, 0.5),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(1, 8, 1),
                     expand = c(0,0)) +
  labs(x = "",
       y = "",
       fill = "Weak stock biomass\n(B/K)") +
  #coord_equal() +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        strip.text = element_text(color = "black", size = 11),
        panel.spacing = unit(3, "mm"))


w_s_range_proc_plot1 <-
  ggplot() + 
  geom_tile(data = w_s_range_proc %>%
           filter(p_s == 1 & vuln_ratio_w <= 4) %>% 
           distinct_all() %>% 
             mutate(price_title = case_when(
               p_s == 1 ~ "Strong stock price = 1"
             )),
           aes(x = vuln_ratio_w, y = w_stock_rev, fill = b_v_k_w, width = .04)) +
  geom_vline(xintercept = 2.6,
             color = "black",
             linewidth = .5,
             linetype = "dashed") +
  facet_wrap(~ price_title) +
  scale_fill_paletteer_c("grDevices::Blues 3",
                         # rescaler = ~ scales::rescale_mid(.x, mid = 0.1),
                         breaks = seq(0, 0.6, 0.1),
                         direction = -1,
                         limits = col_limit) +
  scale_x_continuous(breaks = seq(0, 4, 0.5),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 8, 1),
                     expand = c(0,0)) +
  labs(x = "",
       y = "Weak stock economic potential",
       fill = "Weak stock biomass\n(B/K)") +
#  coord_equal() +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        strip.text = element_text(color = "black", size = 11),
        panel.spacing = unit(3, "mm"))
  
w_s_range_proc_plot2 <- 
  ggplot() + 
  geom_tile(data = w_s_range_proc %>% 
           filter(p_s == 2 & vuln_ratio_w <= 4) %>% 
           distinct_all() %>% 
             mutate(price_title = case_when(
               p_s == 2 ~ "Strong stock price = 2"
             )),
           aes(x = vuln_ratio_w, y = w_stock_rev, fill = b_v_k_w, width = .04)) +
  geom_vline(xintercept = 1.4,
             color = "black",
             linewidth = .5,
             linetype = "dashed") +
  facet_wrap(~ price_title) +
  scale_fill_paletteer_c("grDevices::Blues 3",
                         # rescaler = ~ scales::rescale_mid(.x, mid = 0.1),
                         breaks = seq(0, 0.6, 0.1),
                         direction = -1,
                         limits = col_limit) +
  scale_x_continuous(breaks = seq(0, 4, 0.5),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 8, 1),
                     expand = c(0,0)) +
  labs(x = "",
       y = "",
       fill = "Weak stock biomass\n(B/K)") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        strip.text = element_text(color = "black", size = 11),
        panel.spacing = unit(3, "mm"))

```

### Vulnerability ratios vs revenue stream with prices as constants
- in the top plots, $p_w$ = 1
- in the bottom plots, $p_s$ = 1

```{r, fig.height=8, fig.width=12, echo = FALSE}
range_plot_1 <- 
  (s_w_range_proc_plot +
  s_w_range_proc_plot2)  

range_plot_2 <-
  (w_s_range_proc_plot1 +
  w_s_range_proc_plot2) 

plot_1 <- grid.arrange(patchworkGrob(range_plot_1 /
                                       range_plot_2 +
  plot_annotation(tag_levels = "A") +
    plot_layout(guides = "collect")),
  bottom = "Vulnerability ratios\n(Vw/Vs)")
  
#ggsave(file.path(outdir, "plot_1.png"), plot = plot_1,
#      width = 12, height = 8, bg = "white", dpi = 300)
```


```{r, echo = FALSE}
s_w_range_proc %>% 
  mutate(extinct = case_when(
    b_v_k_w == 0 ~ "yes",
    b_v_k_w > 0 ~ "no",
  )) %>% 
  filter(p_w == 1) %>% 
  group_by(extinct) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(prop = n * 100/ sum(n)) %>% 
  mutate(sum = sum(prop))

w_s_range_proc %>% 
  mutate(extinct = case_when(
    b_v_k_w == 0 ~ "yes",
    b_v_k_w > 0 ~ "no",
  )) %>% 
  filter(p_s == 2) %>% 
  group_by(extinct) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(prop = n * 100/ sum(n)) %>% 
  mutate(sum = sum(prop))
```


### Tests for management at MSY for the strong stock

```{r, echo = FALSE}
# msy1_s_proc_plot <-
#   ggplot(data = output_msy1_proc %>% 
#            filter(p_w < 1)) +
#   geom_tile(aes(x = vuln_ratio_w, y = st_stock_rev, fill = log1p(b_v_k_w), width = .1)) +
#   scale_fill_paletteer_c("viridis::viridis",
#                           rescaler = ~ scales::rescale_mid(.x, mid = 0.1),
#                          breaks = seq(0, 0.5, 0.1)) +
#   facet_wrap(~ c,)
#   scale_x_continuous(expand = c(0,0)) +
#   scale_y_continuous(expand = c(0,0)) +
#   labs(x = "Vw/Vs",
#        y = "Strong stock revenue stream",
#        fill = "log(B/K)") +
#   theme_bw() +
#   theme(panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         axis.title = element_text(size = 12, color = "black"),
#         axis.text = element_text(size = 10, color = "black"),
#         strip.background = element_rect(fill = "transparent"),
#         panel.spacing = unit(3, "mm"))
# 
# 
# msy1_s_proc_plot2 <-
#   ggplot(data = output_msy1_proc %>% 
#            filter(p_w == 1)) +
#   geom_tile(aes(x = vuln_ratio_w, y = st_stock_rev, fill = log1p(b_v_k_w), width = .1)) +
#   scale_fill_paletteer_c("viridis::viridis",
#                           rescaler = ~ scales::rescale_mid(.x, mid = 0.1),
#                          breaks = seq(0, 0.35, 0.1)) +
#   scale_x_continuous(expand = c(0,0)) +
#   scale_y_continuous(expand = c(0,0)) +
#   labs(x = "Vw/Vs",
#        y = "Strong stock revenue stream",
#        fill = "log(B/K)") +
#   theme_bw() +
#   theme(panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         axis.title = element_text(size = 12, color = "black"),
#         axis.text = element_text(size = 10, color = "black"),
#         strip.background = element_rect(fill = "transparent"),
#         panel.spacing = unit(3, "mm"))
# 
# 
# msy2_w_proc_plot1 <-
#   ggplot(data = output_msy2_proc %>%
#            filter(p_s == 1)) + 
#   geom_tile(aes(x = vuln_ratio_w, y = w_stock_rev, fill = log1p(b_v_k_w), width = .1)) +
#   scale_fill_paletteer_c("viridis::viridis",
#                           rescaler = ~ scales::rescale_mid(.x, mid = 0.1),
#                          breaks = seq(0, 0.4, 0.1)) +
#   scale_x_continuous(expand = c(0,0)) +
#   scale_y_continuous(expand = c(0,0)) +
#   labs(x = "Vw/Vs",
#        y = "Weak stock revenue stream",
#        fill = "log(B/K)") +
#   theme_bw() +
#   theme(panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         axis.title = element_text(size = 12, color = "black"),
#         axis.text = element_text(size = 10, color = "black"),
#         strip.background = element_rect(fill = "transparent"),
#         panel.spacing = unit(3, "mm"))
#   
# msy2_w_proc_plot2 <- 
#   ggplot(data = output_msy2_proc %>% 
#            filter(p_s == 2)) + 
#   geom_tile(aes(x = vuln_ratio_w, y = w_stock_rev, fill = log1p(b_v_k_w), width = .1)) +
#   scale_fill_paletteer_c("viridis::viridis",
#                           rescaler = ~ scales::rescale_mid(.x, mid = 0.1),
#                          breaks = seq(0, 0.25, 0.05)) +
#   scale_x_continuous(expand = c(0,0)) +
#   scale_y_continuous(expand = c(0,0)) +
#   labs(x = "Vw/Vs",
#        y = "Weak stock revenue stream",
#        fill = "log(B/K)") +
#   theme_bw() +
#   theme(panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         axis.title = element_text(size = 12, color = "black"),
#         axis.text = element_text(size = 10, color = "black"),
#         strip.background = element_rect(fill = "transparent"),
#         panel.spacing = unit(3, "mm"))
```


```{r, echo = FALSE, fig.height=8, fig.width=8}
# msy_plot_1 <- 
#   (msy1_s_proc_plot +
#   msy1_s_proc_plot2)  
# 
# msy_plot_2 <-
#   (msy2_w_proc_plot1 +
#   msy2_w_proc_plot2) 
# 
# msy_gather <-
#   msy_plot_1 / 
#   msy_plot_2 +
#   plot_annotation(tag_levels = "A")
# 
# msy_gather
```

```{r calculate minimum values}
output_subs1_min <- 
  output_subs1_proc %>% 
  filter(p_w == 1 & c == 0.0375 & st_stock_rev <= 12 & vuln_ratio_w <= 4 & b_v_k_w > 0 & b_v_k_w < 0.001) %>% 
  distinct_all() %>% 
  group_by(st_stock_rev, vuln_ratio_w) %>% 
  summarise(min = min(b_v_k_w))

output_subs1_min2 <- 
  output_subs1_proc %>% 
  filter(p_w < 1 & c == 0.0375 & st_stock_rev <= 12 & vuln_ratio_w <= 4 & b_v_k_w > 0 & b_v_k_w < 0.001) %>% 
  distinct_all() %>% 
  group_by(st_stock_rev, vuln_ratio_w) %>% 
  summarise(min = min(b_v_k_w))
```


## Fisheries subsidy analyses

```{r plot first scenario of fishery subsidies where the strong stock price increases and weak stock price remains constabt, echo = FALSE, include = FALSE}
# Create facet labels
sub1_label1 <- c("25% subsidy; Weak stock price = 1")
names(sub1_label1) <- c("0.0375")


col_limit <- c(0, 0.63)


subs1_s_proc_plot2.1 <-
  ggplot(data = output_subs1_proc %>% 
           filter(p_w == 1 & c == 0.0375 & st_stock_rev <= 12 & vuln_ratio_w <= 4)) + 
  geom_tile(aes(x = round(vuln_ratio_w, 8), y = round(st_stock_rev, 8), fill = b_v_k_w, height = 1.2, width = .1)) +
  scale_fill_paletteer_c("grDevices::Blues 3",
                         direction = -1,
                         limits = col_limit,
                         breaks = seq(0, 0.6, 0.1)) +
  geom_smooth(data = output_subs1_min,
              aes(x = vuln_ratio_w, y = st_stock_rev, color = min),
              color = "black",
              se = FALSE,
              linetype = "dashed",
              linewidth = .5) +
  facet_wrap(~ c,
             nrow = 1,
             scales = "free_y",
             labeller = labeller(c = sub1_label1)) +
  scale_x_continuous(breaks = seq(1, 4, .5),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 12, 2),
                     expand = c(0,0)) +
  labs(x = "",
       y = "",
       fill = "Weak stock biomass\n(B/K)") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        strip.text = element_text(color = "black", size = 11),
        panel.spacing = unit(3, "mm"))

```

- 0.045 = 10% subsidy
- 0.0375 = 25% subsidy
- 0.025 = 50% subsidy

```{r, echo = FALSE, include = FALSE}
s_w_range_proc_test0 <- s_w_range_proc %>% 
  mutate(extinct = case_when(
    b_v_k_w == 0 ~ "yes",
    b_v_k_w > 0 ~ "no",
  )) %>% 
  filter(p_w < 1 & extinct == "yes")  

  
output_subs1_proc_test0 <- output_subs1_proc %>% 
  mutate(extinct = case_when(
    b_v_k_w == 0 ~ "yes",
    b_v_k_w > 0 ~ "no",
  )) %>% 
  filter(p_w < 1 & c == 0.0375 & extinct == "yes")
  
s_w_range_proc_test1 <- s_w_range_proc %>% 
  mutate(extinct = case_when(
    b_v_k_w == 0 ~ "yes",
    b_v_k_w > 0 ~ "no",
  )) %>% 
  filter(p_w == 1 & extinct == "yes")  

  
output_subs1_proc_test1 <- output_subs1_proc %>% 
  mutate(extinct = case_when(
    b_v_k_w == 0 ~ "yes",
    b_v_k_w > 0 ~ "no",
  )) %>% 
  filter(p_w == 1 & c == 0.0375 & extinct == "yes")
```

```{r calculating elasticities of subsidies on vulnerability ratios}
min_vw_sw_range0 = 2.6667
min_vw_sub1_test0 = 1.88235

cost_full = 0.05
cost_sub = 0.0375

# Elasticity following the mid-point formula:
## deltaQ = Q2 - Q1 / (Q2 + Q1) / 2 * 100
## deltaP = P2 - P1 / (P2 + P1) / 2 * 100
## deltaQ / deltaP

## Vulnerability elasticity:
e_vuln0 <- (min_vw_sub1_test0 - min_vw_sw_range0)/ (min_vw_sub1_test0 + min_vw_sw_range0) / 2

e_vuln0_pct <- e_vuln0 * 100

## Subsidy elasticity
e_sub0 <- (cost_sub - cost_full) /  (cost_sub + cost_full)/ 2

e_sub0_pct <- e_sub0 * 100

elas0_final <- e_vuln0_pct/e_sub0_pct
elas0_final # 1.206944%
```


```{r}
s_w_range_proc_test %>% 
  ggplot() +
  geom_tile(aes(x = round(vuln_ratio_w, 8), y = round(st_stock_rev, 8), fill = b_v_k_w, height = 1.2, width = .1))

output_subs1_proc_test %>% 
  ggplot() +
  geom_tile(aes(x = round(vuln_ratio_w, 8), y = round(st_stock_rev, 8), fill = b_v_k_w, height = 1.2, width = .1))
```


```{r, echo = FALSE, include = FALSE}
sub1_label2 <- c("25% subsidy; Weak stock price = 0")
names(sub1_label2) <- c("0.0375")

subs2_s_proc_plot2.1 <-
  ggplot(data = output_subs1_proc %>% 
           filter(p_w < 1 & c == 0.0375 & vuln_ratio_w <= 4 & st_stock_rev <= 12)) + 
  geom_tile(aes(x = round(vuln_ratio_w, 8), y = round(st_stock_rev, 8), fill = b_v_k_w, height = 1.2, width = .1)) +
  geom_smooth(data = output_subs1_min2,
              aes(x = vuln_ratio_w, y = st_stock_rev, color = min),
              color = "black",
              se = FALSE,
              linetype = "dashed",
              linewidth = .5) +
  scale_fill_paletteer_c("grDevices::Blues 3",
                         direction = -1,
                         limits = col_limit,
                         breaks = seq(0, .6, .1)) +
  facet_wrap(~ c,
             nrow = 1,
             scales = "free_y",
             labeller = labeller(c = sub1_label2)) +
  scale_x_continuous(breaks = seq(1, 4, .5),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 12, 2),
                     expand = c(0,0)) +
  labs(x = "",
       y = "Strong stock revenue potential",
       fill = "Weak stock biomass\n(B/K)") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        strip.text = element_text(color = "black", size = 11),
        panel.spacing = unit(3, "mm"))

```



```{r plot second scenario of fishery subsidies where the weak stock price increases and strong stock price remains constabt, echo = FALSE, include = FALSE}
# Create facet labels
sub1_label_ps1 <- c("25% subsidy; Strong stock price = 1")
names(sub1_label_ps1) <- c("0.0375")


# Create plots for a smaller range of Vw/Vs
subs1_w_proc_plot2.1 <-
  ggplot(data = output_subs2_proc %>% 
           filter(p_s == 1 & c == 0.0375  & vuln_ratio_w <= 4)) + 
  geom_tile(aes(x = round(vuln_ratio_w, 8), y = round(w_stock_rev, 8), fill = b_v_k_w, height = 1.2, width = .1)) +
  scale_fill_paletteer_c("grDevices::Blues 3",
                         direction = -1,
                         limits = col_limit, 
                         breaks = seq(0, .6, .1)) +
  geom_vline(xintercept = 1.9,
             color = "black",
             size = .5,
             linetype = "dashed") +
  facet_wrap(~ c,
             nrow = 1,
             scales = "free_y",
             labeller = labeller(c = sub1_label_ps1)) +
  scale_x_continuous(breaks = seq(1, 4, .5),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 12, 2),
                     expand = c(0,0)) +
  labs(x = "",
       y = "Weak stock revenue potential",
       fill = "Weak stock biomass\n(B/K)") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),,
        strip.text = element_text(color = "black", size = 11),
        panel.spacing = unit(3, "mm"))
```

- 0.045 = 10% subsidy
- 0.0375 = 25% subsidy
- 0.025 = 50% subsidy


```{r, echo = FALSE, include = FALSE}
# Create series of plots for pw = 0.1 with full range of vulnerabilities
sub1_label_ps2 <- c("25% subsidy; Strong stock price = 2")
names(sub1_label_ps2) <- c("0.0375")

# Create series of plots for pw = 0.1 with vulnerabilities ranging from 1 to 4

subs2_w_proc_plot2.1 <-
  ggplot(data = output_subs2_proc %>% 
           filter(p_s == 2 & c == 0.0375 & vuln_ratio_w <= 4)) + 
  geom_tile(aes(x = round(vuln_ratio_w, 8), y = round(w_stock_rev, 8), fill = b_v_k_w, height = 1.2, width = .1)) +
  scale_fill_paletteer_c("grDevices::Blues 3",
                         direction = -1,
                         limits = col_limit,
                         breaks = seq(0, .6, .1)) +
  geom_vline(xintercept = 1.3,
             size = .5,
             color = "black",
             linetype = "dashed") +
  facet_wrap(~ c,
             nrow = 1,
             scales = "free_y",
             labeller = labeller(c = sub1_label_ps2)) +
  scale_x_continuous(breaks = seq(1, 4, .5),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 12, 2),
                     expand = c(0,0)) +
  labs(x = "",
       y = "",
       fill = "Weak stock biomass\n(B/K)") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        strip.text = element_text(color = "black", size = 11),
        panel.spacing = unit(3, "mm"))
```

```{r, fig.height=8, fig.width=8}
sub_plot_25pct <- grid.arrange(patchworkGrob(subs2_s_proc_plot2.1 / 
                                               subs1_s_proc_plot2.1 /
                                               subs1_w_proc_plot2.1 /
                                               subs2_w_proc_plot2.1 +
                                plot_layout(ncol = 2,
                                            guides = "collect") +
                                  plot_annotation(tag_levels = "A")),
                               bottom = "Vulnerability ratios\n(Vw/Vs)")

#ggsave(file.path(outdir, "sub_plot_25pct.png"), plot = sub_plot_25pct,
#     width = 12, height = 8, bg = "white", dpi = 300)
```

```{r, echo = FALSE}
w_s_range_proc_test1 <- w_s_range_proc %>% 
  mutate(extinct = case_when(
    b_v_k_w == 0 ~ "yes",
    b_v_k_w > 0 ~ "no",
  )) %>% 
  filter(p_s == 1 & extinct == "yes")

w_s_range_proc_test2 <- w_s_range_proc %>% 
  mutate(extinct = case_when(
    b_v_k_w == 0 ~ "yes",
    b_v_k_w > 0 ~ "no",
  )) %>% 
  filter(p_s == 2 & extinct == "yes")

output_subs2_proc_test1 <- output_subs2_proc %>% 
  mutate(extinct = case_when(
    b_v_k_w == 0 ~ "yes",
    b_v_k_w > 0 ~ "no",
  )) %>% 
  filter(p_s == 1 & c == 0.0375 & extinct == "yes")

output_subs2_proc_test2 <- output_subs2_proc %>% 
  mutate(extinct = case_when(
    b_v_k_w == 0 ~ "yes",
    b_v_k_w > 0 ~ "no",
  )) %>% 
  filter(p_s == 2 & c == 0.0375 & extinct == "yes")

```

```{r calculating elasticities of subsidies on vulnerability ratios for non-synergistic scenarios}
min_vw_ws_range2 = 1.45455
min_vw_sub1_test2 = 1.30612

cost_full = 0.05
cost_sub = 0.0375

# Elasticity following the mid-point formula:
## deltaQ = Q2 - Q1 / (Q2 + Q1) / 2 * 100
## deltaP = P2 - P1 / (P2 + P1) / 2 * 100
## deltaQ / deltaP

## Vulnerability elasticity:
e_vuln2 <- (min_vw_sub1_test2 - min_vw_ws_range2)/ (min_vw_sub1_test2 + min_vw_ws_range2) / 2

e_vuln2_pct <- e_vuln2 * 100

## Subsidy elasticity
e_sub2 <- (cost_sub - cost_full) /  (cost_sub + cost_full)/ 2

e_sub2_pct <- e_sub2 * 100

elas2_final <- e_vuln2_pct/e_sub2_pct
elas2_final # 0.3763%
```

```{r}
# average elasticity of subsidies
elas_ave <- (elas0_final + elas2_final)/2
elas_ave
```


```{r, echo = FALSE, include = FALSE}
#msy1_w_proc_plot1 <-
  ggplot(data = output_msy1_proc %>%
           filter(p_w < 1 & vuln_ratio_w <= 3)) + 
  geom_tile(aes(x = vuln_ratio_w, y = st_stock_rev, fill = log1p(b_v_k_w), width = .1)) +
  scale_fill_paletteer_c("viridis::viridis",
                          rescaler = ~ scales::rescale_mid(.x, mid = 0.1),
                         breaks = seq(0, 0.4, 0.1)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(x = "Vw/Vs",
       y = "Strong stock revenue stream",
       fill = "log(B/K)") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        panel.spacing = unit(3, "mm"))
  
msy1_w_proc_plot2 <- 
  ggplot(data = output_msy1_proc %>% 
           filter(p_w == 1)) + 
  geom_tile(aes(x = vuln_ratio_w, y = st_stock_rev, fill = log1p(b_v_k_w), width = .1)) +
  scale_fill_paletteer_c("viridis::viridis",
                          rescaler = ~ scales::rescale_mid(.x, mid = 0.1)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(x = "Vw/Vs",
       y = "Strong stock revenue stream",
       fill = "log(B/K)") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        panel.spacing = unit(3, "mm"))

#msy2_w_proc_plot1 <-
  ggplot(data = output_msy2_proc %>%
           filter(p_s == 1)) + 
  geom_tile(aes(x = vuln_ratio_w, y = w_stock_rev, fill = log1p(b_v_k_w), width = .1)) +
  scale_fill_paletteer_c("viridis::viridis",
                          rescaler = ~ scales::rescale_mid(.x, mid = 0.1),
                         breaks = seq(0, 0.4, 0.1)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(x = "Vw/Vs",
       y = "Weak stock revenue stream",
       fill = "log(B/K)") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        panel.spacing = unit(3, "mm"))
  
msy2_w_proc_plot2 <- 
  ggplot(data = output_msy2_proc %>% 
           filter(p_s == 2)) + 
  geom_tile(aes(x = vuln_ratio_w, y = w_stock_rev, fill = log1p(b_v_k_w), width = .1)) +
  scale_fill_paletteer_c("viridis::viridis",
                          rescaler = ~ scales::rescale_mid(.x, mid = 0.1),
                         breaks = seq(0, 0.25, 0.05)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(x = "Vw/Vs",
       y = "Weak stock revenue stream",
       fill = "log(B/K)") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 12, color = "black"),
        axis.text = element_text(size = 10, color = "black"),
        strip.background = element_rect(fill = "transparent"),
        panel.spacing = unit(3, "mm"))
```




