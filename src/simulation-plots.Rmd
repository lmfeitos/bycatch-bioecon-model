---
title: "simulation-plots"
author: "Leonardo Feitosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
library(tidyverse)
library(here)
library(patchwork)
library(kableExtra)
library(paletteer)

# file path
basedir <- "G:/Meu Drive/PhD Project - Fisheries bycatch/Bycatch project/Chapter 1/analyses/"
outdir <- file.path(basedir, "model_outs") # calls present data from raster files
```

```{r, include = FALSE}
# Results from the parameter per parameter simulations
#output_price_ranges <- read_csv(file.path(outdir, "output_price_ranges.csv"))

#output_growth_ranges <- read_csv(file.path(outdir, "output_r_ranges.csv"))

#output_q_ranges <- read_csv(file.path(outdir, "output_q_ranges.csv"))

#output_full <- read_csv(file.path(outdir, "output_full.csv"))
```

```{r}
# Updated dataset to be used in the analyses
output_test <- read_csv(file.path(outdir, "output_ranges_test.csv"))  

output_test_updated <- output_test %>% 
  pivot_wider(names_from = "variables",
              values_from = "values") %>% 
  mutate(b_values_s = N_s / k_s,
         b_values_w = N_w / k_w) %>% 
  pivot_longer(cols = e:N_w,
               names_to = "variables",
               values_to = "values") %>% 
  pivot_longer(cols = starts_with("b_values"),
               names_to = "b_stocks",
               values_to = "b_v_k") %>% 
  mutate(vuln_ratio = (q_s/r_s) / (q_w/r_w)) %>%
  mutate(vuln_ratio_2 = (q_w/r_w) / (q_s/r_s)) %>%
  mutate(vuln_ratio_3 = q_s/r_s / q_w/r_w) %>% 
  mutate(vuln_ratio_4 = r_s / r_w)
```

```{r, echo = FALSE}
head(output_test_updated, n = 20) %>% 
  kable(caption = "Glimpse of the first 20 rows of the dataset") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```


# Results from the parameter per parameter simulation



```{r, include = FALSE}
# output_price_ranges %>%
#   pivot_wider(names_from = "stock_prices",
#               values_from = "prices") %>% 
#   filter(variables %in% c("N_w", "N_s")) %>% 
#   ggplot() +
#   geom_raster(aes(x = p_w, y = p_s, fill = values)) +
#   facet_wrap(~ variables) +
#   scale_fill_gradientn(name = "Weak stock size", 
#                        colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   scale_x_continuous(breaks = seq(0, 10, 1)) +
#   scale_y_continuous(breaks = seq(0, 10, 1)) +
#   labs(x = "Weak stock price range",
#        y = "Strong stock price range",
#        title = "Simulation of price ranges on variable size") +
#   theme_bw() 
```

```{r, include = FALSE}
# output_price_ranges %>%
#   pivot_wider(names_from = "stock_prices",
#               values_from = "prices") %>% 
#   filter(variables %in% c("N_w", "N_s")) %>% 
#   ggplot() +
#   geom_raster(aes(x = p_w, y = p_s, fill = values)) +
#   facet_wrap(~ variables) +
#   scale_fill_gradientn(name = "Weak stock size", 
#                        colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   scale_x_continuous(breaks = seq(0, 10, 1)) +
#   scale_y_continuous(breaks = seq(0, 10, 1)) +
#   labs(x = "Weak stock price range",
#        y = "Strong stock price range",
#        title = "Simulation of price ranges on variable size") +
#   theme_bw() 
```




```{r, include = FALSE}
# output_price_ranges %>%
#   pivot_wider(names_from = "stock_prices",
#               values_from = "prices") %>% 
#   ggplot() +
#   geom_raster(aes(x = p_w, y = p_s, fill = values)) +
#   facet_wrap(~ variables) +
#   scale_fill_gradientn(name = "Weak stock size", 
#                        colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   scale_x_continuous(breaks = seq(0, 10, 1)) +
#   scale_y_continuous(breaks = seq(0, 10, 1)) +
#   labs(x = "Weak stock price range",
#        y = "Strong stock price range",
#        title = "Simulation of price ranges on variable size") +
#   theme_bw() +
#   theme(panel.spacing = unit(4, "mm"))
```



```{r, include = FALSE}
# output_q_ranges %>%   
#   pivot_wider(names_from = "stock_q",
#               values_from = "q") %>%  
#   ggplot() +
#   geom_raster(aes(x = q_w, y = q_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock q ranges",
#        y = "Strong stock q ranges",
#        title = "Simulation of catchability ranges on stock size") +
#   theme_bw() 
```



```{r, include = FALSE}
# output_full %>% 
#   filter(variables %in% c("N_w", "N_s")) %>% 
#   pivot_longer(cols = starts_with("values_"),
#                names_to = "parameter",
#                values_to = "values") %>%  
#   filter(parameter == "values_price") %>% 
#   ggplot() +
#   geom_point(aes(x = price_ratio, y = log(prod_ratio + 1), color = values),
#              alpha = 0.6) +
#   scale_color_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(5, "YlOrRd")) +
#   labs(x = "Price ratio (p_s/p_w)",
#        y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
#        title = "Simulation of the distribution of productivity and price ratios") +
#   theme_bw()
```

## Model equations:

- Strong stock size ($N_s$):

$$
N_s = \frac{K_s * (c * q_s * r_w + K_w * p_w * q_w * (q_w * r_s - q_s * r_w))} {(K_w * p_w * q_w^2 * r_s + K_s * p_s * q_s^2 * r_w)}
$$

- Weak stock size ($N_w$):

$$
N_w = \frac{K_w * (c * q_w * r_s + K_s * p_s * q_s * (- q_w * r_s + q_s * r_w))} {(K_w * p_w * q_w^2 * r_s + K_s * p_s * q_s^2 * r_w)}
$$

- Effort ($e$):

$$
e = \frac{(-c + K_s * p_s * q_s + K_w * p_w * q_w) * r_s * r_w} {K_w * p_w * q_w^2 r_s + K_s * p_s * q_s^2 * r_w}
$$

### List of parameters:
- K = carrying capacity
- r = per capita growth rate
- q = catchability of stocks
- c = cost of fishing
- p = price

### Parameter space for both species:

- Catchability (q) varies from 0.1 to 0.5 at intervals of 0.2 for both species.
- Growth rate (r) varies from 0.35 to 1.05 at intervals of 0.35 for the strong stock and from 0.1 to 0.3 at intervals of 0.1 for the weak stock.
- Carrying capacity (k) varies from 3 to 5 at intervals of 1 for the strong stock and from 1 to 3 at intervals of 1 for the weak stock.
- Price ranges (p) from 0.1 to 10 at intervals of 0.5 for both species.


### Distribution of variable values

```{r, echo = FALSE, message = FALSE}
out_full <- 
  output_test_updated %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = values, fill = variables),
                 show.legend = F) +
  facet_wrap(~ variables,
             scales = "free") +
  labs(title = "Full dataset") +
  theme_bw()
```

```{r, echo = FALSE}
out_transf <- 
  output_test_updated %>%
  filter(variables %in% c("N_w", "N_s")) %>% 
  mutate(values = case_when(
    values < 0 ~ 0,
    TRUE ~ values
  )) %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = values, fill = variables),
                 show.legend = F) +
  facet_wrap(~ variables,
             scales = "free") +
  labs(title = "Negative values transformed to zero") +
  theme_bw()
```

```{r, echo = FALSE}
out_pos <- 
  output_test_updated %>%
  filter(values >= 0) %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = values, fill = variables),
                 show.legend = F) +
  facet_wrap(~ variables,
             scales = "free") +
  labs(title = "Negative values filtered out") +
  theme_bw()
```


```{r, fig.height=9, fig.width=9, echo = FALSE}
out_full / 
  (out_transf + out_pos) +
  plot_annotation(title = "Distribution of Equilibria")
```

```{r, echo = FALSE}
out_full_bvk <- 
  output_test_updated %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = b_v_k, fill = b_stocks),
                 show.legend = F) +
  facet_wrap(~ b_stocks,
             scales = "free") +
  labs(title = "Full dataset") +
  theme_bw()
```

```{r, echo = FALSE}
out_transf_bvk <- 
  output_test_updated %>%
  filter(variables %in% c("N_w", "N_s")) %>% 
  mutate(b_v_k = case_when(
    b_v_k < 0 ~ 0,
    TRUE ~ b_v_k
  )) %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = b_v_k, fill = b_stocks),
                 show.legend = F) +
  facet_wrap(~ b_stocks,
             scales = "free") +
  labs(title = "Negative values transformed to zero") +
  theme_bw()
```

```{r, echo = FALSE}
out_pos_bvk <- 
  output_test_updated %>%
  filter(b_v_k >= 0) %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = b_v_k, fill = b_stocks),
                 show.legend = F) +
  facet_wrap(~ b_stocks,
             scales = "free") +
  labs(title = "Negative values filtered out") +
  theme_bw()
```


```{r, fig.height=9, fig.width=9, echo = FALSE}
out_full_bvk / 
  (out_transf_bvk + out_pos_bvk) +
  plot_annotation(title = "Distribution of Equilibria for B/K ratios")
```



### Catchability range simulation


```{r, echo = FALSE}
# New tests with the other parameters also being varied

# output_test_updated %>% 
#   pivot_wider(names_from = "variables",
#               values_from = "values") %>% 
#   mutate(b_values_s = N_s / k_s,
#          b_values_w = N_w / k_w) %>% 
#   pivot_longer(cols = e:N_w,
#                names_to = "variables",
#                values_to = "values") %>% 
#   filter(values >= 0) %>% 
#   ggplot() +
#   geom_raster(aes(x = q_w, y = q_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Variable size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock q ranges",
#        y = "Strong stock q ranges",
#        title = "Simulation of catchability ranges on variable size") +
#   theme_bw()
```


```{r, echo = FALSE}
# output_test_updated %>% 
#   filter(variables %in% c("N_w", "N_s")) %>% 
#   mutate(values = case_when(
#     values < 0 ~ 0,
#     TRUE ~ values
#   )) %>% 
#   ggplot() +
#   geom_raster(aes(x = q_w, y = q_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock q ranges",
#        y = "Strong stock q ranges",
#        title = "Simulation of catchability ranges on stock size") +
#   theme_bw()
```

```{r, echo = FALSE}
w_s_q <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w") %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = b_v_k)) +
  #facet_grid(b_stocks ~ variables) + 
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
s_s_q <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s") %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = b_v_k)) +
  #facet_grid(b_stocks ~ variables) + 
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, fig.width=8, echo = FALSE}
s_s_q + w_s_q +
  plot_annotation(title = "Simulation of catchability ranges on strong and weak stock's B/K ratio - All values")
```


```{r, echo = FALSE}
s_s_q_pos <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = b_v_k)) +
#  facet_wrap(~ variables) + 
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
w_s_q_pos <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = b_v_k)) +
#  facet_wrap(~ variables) + 
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
s_s_q_pos + w_s_q_pos +
  plot_annotation(title = "Simulation of catchability ranges on B/K ratio - Negative values filtered out")
```


### Price range simulation

```{r, echo = FALSE}
# output_test %>% 
#   filter(values >= 0) %>% 
#   ggplot() +
#   geom_raster(aes(x = p_w, y = p_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Variable size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock price ranges",
#        y = "Strong stock price ranges",
#        title = "Simulation of price ranges on variable size") +
#   theme_bw()
```


```{r, echo = FALSE}
ss_p <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s") %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock price ranges",
       y = "Strong stock price ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ws_p <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w") %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock price ranges",
       y = "Strong stock price ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ss_p + ws_p +
  plot_annotation(title = "Simulation of price ranges on strong and weak stock's B/K ratio - All values")
```


```{r, echo = FALSE}
ss_p_pos <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock price ranges",
       y = "Strong stock price ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ws_p_pos <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock price ranges",
       y = "Strong stock price ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ss_p_pos + ws_p_pos +
  plot_annotation(title = "Simulation of price ranges on strong and weak stock's B/K ratio - Positive values")
```

### Growth range simulation

```{r, echo = FALSE}
# output_test %>% 
#   filter(values >= 0) %>% 
#   ggplot() +
#   geom_raster(aes(x = r_w, y = r_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Variable size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock growth ranges",
#        y = "Strong stock growth ranges",
#        title = "Simulation of growth ranges on variable size") +
#   theme_bw()
```


```{r, echo = FALSE}
# output_test %>% 
#   filter(values >= 0 & variables %in% c("N_w", "N_s")) %>% 
#   ggplot() +
#   geom_raster(aes(x = r_w, y = r_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock growth ranges",
#        y = "Strong stock growth ranges",
#        title = "Simulation of growth ranges on stock size") +
#   theme_bw()
```

```{r, echo = FALSE}
ss_p <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s") %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock growth ranges",
       y = "Strong stock growth ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ws_p <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w") %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock growth ranges",
       y = "Strong stock growth ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ss_p + ws_p +
  plot_annotation(title = "Simulation of growth ranges on strong and weak stock's B/K ratio - All values")
```


```{r, echo = FALSE}
ss_r_pos <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock growth ranges",
       y = "Strong stock growth ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ws_r_pos <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock growth ranges",
       y = "Strong stock growth ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ss_r_pos + ws_r_pos +
  plot_annotation(title = "Simulation of growth ranges on strong and weak stock's B/K ratio - Positive values")
```

### Carrying capacity range simulation

```{r, echo = FALSE}
# output_test %>% 
#   filter(values >= 0) %>% 
#   ggplot() +
#   geom_raster(aes(x = k_w, y = k_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Variable size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock K ranges",
#        y = "Strong stock K ranges",
#        title = "Simulation of K ranges on variable size") +
#   theme_bw()
```


```{r, echo = FALSE}
# output_test %>% 
#   filter(values >= 0 & variables %in% c("N_w", "N_s")) %>% 
#   ggplot() +
#   geom_raster(aes(x = k_w, y = k_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   labs(x = "Weak stock K ranges",
#        y = "Strong stock K ranges",
#        title = "Simulation of K ranges on stock size") +
#   theme_bw()
```

```{r, echo = FALSE}
ss_k <- 
  output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s") %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock K ranges",
       y = "Strong stock K ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ws_k <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w") %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock K ranges",
       y = "Strong stock K ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ss_k + ws_k +
  plot_annotation(title = "Simulation of K ranges on strong and weak stock's B/K ratio - All values")
```



```{r, echo = FALSE}
ss_k_pos <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock K ranges",
       y = "Strong stock K ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ws_k_pos <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock K ranges",
       y = "Strong stock K ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```


```{r, echo = FALSE}
ss_k_pos + ws_k_pos +
  plot_annotation(title = "Simulation of K ranges on B/K ratio - Negative values filtered out")
```


### Price ratio vs Vulnerability test

```{r, echo = FALSE}
# vul_full <- 
#   output_test %>% 
#   filter(variables %in% c("N_w", "N_s")) %>% 
#   mutate(prod_ratio = (q_s/r_s) / (q_w/r_w)) %>% 
#   ggplot() +
#   geom_point(aes(x = price_ratio, y = prod_ratio, color = values)) +
#   scale_color_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(5, "YlOrRd")) +
#   labs(x = "Price ratio (p_s/p_w)",
#        y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
#        title = "All values") +
#   theme_bw()
```

```{r, echo = FALSE}
# vul_pos <- 
#   output_test %>% 
#   filter(variables %in% c("N_w", "N_s") & values >= 0) %>% 
#   mutate(prod_ratio = (q_s/r_s) / (q_w/r_w)) %>% 
#   ggplot() +
#   geom_point(aes(x = price_ratio, y = prod_ratio, color = values)) +
#   scale_color_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(5, "YlOrRd")) +
#   labs(x = "Price ratio (p_s/p_w)",
#        y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
#        title = "Only positive values") +
#   theme_bw()
```

```{r, echo = FALSE}
# vul_neg <- 
#   output_test %>% 
#   filter(variables %in% c("N_w", "N_s") & values <= 0) %>% 
#   mutate(prod_ratio = (q_s/r_s) / (q_w/r_w)) %>% 
#   ggplot() +
#   geom_point(aes(x = price_ratio, y = prod_ratio, color = values)) +
#   scale_color_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(5, "YlOrRd"),
#                         breaks = seq(-60, 0, 10)) +
#   labs(x = "Price ratio (p_s/p_w)",
#        y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
#        title = "Only negative values") +
#   theme_bw()
```


```{r, fig.height = 10, fig.width=9, echo = FALSE}
# (vul_neg + vul_pos) /
#   vul_full +
#   plot_annotation(title = "Simulation of the distribution of vulnerability and price ratios")
```

```{r, echo = FALSE}
vul_s <- 
  output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s") %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = vuln_ratio, color = b_v_k)) +
  scale_color_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Price ratio",
       y = "Vulnerability ratio",
       title = "Strong stock",
       color = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
vul_w <- 
  output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w") %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = vuln_ratio, color = b_v_k)) +
  scale_color_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Price ratio",
       y = "Vulnerability ratio",
       title = "Weak stock",
       color = "B/K") +
  theme_bw()
```

```{r, echo = FALSE, fig.height=9, fig.width=8}
vul_s + vul_w +
  plot_annotation(title = "Price vs vulnerability ratios for strong and weak stocks - All B/K values",
                  caption = "Price ratio = p_s / p_w \n Vulnerability ratio = (q_s/r_s) / (q_w/r_w)")
```

```{r, echo = FALSE}
vul_pos_s <- 
  output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s" & b_v_k >= 0) %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = vuln_ratio, color = b_v_k)) +
  scale_color_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Price ratio",
       y = "Vulnerability ratio",
       title = "Strong stock",
       color = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
vul_pos_w <- 
  output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k >= 0) %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = vuln_ratio, color = b_v_k)) +
  scale_color_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Price ratio",
       y = "Vulnerability ratio",
       title = "Weak stock",
       color = "B/K") +
  theme_bw()
```

```{r, echo = FALSE, fig.width=9, fig.height=6}
vul_pos_s + vul_pos_w +
  plot_annotation(title = "Price vs vulnerability ratios for strong and weak stocks - Positive B/K values",
                  caption = "Price ratio = p_s / p_w \n Vulnerability ratio = (q_s/r_s) / (q_w/r_w)")
```

- When transforming the negative values of B/K into zeros, we get the following plot:

```{r, echo = FALSE}
output_test_updated %>% 
  mutate(b_v_k = case_when(
    b_v_k < 0 ~ 0,
    TRUE ~ b_v_k
  )) %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k >= 0) %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = vuln_ratio, color = b_v_k),
             alpha = 0.2) +
  scale_color_paletteer_c("viridis::plasma",
                          rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Price ratio",
       y = "Vulnerability ratio",
       title = "Weak stock - values above 1 filtered out",
       color = "B/K") +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.title = element_text(size = 10, color = "black"),
        axis.text = element_text(size = 10, color = "black"))
```


```{r, echo = FALSE}
test <- output_test_updated %>% 
  filter(q_s == 0.1 & q_w == 0.1) %>% 
  mutate(vuln_ratio = (q_s/r_s) / (q_w / r_w))

ws_test <- test %>% 
   mutate(b_v_k = case_when(
     b_v_k < 0 ~ 0,
     TRUE ~ b_v_k
   )) %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k <= 1) %>% 
  ggplot() +
  geom_point(aes(x = log1p(price_ratio), y = vuln_ratio, color = b_v_k),
             alpha = 0.2) +
  scale_color_paletteer_c("viridis::plasma",
                          rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Log(1 + price ratio)",
       y = "Vulnerability ratio",
       title = "Weak stock",
       color = "B/K") +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.title = element_text(size = 10, color = "black"),
        axis.text = element_text(size = 10, color = "black"))
```

```{r, echo = FALSE}
ss_test <- test %>% 
   mutate(b_v_k = case_when(
     b_v_k < 0 ~ 0,
     TRUE ~ b_v_k
   )) %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s" & b_v_k <= 1) %>% 
  ggplot() +
  geom_point(aes(x = log1p(price_ratio), y = vuln_ratio, color = b_v_k),
             alpha = 0.2) +
  scale_color_paletteer_c("viridis::plasma",
                          rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Log(1 + price ratio)",
       y = "Vulnerability ratio",
       title = "Strong stock",
       color = "B/K") +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.title = element_text(size = 10, color = "black"),
        axis.text = element_text(size = 10, color = "black"))
```

```{r, echo = FALSE, fig.height=5, fig.width=8}
ss_test + ws_test +
  plot_annotation(title = "Price vs vulnerability ratios for strong and weak stocks - B/K values above 1 filtered out")
```

```{r, echo = FALSE, include = FALSE}
test <- output_test_updated %>% 
  filter(q_s == 0.1 & q_w == 0.1) %>% 
  pivot_wider(names_from = "variables",
              values_from = "values") %>% 
  mutate(vuln_ratio_test = (q_s * e/ r_s * N_s) / (q_w * e/ r_w * N_w)) %>% 
  pivot_longer(cols = e:N_w,
               names_to = "variables",
               values_to = "values")

test %>% 
   mutate(b_v_k = case_when(
     b_v_k < 0 ~ 0,
     TRUE ~ b_v_k
   )) %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s" & b_v_k <= 1) %>% 
  ggplot() +
  geom_point(aes(x = log1p(price_ratio), y = log1p(vuln_ratio), color = b_v_k),
             alpha = 0.2) +
  scale_color_paletteer_c("viridis::plasma",
                          rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Price ratio",
       y = "Vulnerability ratio",
       title = "Strong stock",
       color = "B/K") +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.title = element_text(size = 10, color = "black"),
        axis.text = element_text(size = 10, color = "black"))
```

```{r, include = FALSE}
test %>% 
   mutate(b_v_k = case_when(
     b_v_k < 0 ~ 0,
     TRUE ~ b_v_k
   )) %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k <= 1) %>% 
  ggplot() +
  geom_point(aes(x = log1p(price_ratio), y = log1p(vuln_ratio), color = b_v_k),
             alpha = 0.2) +
  scale_color_paletteer_c("viridis::plasma",
                          rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Price ratio",
       y = "Vulnerability ratio",
       title = "Weak stock",
       color = "B/K") +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.title = element_text(size = 10, color = "black"),
        axis.text = element_text(size = 10, color = "black"))
```


```{r, echo = FALSE}
q_neg <- 
  output_test_updated %>% 
  filter(values < 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = values)) +
  facet_wrap(~ variables) +
#  scale_fill_continuous(breaks = seq(-10, 0, 2)) +
  labs(title = "Negative values") +
  theme_bw()
```

```{r, echo = FALSE}
q_pos <-
  output_test_updated %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_fill_continuous(breaks = seq(0, 25, 5)) +
  labs(title = "Positive values") +
  theme_bw()
```


```{r, fig.width=9, echo = FALSE}
# (q_neg + q_pos) +
#   plot_annotation(title = "Catchability ranges")
```



```{r, echo = FALSE}
r_neg <- 
  output_test_updated %>% 
  filter(values <= 0) %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = values)) +
  facet_wrap(~ variables) +
  labs(title = "Negative values for r scenarios") +
  theme_bw()
```

```{r, echo = FALSE}
r_pos <- 
  output_test_updated %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_fill_continuous(breaks = seq(0, 25, 5)) +
  labs(title = "Positive values for r scenarios") +
  theme_bw()
```

```{r, fig.width=8, echo = FALSE}
# r_neg + r_pos +
#   plot_annotation(title = "Range of values for r scenarios")
```


```{r, echo = FALSE}
k_neg <-
  output_test_updated %>% 
  filter(values <= 0) %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = values)) +
  facet_wrap(~ variables) +
  labs(title = "Negative values for K ranges") +
  theme_bw()
```

```{r, echo = FALSE}
k_pos <-
  output_test_updated %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = values)) +
  facet_wrap(~ variables) + 
  scale_fill_continuous(breaks = seq(0, 25, 5)) +
  labs(title = "Positive values for K ranges") +
  theme_bw()
```

```{r, fig.width=8, echo = FALSE}
# k_neg + k_pos +
#   plot_annotation(title = "Range of values for K scenarios")
```



```{r, echo = FALSE}
price_neg <-
  output_test_updated %>% 
  filter(values <= 0) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_x_continuous(breaks = seq(0, 10, 2)) +
  labs(title = "Negative values for the range of prices") +
  theme_bw()
```

```{r, echo = FALSE}
pos_price <- 
  output_test_updated %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_fill_continuous(breaks = seq(0, 25, 5)) +
  labs(title = "Positive values for the range of prices") +
  theme_bw()
```

```{r, fig.width=8, echo = FALSE}
# price_neg + pos_price +
#   plot_annotation(title = "Values for the range of prices")
```


## Setting up the time series simulation

$$
\begin{align}
\frac{d N_s}{dt} &= N_S  (r_s  (1 - \frac{N_S}{K_s}) - q_s e_t) \\
\newline
\frac{d N_w}{dt} &= N_W  (r_w  (1 - \frac{N_W}{K_w}) - q_w e_t) \\
\newline
\frac{d E}{dt} &= \alpha  E  (p_s  q_s  N_S + p_w q_w N_W - c)
\end{align}
$$


where $q_s$ and $q_w$ are the catchability of the strong and the weak stock, respectively; $r_s$ and $r_w$ are the intrinsic growth rates of the strong and weak stocks, respectively; $p_s$ and $p_w$ are the prices of the strong and weak stocks, respectively; $k_s$ and $k_w$ are the carrying capacities of the strong and weak stocks, respectively; $c$ is the fishing cost, and $\alpha$ is a constant controling for the speed at which effort changes following price changes.

```{r, echo = FALSE}
# set up the parameter space
q_s1 <- 0.1
q_w1 <- 0.15
k_s1 <- 1
k_w1 <- 1
r_s1 <- 1
r_w1 <- 1
p_s1 <- 1
p_w1 <- 1
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu1 <- NaN*tset; N_w_simu1[1] <- N_w

N_s_simu1 <- NaN*tset; N_s_simu1[1] <- N_s

E_simu1 <- NaN*tset; E_simu1[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w1 <- N_w_simu1[i-1]
  N_s1 <- N_s_simu1[i-1]
  E1 <- E_simu1[i-1]
  
  # Calculate change in variable size at each time step
  dN_s1 <- (N_s1 * (r_s1 * (1 - N_s1/k_s1) - q_s1 * E1)) * dt
  dN_w1 <- (N_w1 * (r_w1 * (1 - N_w1/k_w1) - q_w1 * E1)) * dt
  dE1 <- (alpha * E1 * (p_s1 * q_s1 * N_s1 + p_w1 * q_w1 * N_w1 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu1[i] <- N_w1 + dN_w1
  N_s_simu1[i] <- N_s1 + dN_s1
  E_simu1[i] <- E1 + dE1
  
}
  

```


```{r, echo = FALSE, include = FALSE}
plot(x = tset, y = N_s_simu1,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 8),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu1,
      type = "l", col = "orange")
lines(x = tset, y = E_simu1,
      type = "l", col = "green")
title(main = "First simulation - Both stocks with the same price",
      sub = "Params: q_s = 0.1, q_w = 0.15, r_s = 1, r_w = 1, k_s = 1, k_w = 1, p_s = 1, p_w = 1")
legend(x = 80, y = 5,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

```{r, echo = FALSE}
# set up the parameter space
q_s2 <- 0.1
q_w2 <- 0.1
k_s2 <- 2
k_w2 <- 1
r_s2 <- 0.5
r_w2 <- 0.25
p_s2 <- 1
p_w2 <- 5
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu2 <- NaN*tset; N_w_simu2[1] <- N_w

N_s_simu2 <- NaN*tset; N_s_simu2[1] <- N_s

E_simu2 <- NaN*tset; E_simu2[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w2 <- N_w_simu2[i-1]
  N_s2 <- N_s_simu2[i-1]
  E2 <- E_simu2[i-1]
  
  # Calculate change in variable size at each time step
  dN_s2 <- (N_s2 * (r_s2 * (1 - N_s2/k_s2) - q_s2 * E2)) * dt
  dN_w2 <- (N_w2 * (r_w2 * (1 - N_w2/k_w2) - q_w2 * E2)) * dt
  dE2 <- (alpha * E2 * (p_s2 * q_s2 * N_s2 + p_w2 * q_w2 * N_w2 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu2[i] <- N_w2 + dN_w2
  N_s_simu2[i] <- N_s2 + dN_s2
  E_simu2[i] <- E2 + dE2
  

}
  

```

```{r, echo = FALSE, include = FALSE}
plot(x = tset, y = N_s_simu2,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 8),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu2,
      type = "l", col = "orange")
lines(x = tset, y = E_simu2,
      type = "l", col = "green")
title(main = "Second simulation - Price ratio = 0.2",
      sub = "Params: q_s = 0.1, q_w = 0.1, r_s = 0.5, r_w = 0.25, k_s = 2, k_w = 1, p_s = 1, p_w = 5")
legend(x = 80, y = 7.7,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

```{r, echo = FALSE}
# set up the parameter space
q_s3 <- 0.1
q_w3 <- 0.1
k_s3 <- 3
k_w3 <- 1
r_s3 <- 1
r_w3 <- 0.2
p_s3 <- 1
p_w3 <- 10
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu3 <- NaN*tset; N_w_simu3[1] <- N_w

N_s_simu3 <- NaN*tset; N_s_simu3[1] <- N_s

E_simu3 <- NaN*tset; E_simu3[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w3 <- N_w_simu3[i-1]
  N_s3 <- N_s_simu3[i-1]
  E3 <- E_simu3[i-1]
  
  # Calculate change in variable size at each time step
  dN_s3 <- (N_s3 * (r_s3 * (1 - N_s3/k_s3) - q_s3 * E3)) * dt
  dN_w3 <- (N_w3 * (r_w3 * (1 - N_w3/k_w3) - q_w3 * E3)) * dt
  dE3 <- (alpha * E3 * (p_s3 * q_s3 * N_s3 + p_w3 * q_w3 * N_w3 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu3[i] <- N_w3 + dN_w3
  N_s_simu3[i] <- N_s3 + dN_s3
  E_simu3[i] <- E3 + dE3
  
}
  

```


```{r, echo = FALSE, include = FALSE}
plot(x = tset, y = N_s_simu3,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 15),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu3,
      type = "l", col = "orange")
lines(x = tset, y = E_simu3,
      type = "l", col = "green")
title(main = "Third simulation - Price ratio = 0.1",
      sub = "Params: q_s = 0.1, q_w = 0.1, r_s = 1, r_w = 0.2, k_s = 3, k_w = 1, p_s = 1, p_w = 10")
legend(x = 80, y = 14,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

```{r, echo = FALSE}
# set up the parameter space
q_s4 <- 0.1
q_w4 <- 0.1
k_s4 <- 3
k_w4 <- 1
r_s4 <- 1
r_w4 <- 0.2
p_s4 <- 0.1
p_w4 <- 10
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu4 <- NaN*tset; N_w_simu4[1] <- N_w

N_s_simu4 <- NaN*tset; N_s_simu4[1] <- N_s

E_simu4 <- NaN*tset; E_simu4[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w4 <- N_w_simu4[i-1]
  N_s4 <- N_s_simu4[i-1]
  E4 <- E_simu4[i-1]
  
  # Calculate change in variable size at each time step
  dN_s4 <- (N_s4 * (r_s4 * (1 - N_s4/k_s4) - q_s4 * E4)) * dt
  dN_w4 <- (N_w4 * (r_w4 * (1 - N_w4/k_w4) - q_w4 * E4)) * dt
  dE4 <- (alpha * E4 * (p_s4 * q_s4 * N_s4 + p_w4 * q_w4 * N_w4 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu4[i] <- N_w4 + dN_w4
  N_s_simu4[i] <- N_s4 + dN_s4
  E_simu4[i] <- E4 + dE4
  
}
  

```


```{r, echo = FALSE, include = FALSE}
plot(x = tset, y = N_s_simu4,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 12),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu4,
      type = "l", col = "orange")
lines(x = tset, y = E_simu4,
      type = "l", col = "green")
title(main = "Fourth simulation - Price ratio = 0.01",
      sub = "Params: q_s = 0.1, q_w = 0.1, r_s = 1, r_w = 0.2, k_s = 3, k_w = 1, p_s = 0.1, p_w = 10")
legend(x = 80, y = 10,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```


```{r, echo = FALSE}
# set up the parameter space
q_s5 <- 0.1
q_w5 <- 0.1
k_s5 <- 3
k_w5 <- 1
r_s5 <- 1
r_w5 <- 0.2
p_s5 <- 5
p_w5 <- 2.5
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu5 <- NaN*tset; N_w_simu5[1] <- N_w

N_s_simu5 <- NaN*tset; N_s_simu5[1] <- N_s

E_simu5 <- NaN*tset; E_simu5[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w5 <- N_w_simu5[i-1]
  N_s5 <- N_s_simu5[i-1]
  E5 <- E_simu5[i-1]
  
  # Calculate change in variable size at each time step
  dN_s5 <- (N_s5 * (r_s5 * (1 - N_s5/k_s5) - q_s5 * E5)) * dt
  dN_w5 <- (N_w5 * (r_w5 * (1 - N_w5/k_w5) - q_w5 * E5)) * dt
  dE5 <- (alpha * E5 * (p_s5 * q_s5 * N_s5 + p_w5 * q_w5 * N_w5 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu5[i] <- N_w5 + dN_w5
  N_s_simu5[i] <- N_s5 + dN_s5
  E_simu5[i] <- E5 + dE5
  
}
  

```


```{r, echo = FALSE, include = FALSE}
plot(x = tset, y = N_s_simu5,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 25),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu5,
      type = "l", col = "orange")
lines(x = tset, y = E_simu5,
      type = "l", col = "green")
title(main = "Fifth simulation - Price ratio = 2",
      sub = "Params: q_s = 0.1, q_w = 0.1, r_s = 1, r_w = 0.2, k_s = 3, k_w = 1, p_s = 5, p_w = 2.5")
legend(x = 80, y = 25,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

```{r, echo = FALSE}
# set up the parameter space
q_s6 <- 0.1
q_w6 <- 0.1
k_s6 <- 3
k_w6 <- 1
r_s6 <- 1
r_w6 <- 0.2
p_s6 <- 2.5
p_w6 <- 5
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu6 <- NaN*tset; N_w_simu6[1] <- N_w

N_s_simu6 <- NaN*tset; N_s_simu6[1] <- N_s

E_simu6 <- NaN*tset; E_simu6[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w6 <- N_w_simu6[i-1]
  N_s6 <- N_s_simu6[i-1]
  E6 <- E_simu6[i-1]
  
  # Calculate change in variable size at each time step
  dN_s6 <- (N_s6 * (r_s6 * (1 - N_s6/k_s6) - q_s6 * E6)) * dt
  dN_w6 <- (N_w6 * (r_w6 * (1 - N_w6/k_w6) - q_w6 * E6)) * dt
  dE6 <- (alpha * E6 * (p_s6 * q_s6 * N_s6 + p_w6 * q_w6 * N_w6 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu6[i] <- N_w6 + dN_w6
  N_s_simu6[i] <- N_s6 + dN_s6
  E_simu6[i] <- E6 + dE6
  
}
  

```


```{r, echo = FALSE, include = FALSE}
plot(x = tset, y = N_s_simu6,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 20),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu6,
      type = "l", col = "orange")
lines(x = tset, y = E_simu6,
      type = "l", col = "green")
title(main = "Sixth simulation - Price ratio = 0.5",
      sub = "Params: q_s = 0.1, q_w = 0.1, r_s = 1, r_w = 0.2, k_s = 3, k_w = 1, p_s = 2.5, p_w = 5")
legend(x = 80, y = 20,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```


```{r, echo = FALSE}
# set up the parameter space
q_s7 <- 0.1
q_w7 <- 0.1
k_s7 <- 3
k_w7 <- 1
r_s7 <- 1
r_w7 <- 0.2
p_s7 <- 10
p_w7 <- 0.1
alpha <- 1
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.1
```

```{r, echo = FALSE}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu7 <- NaN*tset; N_w_simu7[1] <- N_w

N_s_simu7 <- NaN*tset; N_s_simu7[1] <- N_s

E_simu7 <- NaN*tset; E_simu7[1] <- E
```

```{r, echo = FALSE}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w7 <- N_w_simu7[i-1]
  N_s7 <- N_s_simu7[i-1]
  E7 <- E_simu7[i-1]
  
  # Calculate change in variable size at each time step
  dN_s7 <- (N_s7 * (r_s7 * (1 - N_s7/k_s7) - q_s7 * E7)) * dt
  dN_w7 <- (N_w7 * (r_w7 * (1 - N_w7/k_w7) - q_w7 * E7)) * dt
  dE7 <- (alpha * E7 * (p_s7 * q_s7 * N_s7 + p_w7 * q_w7 * N_w7 - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu7[i] <- N_w7 + dN_w7
  N_s_simu7[i] <- N_s7 + dN_s7
  E_simu7[i] <- E7 + dE7
  
}
  

```


```{r, echo = FALSE, include = FALSE}
plot(x = tset, y = N_s_simu7,
     type = "l",
     col = "blue",
     las = 1,
     lwd = 2,
     ylim = c(0, 40),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu7,
      type = "l", col = "orange")
lines(x = tset, y = E_simu7,
      type = "l", col = "green")
title(main = "Seventh simulation - Price ratio = 100",
      sub = "Params: q_s = 0.1, q_w = 0.1, r_s = 1, r_w = 0.2, k_s = 3, k_w = 1, p_s = 10, p_w = 0.1")
legend(x = 80, y = 40,
       lwd = 2,
       legend = c("Ns", "Nw", "E"),
       col = c("blue", "orange", "green"))
```

```{r, echo = FALSE}
effort_df <- cbind(E_simu1, E_simu2, E_simu3, E_simu4, E_simu5, E_simu6, E_simu7, tset) %>% 
  as.data.frame() %>% 
  pivot_longer(cols = starts_with("E_"),
               names_to = "variable",
               values_to = "value") %>% 
  mutate(scenario_id = case_when(
    str_detect(variable, "1") ~ "1",
    str_detect(variable, "2") ~ "2",
    str_detect(variable, "3") ~ "3",
    str_detect(variable, "4") ~ "4",
    str_detect(variable, "5") ~ "5",
    str_detect(variable, "6") ~ "6",
    str_detect(variable, "7") ~ "7")
         )

nw_df <- cbind(N_w_simu1, N_w_simu2, N_w_simu3, N_w_simu4, N_w_simu5, N_w_simu6, N_w_simu7, tset) %>% 
  as.data.frame() %>% 
  pivot_longer(cols = starts_with("N_w_"),
               names_to = "variable",
               values_to = "value") %>% 
  mutate(scenario_id = case_when(
    str_detect(variable, "1") ~ "1",
    str_detect(variable, "2") ~ "2",
    str_detect(variable, "3") ~ "3",
    str_detect(variable, "4") ~ "4",
    str_detect(variable, "5") ~ "5",
    str_detect(variable, "6") ~ "6",
    str_detect(variable, "7") ~ "7")
         )

ns_df <- cbind(N_s_simu1, N_s_simu2, N_s_simu3, N_s_simu4, N_s_simu5, N_s_simu6, N_s_simu7, tset) %>% 
  as.data.frame() %>% 
  pivot_longer(cols = starts_with("N_s_"),
               names_to = "variable",
               values_to = "value") %>% 
  mutate(scenario_id = case_when(
    str_detect(variable, "1") ~ "1",
    str_detect(variable, "2") ~ "2",
    str_detect(variable, "3") ~ "3",
    str_detect(variable, "4") ~ "4",
    str_detect(variable, "5") ~ "5",
    str_detect(variable, "6") ~ "6",
    str_detect(variable, "7") ~ "7")
         )

var_full <- bind_rows(effort_df, nw_df, ns_df)
```

```{r, echo = FALSE, fig.height=4, fig.width=8}
var_full %>%
  filter(scenario_id %in% c("1", "4", "5", "6", "7")) %>%
  mutate(price_ratio = case_when(
    str_detect(scenario_id, "1") ~ "Price ratio = 1",
    str_detect(scenario_id, "4") ~ "Price ratio = 0.01",
    str_detect(scenario_id, "5") ~ "Price ratio = 2",
    str_detect(scenario_id, "6") ~ "Price ratio = 0.5",
    str_detect(scenario_id, "7") ~ "Price ratio = 100",
  )) %>% 
  mutate(variable_clean = case_when(
    str_detect(variable, "N_w") ~ "Weak stock",
    str_detect(variable, "N_s") ~ "Strong stock",
    str_detect(variable, "E") ~ "Effort",
  )) %>% 
  ggplot() +
  geom_line(aes(x = tset, y = value, color = variable_clean),
            size = .8,
            alpha = .8,
            show.legend = T) +
  facet_wrap(~ factor(price_ratio, 
                      levels = c("Price ratio = 100",
                                 "Price ratio = 2",
                                 "Price ratio = 1",
                                 "Price ratio = 0.5",
                                 "Price ratio = 0.01")),
             nrow = 1,
             scales = "free_y") +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Time",
       y = "Nw, Ns, E",
       color = "") +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        strip.text = element_text(color = "black", size = 11),
        axis.title = element_text(color = "black", size = 12, face = "bold"),
        axis.text = element_text(color = "black", size = 10),
        legend.position = "bottom")
```

- I think this figure (or a better version of it) should also go in the paper, because it clearly shows how effort increases a lot when we consider two species, and how it drives both of them to extremely low levels for most of the scenarios, but not all. The price ratio calculation is price of the strong stock $\frac{P_s}{P_w}$.











