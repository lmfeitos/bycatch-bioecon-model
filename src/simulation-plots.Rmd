---
title: "simulation-plots"
author: "Leonardo Feitosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
library(tidyverse)
library(here)
library(patchwork)

# file path
basedir <- "G:/Meu Drive/PhD Project - Fisheries bycatch/Bycatch project/Chapter 1/analyses/"
outdir <- file.path(basedir, "model_outs") # calls present data from raster files
```

```{r, include = FALSE}
# Results from the parameter per parameter simulations
output_price_ranges <- read_csv(file.path(outdir, "output_price_ranges.csv"))

output_growth_ranges <- read_csv(file.path(outdir, "output_r_ranges.csv"))

output_q_ranges <- read_csv(file.path(outdir, "output_q_ranges.csv"))

output_full <- read_csv(file.path(outdir, "output_full.csv"))

output_test <- read_csv(file.path(outdir, "output_ranges_test.csv"))
```


# Results from the parameter per parameter simulation



```{r, include = FALSE}
output_price_ranges %>%
  pivot_wider(names_from = "stock_prices",
              values_from = "prices") %>% 
  filter(variables %in% c("N_w", "N_s")) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_fill_gradientn(name = "Weak stock size", 
                       colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(breaks = seq(0, 10, 1)) +
  labs(x = "Weak stock price range",
       y = "Strong stock price range",
       title = "Simulation of price ranges on variable size") +
  theme_bw() 
```

```{r, include = FALSE}
output_price_ranges %>%
  pivot_wider(names_from = "stock_prices",
              values_from = "prices") %>% 
  filter(variables %in% c("N_w", "N_s")) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_fill_gradientn(name = "Weak stock size", 
                       colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(breaks = seq(0, 10, 1)) +
  labs(x = "Weak stock price range",
       y = "Strong stock price range",
       title = "Simulation of price ranges on variable size") +
  theme_bw() 
```




```{r, include = FALSE}
output_price_ranges %>%
  pivot_wider(names_from = "stock_prices",
              values_from = "prices") %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_fill_gradientn(name = "Weak stock size", 
                       colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  scale_y_continuous(breaks = seq(0, 10, 1)) +
  labs(x = "Weak stock price range",
       y = "Strong stock price range",
       title = "Simulation of price ranges on variable size") +
  theme_bw() +
  theme(panel.spacing = unit(4, "mm"))
```



```{r, include = FALSE}
output_q_ranges %>%   
  pivot_wider(names_from = "stock_q",
              values_from = "q") %>%  
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = values)) +
  facet_wrap(~ variables,
            scales = "free_y") +
  scale_fill_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  facet_wrap(~ variables,
             scales = "free_y") +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Simulation of catchability ranges on stock size") +
  theme_bw() 
```



```{r, include = FALSE}
output_full %>% 
  filter(variables %in% c("N_w", "N_s")) %>% 
  pivot_longer(cols = starts_with("values_"),
               names_to = "parameter",
               values_to = "values") %>%  
  filter(parameter == "values_price") %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = log(prod_ratio + 1), color = values),
             alpha = 0.6) +
  scale_color_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(5, "YlOrRd")) +
  labs(x = "Price ratio (p_s/p_w)",
       y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
       title = "Simulation of the distribution of productivity and price ratios") +
  theme_bw()
```

## Model equations:

- Strong stock size ($N_s$):

$$
N_s = \frac{K_s * (c * q_s * r_w + K_w * p_w * q_w * (q_w * r_s - q_s * r_w))} {(K_w * p_w * q_w^2 * r_s) + (K_s * p_s * q_s^2 * r_w)}
$$

- Weak stock size ($N_w$):

$$
N_w = \frac{K_w * (c * q_w * r_s + K_s * p_s * q_s * (- q_w * r_s + q_s * r_w))} {(K_w * p_w * q_w^2 * r_s) + (K_s * p_s * q_s^2 * r_w)}
$$

- Effort ($e$):

$$
e = \frac{(-c + K_s * p_s * q_s + K_w * p_w * q_w) * r_s * r_w} {(K_w * p_w * q_w^2 r_s) + (K_s * p_s * q_s^2 * r_w)}
$$

### List of parameters:
- K = carrying capacity
- r = per capita growth rate
- q = catchability of stocks
- c = cost of fishing
- p = price

### Parameter space for both species:

- Catchability (q) varies from 0.1 to 0.5 at intervals of 0.2 for both species.
- Growth rate (r) varies from 0.35 to 1.05 at intervals of 0.35 for the strong stock and from 0.1 to 0.3 at intervals of 0.1 for the weak stock.
- Carrying capacity (k) varies from 3 to 5 at intervals of 1 for the strong stock and from 1 to 3 at intervals of 1 for the weak stock.
- Price ranges (p) from 0.1 to 10 at intervals of 0.5 for both species.


### Distribution of variable values

```{r, echo = FALSE, message = FALSE}
out_full <- 
  output_test %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = values, fill = variables),
                 show.legend = F) +
  facet_wrap(~ variables,
             scales = "free") +
  labs(title = "Full dataset") +
  theme_bw()
```

```{r, echo = FALSE}
out_transf <- 
  output_test %>%
  filter(variables %in% c("N_w", "N_s")) %>% 
  mutate(values = case_when(
    values < 0 ~ 0,
    TRUE ~ values
  )) %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = values, fill = variables),
                 show.legend = F) +
  facet_wrap(~ variables,
             scales = "free") +
  labs(title = "Negative values transformed to zero") +
  theme_bw()
```

```{r, echo = FALSE}
out_pos <- 
  output_test %>%
  filter(values >= 0) %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = values, fill = variables),
                 show.legend = F) +
  facet_wrap(~ variables,
             scales = "free") +
  labs(title = "Negative values filtered out") +
  theme_bw()
```


```{r, fig.height=9, fig.width=9, echo = FALSE}
out_full / 
  (out_transf + out_pos) +
  plot_annotation(title = "Distribution of Equilibria")
```


### Catchability range simulation


```{r, echo = FALSE}
# New tests with the other parameters also being varied

output_test %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = values)) +
  facet_wrap(~ variables,
            scales = "free_y") +
  scale_fill_gradientn(name = "Variable size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  facet_wrap(~ variables,
             scales = "free_y") +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Simulation of catchability ranges on variable size") +
  theme_bw()
```


```{r, echo = FALSE}
output_test %>% 
  filter(variables %in% c("N_w", "N_s")) %>% 
  mutate(values = case_when(
    values < 0 ~ 0,
    TRUE ~ values
  )) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = values)) +
  facet_wrap(~ variables,
            scales = "free_y") +
  scale_fill_gradientn(name = "Stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  facet_wrap(~ variables,
             scales = "free_y") +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Simulation of catchability ranges on stock size") +
  theme_bw()
```


### Price range simulation

```{r, echo = FALSE}
output_test %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables,
            scales = "free_y") +
  scale_fill_gradientn(name = "Variable size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  facet_wrap(~ variables,
             scales = "free_y") +
  labs(x = "Weak stock price ranges",
       y = "Strong stock price ranges",
       title = "Simulation of price ranges on variable size") +
  theme_bw()
```


```{r, echo = FALSE}
output_test %>% 
  filter(variables %in% c("N_w", "N_s")) %>% 
  mutate(values = case_when(
    values < 0 ~ 0,
    TRUE ~ values
  )) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables,
            scales = "free_y") +
  scale_fill_gradientn(name = "Stock size", 
                       colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  facet_wrap(~ variables,
             scales = "free_y") +
  labs(x = "Weak stock price ranges",
       y = "Strong stock price ranges",
       title = "Simulation of price ranges on stock size") +
  theme_bw()
```


### Growth range simulation

```{r, echo = FALSE}
output_test %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = values)) +
  facet_wrap(~ variables,
            scales = "free_y") +
  scale_fill_gradientn(name = "Variable size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  facet_wrap(~ variables,
             scales = "free_y") +
  labs(x = "Weak stock growth ranges",
       y = "Strong stock growth ranges",
       title = "Simulation of growth ranges on variable size") +
  theme_bw()
```


```{r, echo = FALSE}
output_test %>% 
  filter(values >= 0 & variables %in% c("N_w", "N_s")) %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = values)) +
  facet_wrap(~ variables,
            scales = "free_y") +
  scale_fill_gradientn(name = "Stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  facet_wrap(~ variables,
             scales = "free_y") +
  labs(x = "Weak stock growth ranges",
       y = "Strong stock growth ranges",
       title = "Simulation of growth ranges on stock size") +
  theme_bw()
```


### Carrying capacity range simulation

```{r, echo = FALSE}
output_test %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = values)) +
  facet_wrap(~ variables,
            scales = "free_y") +
  scale_fill_gradientn(name = "Variable size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  facet_wrap(~ variables,
             scales = "free_y") +
  labs(x = "Weak stock K ranges",
       y = "Strong stock K ranges",
       title = "Simulation of K ranges on variable size") +
  theme_bw()
```


```{r, echo = FALSE}
output_test %>% 
  filter(values >= 0 & variables %in% c("N_w", "N_s")) %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = values)) +
  facet_wrap(~ variables,
            scales = "free_y") +
  scale_fill_gradientn(name = "Stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
  facet_wrap(~ variables,
             scales = "free_y") +
  labs(x = "Weak stock K ranges",
       y = "Strong stock K ranges",
       title = "Simulation of K ranges on stock size") +
  theme_bw()
```


```{r, echo = FALSE}
vul_full <- 
  output_test %>% 
  filter(variables %in% c("N_w", "N_s")) %>% 
  mutate(prod_ratio = (q_s/r_s) / (q_w/r_w)) %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = prod_ratio, color = values),
             alpha = 0.6) +
  scale_color_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(5, "YlOrRd")) +
  labs(x = "Price ratio (p_s/p_w)",
       y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
       title = "All values") +
  theme_bw()
```

```{r, echo = FALSE}
vul_pos <- 
  output_test %>% 
  filter(variables %in% c("N_w", "N_s") & values >= 0) %>% 
  mutate(prod_ratio = (q_s/r_s) / (q_w/r_w)) %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = prod_ratio, color = values),
             alpha = 0.6) +
  scale_color_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(5, "YlOrRd")) +
  labs(x = "Price ratio (p_s/p_w)",
       y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
       title = "Only positive values") +
  theme_bw()
```

```{r, echo = FALSE}
vul_neg <- 
  output_test %>% 
  filter(variables %in% c("N_w", "N_s") & values <= 0) %>% 
  mutate(prod_ratio = (q_s/r_s) / (q_w/r_w)) %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = prod_ratio, color = values),
             alpha = 0.6) +
  scale_color_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(5, "YlOrRd"),
                        breaks = seq(-60, 0, 10)) +
  labs(x = "Price ratio (p_s/p_w)",
       y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
       title = "Only negative values") +
  theme_bw()
```

### Price ratio vs Vulnerability test

```{r, fig.height = 10, fig.width=9, echo = FALSE}
(vul_neg + vul_pos) /
  vul_full +
  plot_annotation(title = "Simulation of the distribution of vulnerability and price ratios")
```



```{r, echo = FALSE}
q_neg <- 
  output_test %>% 
  filter(values < 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = values)) +
  facet_wrap(~ variables) +
#  scale_fill_continuous(breaks = seq(-10, 0, 2)) +
  labs(title = "Negative values") +
  theme_bw()
```

```{r, echo = FALSE}
q_pos <-
  output_test %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_fill_continuous(breaks = seq(0, 25, 5)) +
  labs(title = "Positive values") +
  theme_bw()
```


```{r, fig.width=9, echo = FALSE}
(q_neg + q_pos) +
  plot_annotation(title = "Catchability ranges")
```



```{r, echo = FALSE}
r_neg <- 
  output_test %>% 
  filter(values <= 0) %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = values)) +
  facet_wrap(~ variables) +
  labs(title = "Negative values for r scenarios") +
  theme_bw()
```

```{r, echo = FALSE}
r_pos <- 
  output_test %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_fill_continuous(breaks = seq(0, 25, 5)) +
  labs(title = "Positive values for r scenarios") +
  theme_bw()
```

```{r, fig.width=8, echo = FALSE}
r_neg + r_pos +
  plot_annotation(title = "Range of values for r scenarios")
```


```{r, echo = FALSE}
k_neg <-
  output_test %>% 
  filter(values <= 0) %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = values)) +
  facet_wrap(~ variables) +
  labs(title = "Negative values for K ranges") +
  theme_bw()
```

```{r, echo = FALSE}
k_pos <-
  output_test %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = values)) +
  facet_wrap(~ variables) + 
  scale_fill_continuous(breaks = seq(0, 25, 5)) +
  labs(title = "Positive values for K ranges") +
  theme_bw()
```

```{r, fig.width=8, echo = FALSE}
k_neg + k_pos +
  plot_annotation(title = "Range of values for K scenarios")
```



```{r, echo = FALSE}
price_neg <-
  output_test %>% 
  filter(values <= 0) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_x_continuous(breaks = seq(0, 10, 2)) +
  labs(title = "Negative values for the range of prices") +
  theme_bw()
```

```{r, echo = FALSE}
pos_price <- 
  output_test %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_fill_continuous(breaks = seq(0, 25, 5)) +
  labs(title = "Positive values for the range of prices") +
  theme_bw()
```

```{r, fig.width=8, echo = FALSE}
price_neg + pos_price +
  plot_annotation(title = "Values for the range of prices")
```























