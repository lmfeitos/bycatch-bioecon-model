---
title: "simulation-plots"
author: "Leonardo Feitosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
library(tidyverse)
library(here)
library(patchwork)
library(kableExtra)

# file path
basedir <- "G:/Meu Drive/PhD Project - Fisheries bycatch/Bycatch project/Chapter 1/analyses/"
outdir <- file.path(basedir, "model_outs") # calls present data from raster files
```

```{r, include = FALSE}
# Results from the parameter per parameter simulations
#output_price_ranges <- read_csv(file.path(outdir, "output_price_ranges.csv"))

#output_growth_ranges <- read_csv(file.path(outdir, "output_r_ranges.csv"))

#output_q_ranges <- read_csv(file.path(outdir, "output_q_ranges.csv"))

#output_full <- read_csv(file.path(outdir, "output_full.csv"))
```

```{r}
# Updated dataset to be used in the analyses
output_test <- read_csv(file.path(outdir, "output_ranges_test.csv"))  

output_test_updated <- output_test %>% 
  pivot_wider(names_from = "variables",
              values_from = "values") %>% 
  mutate(b_values_s = N_s / k_s,
         b_values_w = N_w / k_w) %>% 
  pivot_longer(cols = e:N_w,
               names_to = "variables",
               values_to = "values") %>% 
  pivot_longer(cols = starts_with("b_values"),
               names_to = "b_stocks",
               values_to = "b_v_k") %>% 
  mutate(vuln_ratio = (q_s/r_s) / (q_w/r_w))
```

```{r, echo = FALSE}
head(output_test_updated, n = 20) %>% 
  kable(caption = "Glimpse of the first 20 columns of the dataset") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```


# Results from the parameter per parameter simulation



```{r, include = FALSE}
# output_price_ranges %>%
#   pivot_wider(names_from = "stock_prices",
#               values_from = "prices") %>% 
#   filter(variables %in% c("N_w", "N_s")) %>% 
#   ggplot() +
#   geom_raster(aes(x = p_w, y = p_s, fill = values)) +
#   facet_wrap(~ variables) +
#   scale_fill_gradientn(name = "Weak stock size", 
#                        colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   scale_x_continuous(breaks = seq(0, 10, 1)) +
#   scale_y_continuous(breaks = seq(0, 10, 1)) +
#   labs(x = "Weak stock price range",
#        y = "Strong stock price range",
#        title = "Simulation of price ranges on variable size") +
#   theme_bw() 
```

```{r, include = FALSE}
# output_price_ranges %>%
#   pivot_wider(names_from = "stock_prices",
#               values_from = "prices") %>% 
#   filter(variables %in% c("N_w", "N_s")) %>% 
#   ggplot() +
#   geom_raster(aes(x = p_w, y = p_s, fill = values)) +
#   facet_wrap(~ variables) +
#   scale_fill_gradientn(name = "Weak stock size", 
#                        colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   scale_x_continuous(breaks = seq(0, 10, 1)) +
#   scale_y_continuous(breaks = seq(0, 10, 1)) +
#   labs(x = "Weak stock price range",
#        y = "Strong stock price range",
#        title = "Simulation of price ranges on variable size") +
#   theme_bw() 
```




```{r, include = FALSE}
# output_price_ranges %>%
#   pivot_wider(names_from = "stock_prices",
#               values_from = "prices") %>% 
#   ggplot() +
#   geom_raster(aes(x = p_w, y = p_s, fill = values)) +
#   facet_wrap(~ variables) +
#   scale_fill_gradientn(name = "Weak stock size", 
#                        colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   scale_x_continuous(breaks = seq(0, 10, 1)) +
#   scale_y_continuous(breaks = seq(0, 10, 1)) +
#   labs(x = "Weak stock price range",
#        y = "Strong stock price range",
#        title = "Simulation of price ranges on variable size") +
#   theme_bw() +
#   theme(panel.spacing = unit(4, "mm"))
```



```{r, include = FALSE}
# output_q_ranges %>%   
#   pivot_wider(names_from = "stock_q",
#               values_from = "q") %>%  
#   ggplot() +
#   geom_raster(aes(x = q_w, y = q_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock q ranges",
#        y = "Strong stock q ranges",
#        title = "Simulation of catchability ranges on stock size") +
#   theme_bw() 
```



```{r, include = FALSE}
# output_full %>% 
#   filter(variables %in% c("N_w", "N_s")) %>% 
#   pivot_longer(cols = starts_with("values_"),
#                names_to = "parameter",
#                values_to = "values") %>%  
#   filter(parameter == "values_price") %>% 
#   ggplot() +
#   geom_point(aes(x = price_ratio, y = log(prod_ratio + 1), color = values),
#              alpha = 0.6) +
#   scale_color_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(5, "YlOrRd")) +
#   labs(x = "Price ratio (p_s/p_w)",
#        y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
#        title = "Simulation of the distribution of productivity and price ratios") +
#   theme_bw()
```

## Model equations:

- Strong stock size ($N_s$):

$$
N_s = \frac{K_s * (c * q_s * r_w + K_w * p_w * q_w * (q_w * r_s - q_s * r_w))} {(K_w * p_w * q_w^2 * r_s) + (K_s * p_s * q_s^2 * r_w)}
$$

- Weak stock size ($N_w$):

$$
N_w = \frac{K_w * (c * q_w * r_s + K_s * p_s * q_s * (- q_w * r_s + q_s * r_w))} {(K_w * p_w * q_w^2 * r_s) + (K_s * p_s * q_s^2 * r_w)}
$$

- Effort ($e$):

$$
e = \frac{(-c + K_s * p_s * q_s + K_w * p_w * q_w) * r_s * r_w} {(K_w * p_w * q_w^2 r_s) + (K_s * p_s * q_s^2 * r_w)}
$$

### List of parameters:
- K = carrying capacity
- r = per capita growth rate
- q = catchability of stocks
- c = cost of fishing
- p = price

### Parameter space for both species:

- Catchability (q) varies from 0.1 to 0.5 at intervals of 0.2 for both species.
- Growth rate (r) varies from 0.35 to 1.05 at intervals of 0.35 for the strong stock and from 0.1 to 0.3 at intervals of 0.1 for the weak stock.
- Carrying capacity (k) varies from 3 to 5 at intervals of 1 for the strong stock and from 1 to 3 at intervals of 1 for the weak stock.
- Price ranges (p) from 0.1 to 10 at intervals of 0.5 for both species.


### Distribution of variable values

```{r, echo = FALSE, message = FALSE}
out_full <- 
  output_test_updated %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = values, fill = variables),
                 show.legend = F) +
  facet_wrap(~ variables,
             scales = "free") +
  labs(title = "Full dataset") +
  theme_bw()
```

```{r, echo = FALSE}
out_transf <- 
  output_test_updated %>%
  filter(variables %in% c("N_w", "N_s")) %>% 
  mutate(values = case_when(
    values < 0 ~ 0,
    TRUE ~ values
  )) %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = values, fill = variables),
                 show.legend = F) +
  facet_wrap(~ variables,
             scales = "free") +
  labs(title = "Negative values transformed to zero") +
  theme_bw()
```

```{r, echo = FALSE}
out_pos <- 
  output_test_updated %>%
  filter(values >= 0) %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = values, fill = variables),
                 show.legend = F) +
  facet_wrap(~ variables,
             scales = "free") +
  labs(title = "Negative values filtered out") +
  theme_bw()
```


```{r, fig.height=9, fig.width=9, echo = FALSE}
out_full / 
  (out_transf + out_pos) +
  plot_annotation(title = "Distribution of Equilibria")
```

```{r, echo = FALSE}
out_full_bvk <- 
  output_test_updated %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = b_v_k, fill = b_stocks),
                 show.legend = F) +
  facet_wrap(~ b_stocks,
             scales = "free") +
  labs(title = "Full dataset") +
  theme_bw()
```

```{r, echo = FALSE}
out_transf_bvk <- 
  output_test_updated %>%
  filter(variables %in% c("N_w", "N_s")) %>% 
  mutate(b_v_k = case_when(
    b_v_k < 0 ~ 0,
    TRUE ~ b_v_k
  )) %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = b_v_k, fill = b_stocks),
                 show.legend = F) +
  facet_wrap(~ b_stocks,
             scales = "free") +
  labs(title = "Negative values transformed to zero") +
  theme_bw()
```

```{r, echo = FALSE}
out_pos_bvk <- 
  output_test_updated %>%
  filter(b_v_k >= 0) %>% 
  # pivot_longer(cols = p_s:k_w,
  #              names_to = "param",
  #              values_to = "param_val") %>% 
  ggplot() +
  geom_histogram(aes(x = b_v_k, fill = b_stocks),
                 show.legend = F) +
  facet_wrap(~ b_stocks,
             scales = "free") +
  labs(title = "Negative values filtered out") +
  theme_bw()
```


```{r, fig.height=9, fig.width=9, echo = FALSE}
out_full_bvk / 
  (out_transf_bvk + out_pos_bvk) +
  plot_annotation(title = "Distribution of Equilibria for B/K ratios")
```



### Catchability range simulation


```{r, echo = FALSE}
# New tests with the other parameters also being varied

# output_test_updated %>% 
#   pivot_wider(names_from = "variables",
#               values_from = "values") %>% 
#   mutate(b_values_s = N_s / k_s,
#          b_values_w = N_w / k_w) %>% 
#   pivot_longer(cols = e:N_w,
#                names_to = "variables",
#                values_to = "values") %>% 
#   filter(values >= 0) %>% 
#   ggplot() +
#   geom_raster(aes(x = q_w, y = q_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Variable size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock q ranges",
#        y = "Strong stock q ranges",
#        title = "Simulation of catchability ranges on variable size") +
#   theme_bw()
```


```{r, echo = FALSE}
# output_test_updated %>% 
#   filter(variables %in% c("N_w", "N_s")) %>% 
#   mutate(values = case_when(
#     values < 0 ~ 0,
#     TRUE ~ values
#   )) %>% 
#   ggplot() +
#   geom_raster(aes(x = q_w, y = q_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock q ranges",
#        y = "Strong stock q ranges",
#        title = "Simulation of catchability ranges on stock size") +
#   theme_bw()
```

```{r, echo = FALSE}
w_s_q <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w") %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = b_v_k)) +
  #facet_grid(b_stocks ~ variables) + 
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
s_s_q <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s") %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = b_v_k)) +
  #facet_grid(b_stocks ~ variables) + 
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, fig.width=8, echo = FALSE}
s_s_q + w_s_q +
  plot_annotation(title = "Simulation of catchability ranges on strong and weak stock's B/K ratio - All values")
```


```{r, echo = FALSE}
s_s_q_pos <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = b_v_k)) +
#  facet_wrap(~ variables) + 
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
w_s_q_pos <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = b_v_k)) +
#  facet_wrap(~ variables) + 
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock q ranges",
       y = "Strong stock q ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
s_s_q_pos + w_s_q_pos +
  plot_annotation(title = "Simulation of catchability ranges on B/K ratio - Negative values filtered out")
```


### Price range simulation

```{r, echo = FALSE}
# output_test %>% 
#   filter(values >= 0) %>% 
#   ggplot() +
#   geom_raster(aes(x = p_w, y = p_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Variable size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock price ranges",
#        y = "Strong stock price ranges",
#        title = "Simulation of price ranges on variable size") +
#   theme_bw()
```


```{r, echo = FALSE}
ss_p <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s") %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock price ranges",
       y = "Strong stock price ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ws_p <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w") %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock price ranges",
       y = "Strong stock price ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ss_p + ws_p +
  plot_annotation(title = "Simulation of price ranges on strong and weak stock's B/K ratio - All values")
```


```{r, echo = FALSE}
ss_p_pos <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock price ranges",
       y = "Strong stock price ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ws_p_pos <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock price ranges",
       y = "Strong stock price ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ss_p_pos + ws_p_pos +
  plot_annotation(title = "Simulation of price ranges on strong and weak stock's B/K ratio - Positive values")
```

### Growth range simulation

```{r, echo = FALSE}
# output_test %>% 
#   filter(values >= 0) %>% 
#   ggplot() +
#   geom_raster(aes(x = r_w, y = r_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Variable size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock growth ranges",
#        y = "Strong stock growth ranges",
#        title = "Simulation of growth ranges on variable size") +
#   theme_bw()
```


```{r, echo = FALSE}
# output_test %>% 
#   filter(values >= 0 & variables %in% c("N_w", "N_s")) %>% 
#   ggplot() +
#   geom_raster(aes(x = r_w, y = r_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock growth ranges",
#        y = "Strong stock growth ranges",
#        title = "Simulation of growth ranges on stock size") +
#   theme_bw()
```

```{r, echo = FALSE}
ss_p <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s") %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock growth ranges",
       y = "Strong stock growth ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ws_p <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w") %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock growth ranges",
       y = "Strong stock growth ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ss_p + ws_p +
  plot_annotation(title = "Simulation of growth ranges on strong and weak stock's B/K ratio - All values")
```


```{r, echo = FALSE}
ss_r_pos <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock growth ranges",
       y = "Strong stock growth ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ws_r_pos <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock growth ranges",
       y = "Strong stock growth ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ss_r_pos + ws_r_pos +
  plot_annotation(title = "Simulation of growth ranges on strong and weak stock's B/K ratio - Positive values")
```

### Carrying capacity range simulation

```{r, echo = FALSE}
# output_test %>% 
#   filter(values >= 0) %>% 
#   ggplot() +
#   geom_raster(aes(x = k_w, y = k_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Variable size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   facet_wrap(~ variables,
#              scales = "free_y") +
#   labs(x = "Weak stock K ranges",
#        y = "Strong stock K ranges",
#        title = "Simulation of K ranges on variable size") +
#   theme_bw()
```


```{r, echo = FALSE}
# output_test %>% 
#   filter(values >= 0 & variables %in% c("N_w", "N_s")) %>% 
#   ggplot() +
#   geom_raster(aes(x = k_w, y = k_s, fill = values)) +
#   facet_wrap(~ variables,
#             scales = "free_y") +
#   scale_fill_gradientn(name = "Stock size", colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
#   labs(x = "Weak stock K ranges",
#        y = "Strong stock K ranges",
#        title = "Simulation of K ranges on stock size") +
#   theme_bw()
```

```{r, echo = FALSE}
ss_k <- 
  output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s") %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock K ranges",
       y = "Strong stock K ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
ws_k <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w") %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Weak stock K ranges",
       y = "Strong stock K ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r}
ss_k + ws_k +
  plot_annotation(title = "Simulation of K ranges on strong and weak stock's B/K ratio - All values")
```



```{r, echo = FALSE}
ss_k_pos <- output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock K ranges",
       y = "Strong stock K ranges",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r}
ws_k_pos <- output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = b_v_k)) +
  scale_fill_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Weak stock K ranges",
       y = "Strong stock K ranges",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```


```{r, echo = FALSE}
ss_k_pos + ws_k_pos +
  plot_annotation(title = "Simulation of K ranges on B/K ratio - Negative values filtered out")
```


### Price ratio vs Vulnerability test

```{r, echo = FALSE}
# vul_full <- 
#   output_test %>% 
#   filter(variables %in% c("N_w", "N_s")) %>% 
#   mutate(prod_ratio = (q_s/r_s) / (q_w/r_w)) %>% 
#   ggplot() +
#   geom_point(aes(x = price_ratio, y = prod_ratio, color = values)) +
#   scale_color_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(5, "YlOrRd")) +
#   labs(x = "Price ratio (p_s/p_w)",
#        y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
#        title = "All values") +
#   theme_bw()
```

```{r, echo = FALSE}
# vul_pos <- 
#   output_test %>% 
#   filter(variables %in% c("N_w", "N_s") & values >= 0) %>% 
#   mutate(prod_ratio = (q_s/r_s) / (q_w/r_w)) %>% 
#   ggplot() +
#   geom_point(aes(x = price_ratio, y = prod_ratio, color = values)) +
#   scale_color_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(5, "YlOrRd")) +
#   labs(x = "Price ratio (p_s/p_w)",
#        y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
#        title = "Only positive values") +
#   theme_bw()
```

```{r, echo = FALSE}
# vul_neg <- 
#   output_test %>% 
#   filter(variables %in% c("N_w", "N_s") & values <= 0) %>% 
#   mutate(prod_ratio = (q_s/r_s) / (q_w/r_w)) %>% 
#   ggplot() +
#   geom_point(aes(x = price_ratio, y = prod_ratio, color = values)) +
#   scale_color_gradientn(name = "stock size", colors = RColorBrewer::brewer.pal(5, "YlOrRd"),
#                         breaks = seq(-60, 0, 10)) +
#   labs(x = "Price ratio (p_s/p_w)",
#        y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
#        title = "Only negative values") +
#   theme_bw()
```


```{r, fig.height = 10, fig.width=9, echo = FALSE}
# (vul_neg + vul_pos) /
#   vul_full +
#   plot_annotation(title = "Simulation of the distribution of vulnerability and price ratios")
```

```{r, echo = FALSE}
vul_s <- 
  output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s") %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = vuln_ratio, color = b_v_k)) +
  scale_color_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Price ratio (p_s/p_w)",
       y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
       title = "Strong stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
vul_w <- 
  output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w") %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = vuln_ratio, color = b_v_k)) +
  scale_color_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0)) +
  labs(x = "Price ratio (p_s/p_w)",
       y = "Vulnerability ratio (q_s/r_s)/(q_w/r_w)",
       title = "Weak stock",
       fill = "B/K") +
  theme_bw()
```

```{r, echo = FALSE, fig.height=9, fig.width=8}
vul_s + vul_w +
  plot_annotation(title = "Price vs vulnerability ratios for strong and weak stocks - All B/K values")
```

```{r, echo = FALSE}
vul_pos_s <- 
  output_test_updated %>% 
  filter(variables == "N_s" & b_stocks == "b_values_s" & b_v_k >= 0) %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = vuln_ratio, color = b_v_k)) +
  scale_color_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Price ratio",
       y = "Vulnerability ratio",
       title = "Strong stock",
       color = "B/K") +
  theme_bw()
```

```{r, echo = FALSE}
vul_pos_w <- 
  output_test_updated %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k >= 0) %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = vuln_ratio, color = b_v_k)) +
  scale_color_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Price ratio",
       y = "Vulnerability ratio",
       title = "Weak stock",
       color = "B/K") +
  theme_bw()
```

```{r, echo = FALSE, fig.width=9, fig.height=6}
vul_pos_s + vul_pos_w +
  plot_annotation(title = "Price vs vulnerability ratios for strong and weak stocks - Positive B/K values",
                  caption = "Price ratio = p_s / p_w \n Vulnerability ratio = (q_s/r_s) / (q_w/r_w)")
```

- When transforming the negative values of B/K into zeros, we get the following plot:

```{r, echo = FALSE}
output_test_updated %>% 
  mutate(b_v_k = case_when(
    b_v_k < 0 ~ 0,
    TRUE ~ b_v_k
  )) %>% 
  filter(variables == "N_w" & b_stocks == "b_values_w" & b_v_k >= 0) %>% 
  ggplot() +
  geom_point(aes(x = price_ratio, y = vuln_ratio, color = b_v_k)) +
  scale_color_distiller(palette = "RdYlBu",
                       rescaler = ~ scales::rescale_mid(.x, mid = 0.5)) +
  labs(x = "Price ratio",
       y = "Vulnerability ratio",
       title = "Weak stock",
       color = "B/K") +
  theme_bw()
```



```{r, echo = FALSE}
q_neg <- 
  output_test_updated %>% 
  filter(values < 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = values)) +
  facet_wrap(~ variables) +
#  scale_fill_continuous(breaks = seq(-10, 0, 2)) +
  labs(title = "Negative values") +
  theme_bw()
```

```{r, echo = FALSE}
q_pos <-
  output_test_updated %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = q_w, y = q_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_fill_continuous(breaks = seq(0, 25, 5)) +
  labs(title = "Positive values") +
  theme_bw()
```


```{r, fig.width=9, echo = FALSE}
# (q_neg + q_pos) +
#   plot_annotation(title = "Catchability ranges")
```



```{r, echo = FALSE}
r_neg <- 
  output_test_updated %>% 
  filter(values <= 0) %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = values)) +
  facet_wrap(~ variables) +
  labs(title = "Negative values for r scenarios") +
  theme_bw()
```

```{r, echo = FALSE}
r_pos <- 
  output_test_updated %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = r_w, y = r_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_fill_continuous(breaks = seq(0, 25, 5)) +
  labs(title = "Positive values for r scenarios") +
  theme_bw()
```

```{r, fig.width=8, echo = FALSE}
# r_neg + r_pos +
#   plot_annotation(title = "Range of values for r scenarios")
```


```{r, echo = FALSE}
k_neg <-
  output_test_updated %>% 
  filter(values <= 0) %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = values)) +
  facet_wrap(~ variables) +
  labs(title = "Negative values for K ranges") +
  theme_bw()
```

```{r, echo = FALSE}
k_pos <-
  output_test_updated %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = k_w, y = k_s, fill = values)) +
  facet_wrap(~ variables) + 
  scale_fill_continuous(breaks = seq(0, 25, 5)) +
  labs(title = "Positive values for K ranges") +
  theme_bw()
```

```{r, fig.width=8, echo = FALSE}
# k_neg + k_pos +
#   plot_annotation(title = "Range of values for K scenarios")
```



```{r, echo = FALSE}
price_neg <-
  output_test_updated %>% 
  filter(values <= 0) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_x_continuous(breaks = seq(0, 10, 2)) +
  labs(title = "Negative values for the range of prices") +
  theme_bw()
```

```{r, echo = FALSE}
pos_price <- 
  output_test_updated %>% 
  filter(values >= 0) %>% 
  ggplot() +
  geom_raster(aes(x = p_w, y = p_s, fill = values)) +
  facet_wrap(~ variables) +
  scale_fill_continuous(breaks = seq(0, 25, 5)) +
  labs(title = "Positive values for the range of prices") +
  theme_bw()
```

```{r, fig.width=8, echo = FALSE}
# price_neg + pos_price +
#   plot_annotation(title = "Values for the range of prices")
```


## Setting up the time series simulation

$$
\begin{align}
\frac{d N_s}{dt} &= N_S  (r_s  (\frac{1 - N_S}{K_s}) - q_s e_t) \\
\newline
\frac{d N_w}{dt} &= N_W  (r_w  (\frac{1 - N_W}{K_w}) - q_w e_t) \\
\newline
\frac{d E}{dt} &= \alpha  e_t  (p_s  q_s  N_S + p_w q_w N_W - c)
\end{align}
$$

```{r}
# set up the parameter space
q_s <- 0.1
q_w <- 0.15
k_s <- 1
k_w <- 1
r_s <- 1
r_w <- 1
p_s <- 1
p_w <- 1
alpha <- 1 # constant controlling for the speed at which effort changes with a changing price
c <- 0.05

# Initial values for the variables
N_w <- 1

N_s <- 1

E <- 0.01
```

```{r}
tset <- seq(from = 0, to = 100, length.out = 1000)

N_w_simu <- NaN*tset
N_w_simu[1] <- k_w

N_s_simu <- NaN*tset
N_s_simu[1] <- k_s

E_simu <- NaN*tset
E_simu[1] <- E
```

```{r}
for(i in 2:length(tset)) {
  
  # change in time
  dt <- tset[i] - tset[i-1]
  
  # placeholder variables to plug into the equations
  N_w <- N_w_simu[i-1]
  N_s <- N_s_simu[i-1]
  E <- E_simu[i-1]
  
  # Calculate change in variable size at each time step
  dN_s <- (N_s * (r_s * (1 - N_s/k_s) - q_s * E)) * dt
  dN_w <- (N_w * (r_w * (1 - N_w/k_w) - q_w * E)) * dt
  dE <- (alpha * E * (p_s * q_s * N_s + p_w * q_w * N_w - c)) * dt
  
  # calculate total variable size and store in holding vectors
  
  N_w_simu[i] <- N_w + dN_w
  N_s_simu[i] <- N_s + dN_s
  E_simu[i] <- E + dE
}
```


```{r}
# Plot time series results
plot(x = tset, y = N_s_simu,
     type = "l",
     col = "darkblue",
     las = 1,
     lwd = 2,
     ylim = c(0, 8),
     xlab = "Time", ylab = "Variable size")
lines(x = tset, y = N_w_simu,
      type = "l", col = "darkorange")
lines(x = tset, y = E_simu,
      type = "l", col = "darkgreen")
legend(x = 80, y = 5,
       lwd = 2,
       legend = c("Ns", "Nw", "Effort"),
       col = c("darkblue", "darkorange", "darkgreen"))
```























